{% extends 'scripts_manager/base.html' %}

{% block title %}Restaurer un Backup - Butter{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h1 class="card-title text-3xl font-serif text-base-content">Restaurer un Backup</h1>
            <p class="text-secondary">Selectionnez un backup pour restaurer l'etat precedent de vos restaurants.</p>
            <p class="text-sm text-secondary mt-2">
                Les backups sont crees automatiquement lors des imports dans: <code class="bg-base-200 px-1.5 py-0.5 rounded text-xs">media/exports/backups/</code>
            </p>
        </div>
    </div>

    <!-- Warning -->
    <div class="alert alert-warning">
        <div>
            <strong>Attention :</strong>
            <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                <li>La restauration va <strong>remplacer</strong> tous les restaurants actuels</li>
                <li>Un backup de securite sera cree automatiquement avant la restauration</li>
                <li>Cette operation est irreversible (sauf si vous restaurez a nouveau un autre backup)</li>
            </ul>
        </div>
    </div>

    <!-- Refresh button -->
    <div class="text-right">
        <button type="button" class="btn btn-ghost" id="refreshBackupsBtn">
            Actualiser la liste
        </button>
    </div>

    <!-- Backups container -->
    <div id="backupsContainer">
        <!-- Loading -->
        <div id="backupsLoading" class="text-center py-10 text-secondary hidden">
            <span class="loading loading-spinner loading-lg"></span>
            <p class="mt-2">Chargement des backups...</p>
        </div>

        <!-- Select container -->
        <div id="backupsSelectContainer" class="hidden">
            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <div class="form-control">
                        <label for="backupSelect" class="label">
                            <span class="label-text font-semibold text-base-content">Selectionner un backup a restaurer :</span>
                        </label>
                        <select id="backupSelect" class="select select-bordered w-full bg-base-200 text-base-content">
                            <option value="">-- Selectionner un backup --</option>
                        </select>
                    </div>

                    <div id="backupInfo" class="mt-4 p-4 bg-base-200 rounded-lg hidden">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <span class="text-xs text-secondary block mb-1">Date/Heure</span>
                                <span id="backupDate" class="font-semibold text-base-content"></span>
                            </div>
                            <div>
                                <span class="text-xs text-secondary block mb-1">Restaurants</span>
                                <span id="backupCount" class="font-semibold text-base-content"></span>
                            </div>
                            <div>
                                <span class="text-xs text-secondary block mb-1">Taille</span>
                                <span id="backupSize" class="font-semibold text-base-content"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary btn-lg hidden" id="restoreBtn">
                    Restaurer ce backup
                </button>
            </div>
        </div>

        <!-- Empty state -->
        <div id="backupsEmpty" class="card bg-base-200 hidden">
            <div class="card-body items-center text-center py-16">
                <div class="text-6xl mb-4">üì¶</div>
                <h3 class="text-lg font-semibold text-secondary">Aucun backup disponible</h3>
                <p class="text-secondary text-sm mt-2">Les backups sont crees automatiquement lors des imports de restaurants.</p>
            </div>
        </div>
    </div>

    <!-- Result -->
    <div id="restoreResult" class="hidden"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const refreshBackupsBtn = document.getElementById('refreshBackupsBtn');
    const backupsLoading = document.getElementById('backupsLoading');
    const backupsSelectContainer = document.getElementById('backupsSelectContainer');
    const backupSelect = document.getElementById('backupSelect');
    const backupInfo = document.getElementById('backupInfo');
    const backupDate = document.getElementById('backupDate');
    const backupCount = document.getElementById('backupCount');
    const backupSize = document.getElementById('backupSize');
    const restoreBtn = document.getElementById('restoreBtn');
    const backupsEmpty = document.getElementById('backupsEmpty');
    const restoreResult = document.getElementById('restoreResult');

    let backupsData = [];

    function formatFileSize(bytes) {
        if (!bytes || bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'Date inconnue';
        try {
            // Essayer de parser differents formats
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                // Si ce n'est pas une date valide, essayer de parser le format YYYYMMDD_HHMMSS
                const match = timestamp.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
                if (match) {
                    const [, year, month, day, hour, minute, second] = match;
                    return `${day}/${month}/${year} a ${hour}:${minute}:${second}`;
                }
                return timestamp;
            }
            return date.toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (e) {
            return timestamp;
        }
    }

    function loadBackups() {
        backupsLoading.classList.remove('hidden');
        backupsSelectContainer.classList.add('hidden');
        backupsEmpty.classList.add('hidden');
        restoreResult.classList.add('hidden');
        backupSelect.innerHTML = '<option value="">-- Selectionner un backup --</option>';
        backupInfo.classList.add('hidden');
        restoreBtn.classList.add('hidden');

        fetch('{% url "scripts_manager:list_backups" %}')
            .then(response => response.json())
            .then(data => {
                backupsLoading.classList.add('hidden');

                if (data.success && data.backups && data.backups.length > 0) {
                    backupsData = data.backups;

                    // Trier par date (plus recent en premier)
                    backupsData.sort((a, b) => {
                        const dateA = a.timestamp || a.backup_name || '';
                        const dateB = b.timestamp || b.backup_name || '';
                        return dateB.localeCompare(dateA);
                    });

                    // Remplir le select
                    backupsData.forEach((backup, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `${formatDate(backup.timestamp)} - ${backup.count || 0} restaurants`;
                        backupSelect.appendChild(option);
                    });

                    backupsSelectContainer.classList.remove('hidden');
                } else {
                    backupsEmpty.classList.remove('hidden');
                }
            })
            .catch(error => {
                backupsLoading.classList.add('hidden');
                backupsEmpty.classList.remove('hidden');
                backupsEmpty.innerHTML = `
                    <div class="card-body items-center text-center py-16">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-lg font-semibold text-error">Erreur lors du chargement</h3>
                        <p class="text-secondary text-sm mt-2">${error.message}</p>
                    </div>
                `;
            });
    }

    // Gerer la selection dans le select
    backupSelect.addEventListener('change', function() {
        const selectedIndex = this.value;
        if (selectedIndex === '' || !backupsData[selectedIndex]) {
            backupInfo.classList.add('hidden');
            restoreBtn.classList.add('hidden');
            return;
        }

        const backup = backupsData[selectedIndex];
        backupDate.textContent = formatDate(backup.timestamp);
        backupCount.textContent = backup.count || 'N/A';
        backupSize.textContent = formatFileSize(backup.size || 0);
        backupInfo.classList.remove('hidden');
        restoreBtn.classList.remove('hidden');
        restoreBtn.onclick = () => restoreBackup(backup.backup_dir, backup.backup_name);
    });

    function restoreBackup(backupDir, backupName) {
        if (!confirm(`ATTENTION : Cette operation va remplacer TOUS les restaurants actuels par ceux du backup "${backupName}".\n\nUn backup de securite sera cree avant la restauration.\n\nVoulez-vous vraiment continuer ?`)) {
            return;
        }

        restoreResult.classList.remove('hidden');
        restoreResult.className = 'alert mt-5';
        restoreResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Restauration en cours... Cette operation peut prendre plusieurs minutes.';

        fetch('{% url "scripts_manager:restore_backup" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                backup_dir: backupDir,
                create_backup_before: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                restoreResult.className = 'alert alert-success mt-5';
                restoreResult.innerHTML = `
                    <div>
                        <h3 class="font-bold">Restauration reussie !</h3>
                        <p><strong>${data.imported}</strong> restaurants restaures</p>
                        <p><strong>Backup restaure :</strong> ${data.backup_dir}</p>
                        ${data.backup_before_dir ? `<p><strong>Backup de securite cree :</strong> ${data.backup_before_dir}</p>` : ''}
                        <p class="mt-4">
                            <a href="{% url 'scripts_manager:restaurants_list' %}" class="btn btn-primary btn-sm">Voir les restaurants</a>
                        </p>
                    </div>
                `;

                // Recharger la liste des backups apres quelques secondes
                setTimeout(() => {
                    loadBackups();
                }, 2000);
            } else {
                restoreResult.className = 'alert alert-error mt-5';
                restoreResult.innerHTML = `
                    <div>
                        <h3 class="font-bold">Erreur lors de la restauration</h3>
                        <p>${data.error || 'Une erreur est survenue lors de la restauration'}</p>
                        ${data.traceback ? `<pre class="bg-base-100 p-3 rounded text-xs overflow-x-auto mt-2">${data.traceback}</pre>` : ''}
                    </div>
                `;
            }
        })
        .catch(error => {
            restoreResult.className = 'alert alert-error mt-5';
            restoreResult.innerHTML = `
                <div>
                    <h3 class="font-bold">Erreur</h3>
                    <p>Une erreur est survenue : ${error.message}</p>
                </div>
            `;
        });
    }

    refreshBackupsBtn.addEventListener('click', loadBackups);

    // Charger les backups au chargement de la page
    loadBackups();
});
</script>
{% endblock %}
