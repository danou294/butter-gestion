{% extends 'scripts_manager/base.html' %}

{% block title %}{% if action == 'create' %}Nouveau Restaurant{% else %}Modifier Restaurant{% endif %} - Butter{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body flex-row flex-wrap items-center justify-between gap-4">
            <h1 class="text-3xl font-serif font-bold text-base-content">
                {% if action == 'create' %}‚ûï Nouveau Restaurant{% else %}‚úèÔ∏è Modifier Restaurant{% endif %}
            </h1>
            <a href="{% url 'scripts_manager:restaurants_list' %}" class="btn btn-ghost">‚Üê Retour</a>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-error">
        <span>‚ùå Erreur : {{ error }}</span>
    </div>
    {% endif %}

    <!-- Form -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <form method="POST" class="space-y-4">
                {% csrf_token %}

                <div class="form-control">
                    <label class="label"><span class="label-text">Nom *</span></label>
                    <input type="text" id="name" name="name" value="{{ restaurant.name|default:'' }}" required
                           class="input input-bordered w-full bg-base-200">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Adresse</span></label>
                    <input type="text" id="address" name="address" value="{{ restaurant.address|default:'' }}"
                           class="input input-bordered w-full bg-base-200">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Ville</span></label>
                        <input type="text" id="ville" name="ville" value="{{ restaurant.ville|default:'' }}"
                               class="input input-bordered w-full bg-base-200">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Code Postal</span></label>
                        <input type="text" id="codePostal" name="codePostal" value="{{ restaurant.codePostal|default:'' }}"
                               class="input input-bordered w-full bg-base-200">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">Telephone</span></label>
                        <input type="text" id="telephone" name="telephone" value="{{ restaurant.telephone|default:'' }}"
                               class="input input-bordered w-full bg-base-200">
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">Email</span></label>
                        <input type="email" id="email" name="email" value="{{ restaurant.email|default:'' }}"
                               class="input input-bordered w-full bg-base-200">
                    </div>
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Site Web</span></label>
                    <input type="url" id="siteWeb" name="siteWeb" value="{{ restaurant.siteWeb|default:'' }}"
                           class="input input-bordered w-full bg-base-200">
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text">Description</span></label>
                    <textarea id="description" name="description" rows="4"
                              class="textarea textarea-bordered w-full bg-base-200">{{ restaurant.description|default:'' }}</textarea>
                </div>

                <!-- Champs personnalises -->
                <div class="bg-base-200 rounded-box p-4 border border-base-300">
                    <h3 class="text-lg font-serif font-bold text-base-content mb-2">Champs personnalis√©s</h3>
                    <p class="text-sm text-secondary mb-4">
                        Ajoutez des champs suppl√©mentaires. Format : <code class="bg-base-100 px-2 py-1 rounded">nom_champ: valeur</code>
                    </p>
                    <div id="custom-fields" class="space-y-3">
                        <button type="button" onclick="addCustomField()" class="btn btn-ghost btn-sm">
                            ‚ûï Ajouter un champ
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col md:flex-row gap-3 pt-4">
                    <button type="submit" class="btn btn-primary flex-1">
                        üíæ {% if action == 'create' %}Cr√©er{% else %}Enregistrer{% endif %}
                    </button>
                    <a href="{% url 'scripts_manager:restaurants_list' %}" class="btn btn-ghost flex-1 text-center">Annuler</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let customFieldIndex = 0;

function addCustomField() {
    const container = document.getElementById('custom-fields');
    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'flex gap-3 items-center';
    fieldDiv.innerHTML = `
        <input type="text" name="custom_field_name_${customFieldIndex}" placeholder="Nom du champ"
               class="input input-bordered flex-1 bg-base-100" required>
        <input type="text" name="custom_field_value_${customFieldIndex}" placeholder="Valeur"
               class="input input-bordered flex-[2] bg-base-100">
        <button type="button" onclick="this.parentElement.remove()" class="btn btn-error btn-sm">üóëÔ∏è</button>
    `;
    container.appendChild(fieldDiv);
    customFieldIndex++;
}

{% if restaurant %}
{% for key, value in restaurant.items %}
{% if key != 'id' and key != 'name' and key != 'Name' and key != 'nom' and key != 'address' and key != 'adresse' and key != 'ville' and key != 'codePostal' and key != 'telephone' and key != 'email' and key != 'siteWeb' and key != 'description' %}
addCustomField();
const fields = document.querySelectorAll('#custom-fields input');
if (fields.length >= 2) {
    fields[fields.length - 2].value = '{{ key }}';
    fields[fields.length - 1].value = '{{ value|stringformat:"s" }}';
}
{% endif %}
{% endfor %}
{% endif %}
</script>
{% endblock %}
