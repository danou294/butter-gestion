{% extends 'scripts_manager/base.html' %}

{% block title %}Photos - Butter{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-serif font-bold text-[#111111] mb-2">ğŸ“¸ Gestion des Photos</h1>
                <p class="text-[#535353]">GÃ©rez les logos et photos des restaurants</p>
            </div>
            <button onclick="showUploadModal()" class="btn-primary">
                â• Upload Photo
            </button>
        </div>
    </div>
    
    <!-- Onglets pour choisir le dossier -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
        <div class="flex flex-wrap gap-3">
            <a href="?folder=logos{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"
               class="px-4 py-2 rounded-[14px] text-sm font-medium transition-colors {% if folder == 'logos' %}bg-[#C9C1B1] text-[#111111]{% else %}bg-[#F1EFEB] text-[#535353] hover:bg-[#C9C1B1] hover:text-[#111111]{% endif %} trigger-loading">
                ğŸ–¼ï¸ Logos
            </a>
            <a href="?folder=photos{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"
               class="px-4 py-2 rounded-[14px] text-sm font-medium transition-colors {% if folder == 'photos' %}bg-[#C9C1B1] text-[#111111]{% else %}bg-[#F1EFEB] text-[#535353] hover:bg-[#C9C1B1] hover:text-[#111111]{% endif %} trigger-loading">
                ğŸ“¸ Photos restaurants
            </a>
        </div>
    </div>
    
    <!-- Formulaire de recherche -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <form method="GET" action="{% url 'scripts_manager:photos_list' %}" class="auto-loader">
            <input type="hidden" name="folder" value="{{ folder }}">
            <div class="flex flex-col md:flex-row gap-3">
                <input 
                    type="text" 
                    name="search" 
                    placeholder="Rechercher par nom de photo..." 
                    value="{{ search_query }}"
                    class="flex-1 px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]"
                >
                <button type="submit" class="btn-primary">ğŸ” Rechercher</button>
                {% if search_query %}
                <a href="?folder={{ folder }}" class="btn-secondary">âŒ Effacer</a>
                {% endif %}
            </div>
        </form>
    </div>
    
    <!-- Actions Photos restaurants : conversion + export sans photo WebP -->
    {% if folder == 'photos' %}
    <div class="bg-[#60BC81] rounded-[14px] shadow-sm p-6 border border-[#60BC81]">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="text-white">
                <h3 class="text-lg font-serif font-bold mb-2">âš¡ Optimisation des Photos</h3>
                <p class="text-sm opacity-90">Convertit et optimise toutes les images PNG en WebP (compression automatique, redimensionnement max 1920x1920px)</p>
            </div>
            <button 
                id="convertBtn" 
                onclick="convertPngToWebp()" 
                class="bg-[#FFFFFF] text-[#60BC81] font-semibold px-6 py-3 rounded-[14px] hover:bg-[#F1EFEB] transition-colors whitespace-nowrap"
            >
                ğŸ”„ Convertir PNG â†’ WebP
            </button>
        </div>
        <div id="convertStatus" class="mt-4 hidden"></div>
    </div>
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="text-[#111111]">
                <h3 class="text-lg font-serif font-bold mb-2">ğŸ“‹ Restaurants sans photo WebP</h3>
                <p class="text-sm text-[#535353]">Compare Firestore (env. actif) et le bucket PROD : tÃ©lÃ©charge un Excel des restaurants sans aucune photo .webp</p>
            </div>
            <a 
                href="{% url 'scripts_manager:photo_export_restaurants_without_webp' %}" 
                class="btn-primary inline-flex items-center justify-center whitespace-nowrap"
            >
                â¬‡ï¸ Export Excel (sans photo WebP)
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Messages d'info -->
    {% if search_query %}
    <div class="bg-[#F1EFEB] border border-[#C9C1B1] rounded-[14px] p-4 text-[#535353]">
        ğŸ” Recherche : "{{ search_query }}" - {{ results_count }} rÃ©sultat{{ results_count|pluralize }} trouvÃ©{{ results_count|pluralize }}
    </div>
    {% endif %}
    
    <div class="text-sm text-[#535353]">
        RÃ©sultats : {{ results_count }} photo{{ results_count|pluralize }}
    </div>
    
    {% if error %}
    <div class="bg-[#F2D7D4] border border-[#D3695E] rounded-[14px] p-4 text-[#D3695E]">
        âŒ Erreur : {{ error }}
    </div>
    {% endif %}
    
    <!-- Barre d'actions groupÃ©es -->
    <div id="bulkActionsBar" class="hidden bg-[#60BC81] text-white rounded-[14px] p-4 mb-6 sticky top-0 z-50 shadow-lg">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="font-semibold">
                <strong id="selectedCount">0</strong> photo(s) sÃ©lectionnÃ©e(s)
            </div>
            <div class="flex gap-3 flex-wrap">
                <button onclick="bulkDeletePhotos()" class="btn-danger">
                    ğŸ—‘ï¸ Supprimer sÃ©lection
                </button>
                <button onclick="clearSelection()" class="bg-[#FFFFFF] text-[#60BC81] px-4 py-2 rounded-[14px] font-medium hover:bg-[#F1EFEB] transition-colors">
                    âŒ Annuler
                </button>
            </div>
        </div>
    </div>
    
    {% if photos %}
    <!-- Liste des photos -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm border border-[#C9C1B1] overflow-hidden">
        <div class="p-4 border-b border-[#C9C1B1]">
            <label class="flex items-center gap-2 cursor-pointer select-none">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)" class="w-5 h-5 cursor-pointer">
                <strong class="text-[#111111]">SÃ©lectionner tout</strong>
            </label>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-[#C9C1B1]">
                <thead class="bg-[#F1EFEB]">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider w-12">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll(this.checked)" class="w-5 h-5 cursor-pointer">
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Nom</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Taille</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-[#FFFFFF] divide-y divide-[#C9C1B1]">
                    {% for photo in photos %}
                    <tr data-photo-name="{{ photo.name }}" class="hover:bg-[#F1EFEB] transition-colors">
                        <td class="px-6 py-4 text-center">
                            <input 
                                type="checkbox" 
                                class="photo-checkbox w-5 h-5 cursor-pointer" 
                                value="{{ photo.name }}" 
                                onchange="updateBulkActionsBar()"
                            >
                        </td>
                        <td class="px-6 py-4">
                            <code class="bg-[#F1EFEB] px-3 py-1 rounded-[14px] text-sm text-[#535353] break-all">
                                {{ photo.name }}
                            </code>
                        </td>
                        <td class="px-6 py-4 text-sm text-[#535353]">
                            ğŸ“¦ {{ photo.size|filesizeformat }}
                        </td>
                        <td class="px-6 py-4 text-sm text-[#535353]">
                            ğŸ“… {{ photo.time_created|date:"d/m/Y H:i"|default:"â€”" }}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="downloadPhoto('{{ folder }}', '{{ photo.name }}')" class="btn-primary text-sm">
                                    â¬‡ï¸ TÃ©lÃ©charger
                                </button>
                                <button onclick="viewPhoto('{{ folder }}', '{{ photo.name }}')" class="btn-secondary text-sm">
                                    ğŸ‘ï¸ Voir
                                </button>
                                <button onclick="renamePhoto('{{ folder }}', '{{ photo.name }}')" class="btn-secondary text-sm">
                                    âœï¸ Renommer
                                </button>
                                <button onclick="deletePhoto('{{ folder }}', '{{ photo.name }}')" class="btn-danger text-sm">
                                    ğŸ—‘ï¸ Supprimer
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex items-center justify-between bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
        <div class="text-sm text-[#535353]">
            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
        </div>
        <div class="flex gap-2">
            {% if page_obj.has_previous %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="btn-secondary trigger-loading">
                â† PrÃ©cÃ©dent
            </a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="btn-secondary trigger-loading">
                Suivant â†’
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="bg-[#F1EFEB] border border-[#C9C1B1] rounded-[14px] p-6 text-center text-[#535353]">
        ğŸ“­ Aucune photo dans ce dossier.
    </div>
    {% endif %}
</div>

<!-- Modal Upload -->
<div id="uploadModal" class="hidden fixed inset-0 bg-[#111111]/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-xl p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <h3 class="text-2xl font-serif font-bold text-[#111111] mb-4">ğŸ“¤ Upload Photo</h3>
        <form id="uploadForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-4">
                <label for="uploadFolder" class="block text-sm font-medium text-[#111111] mb-2">
                    ğŸ“ Dossier de destination :
                </label>
                <select id="uploadFolder" name="folder" required 
                        class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                    <option value="logos" {% if folder == 'logos' %}selected{% endif %}>ğŸ–¼ï¸ Logos</option>
                    <option value="photos" {% if folder == 'photos' %}selected{% endif %}>ğŸ“¸ Photos restaurants</option>
                </select>
            </div>
            
            <div id="uploadArea" onclick="document.getElementById('photo_file').click()" 
                 class="border-2 border-dashed border-[#C9C1B1] rounded-[14px] p-8 text-center cursor-pointer transition-colors hover:border-[#60BC81] hover:bg-[#F1EFEB]">
                <div class="text-5xl mb-4">ğŸ“„</div>
                <h4 class="text-lg font-medium text-[#111111] mb-2">Glissez-dÃ©posez vos photos ici</h4>
                <p class="text-[#535353] mb-4">ou</p>
                <button type="button" class="btn-secondary">Parcourir les fichiers</button>
                <p class="text-sm text-[#535353] mt-2">Vous pouvez sÃ©lectionner plusieurs photos Ã  la fois</p>
                <input type="file" id="photo_file" name="photo_file" accept="image/*" multiple required class="hidden">
            </div>
            
            <div id="filesList" class="mt-4 hidden">
                <div class="bg-[#F1EFEB] rounded-[14px] p-4">
                    <strong class="text-[#111111] block mb-2">Fichiers sÃ©lectionnÃ©s (<span id="filesCount">0</span>) :</strong>
                    <div id="filesInfo" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            
            
            <div class="mt-6 flex gap-3">
                <button type="submit" class="btn-primary flex-1">ğŸ“¤ Upload</button>
                <button type="button" onclick="hideUploadModal()" class="btn-secondary flex-1">Annuler</button>
            </div>
        </form>
    </div>
</div>

<script>
function showUploadModal() {
    document.getElementById('uploadModal').classList.remove('hidden');
}

function hideUploadModal() {
    document.getElementById('uploadModal').classList.add('hidden');
    document.getElementById('uploadForm').reset();
    document.getElementById('filesList').classList.add('hidden');
    document.getElementById('filesInfo').innerHTML = '';
}

// Drag & drop
const uploadArea = document.getElementById('uploadArea');
const photoFile = document.getElementById('photo_file');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('border-[#60BC81]', 'bg-[#D4F2DA]');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('border-[#60BC81]', 'bg-[#D4F2DA]');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('border-[#60BC81]', 'bg-[#D4F2DA]');
    if (e.dataTransfer.files.length > 0) {
        // CrÃ©er un DataTransfer pour assigner plusieurs fichiers
        const dt = new DataTransfer();
        for (let file of e.dataTransfer.files) {
            dt.items.add(file);
        }
        photoFile.files = dt.files;
        handleFilesSelect(Array.from(e.dataTransfer.files));
    }
});

photoFile.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFilesSelect(Array.from(e.target.files));
    }
});

function handleFilesSelect(files) {
    const filesList = document.getElementById('filesList');
    const filesInfo = document.getElementById('filesInfo');
    const filesCount = document.getElementById('filesCount');
    
    filesList.classList.remove('hidden');
    filesInfo.innerHTML = '';
    filesCount.textContent = files.length;
    
    let totalSize = 0;
    files.forEach((file, index) => {
        totalSize += file.size;
        const fileDiv = document.createElement('div');
        fileDiv.className = 'flex items-center justify-between p-2 bg-white rounded-[8px] text-sm';
        fileDiv.innerHTML = `
            <div class="flex-1">
                <span class="text-[#111111] font-medium">${file.name}</span>
                <span class="text-[#535353] ml-2">(${formatFileSize(file.size)})</span>
            </div>
        `;
        filesInfo.appendChild(fileDiv);
    });
    
    // Afficher la taille totale
    const totalDiv = document.createElement('div');
    totalDiv.className = 'mt-2 pt-2 border-t border-[#C9C1B1] text-sm font-semibold text-[#111111]';
    totalDiv.textContent = `Taille totale: ${formatFileSize(totalSize)}`;
    filesInfo.appendChild(totalDiv);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Upload form
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const photoFileInput = document.getElementById('photo_file');
    const files = photoFileInput.files;
    
    if (files.length === 0) {
        alert('âš ï¸ Veuillez sÃ©lectionner au moins un fichier');
        return;
    }
    
    const folder = document.getElementById('uploadFolder').value;
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;
    
    // DÃ©sactiver le bouton et afficher la progression
    submitButton.disabled = true;
    submitButton.textContent = 'â³ Upload en cours...';
    
    let uploaded = 0;
    let errors = 0;
    const total = files.length;
    const errorMessages = [];
    
    // Uploader chaque fichier sÃ©quentiellement
    const uploadPromises = Array.from(files).map((file, index) => {
        const formData = new FormData();
        formData.append('photo_file', file);
        formData.append('folder', folder);
        // Utiliser le nom original du fichier
        
        return fetch('{% url "scripts_manager:photo_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploaded++;
                submitButton.textContent = `â³ Upload: ${uploaded}/${total}...`;
            } else {
                errors++;
                errorMessages.push(`${file.name}: ${data.error || 'Erreur inconnue'}`);
            }
        })
        .catch(error => {
            errors++;
            errorMessages.push(`${file.name}: ${error.message}`);
        });
    });
    
    // Attendre que tous les uploads soient terminÃ©s
    Promise.all(uploadPromises).then(() => {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        
        if (uploaded === total) {
            alert(`âœ… ${uploaded} photo(s) uploadÃ©e(s) avec succÃ¨s !`);
            location.reload();
        } else if (uploaded > 0) {
            let message = `âš ï¸ ${uploaded} photo(s) uploadÃ©e(s), ${errors} erreur(s)\n\n`;
            if (errorMessages.length > 0) {
                message += 'Erreurs:\n' + errorMessages.slice(0, 5).join('\n');
                if (errorMessages.length > 5) {
                    message += `\n... et ${errorMessages.length - 5} autre(s) erreur(s)`;
                }
            }
            alert(message);
            location.reload();
        } else {
            alert('âŒ Aucune photo n\'a pu Ãªtre uploadÃ©e.\n\n' + errorMessages.join('\n'));
        }
    });
});

// Fonction pour obtenir l'URL signÃ©e d'une photo
function getPhotoUrl(folder, photoName) {
    return new Promise((resolve, reject) => {
        const url = `{% url "scripts_manager:photo_get_url" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    resolve(data.url);
                } else {
                    reject(new Error(data.error || 'Erreur lors de la gÃ©nÃ©ration de l\'URL'));
                }
            })
            .catch(error => {
                reject(error);
            });
    });
}

function downloadPhoto(folder, photoName) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'â³ Chargement...';
    button.disabled = true;
    
    getPhotoUrl(folder, photoName)
        .then(url => {
            const a = document.createElement('a');
            a.href = url;
            a.download = photoName;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            button.textContent = originalText;
            button.disabled = false;
        })
        .catch(error => {
            alert('âŒ Erreur lors du tÃ©lÃ©chargement: ' + error.message);
            button.textContent = originalText;
            button.disabled = false;
        });
}

function viewPhoto(folder, photoName) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'â³ Chargement...';
    button.disabled = true;
    
    getPhotoUrl(folder, photoName)
        .then(url => {
            window.open(url, '_blank');
            button.textContent = originalText;
            button.disabled = false;
        })
        .catch(error => {
            alert('âŒ Erreur lors de l\'ouverture: ' + error.message);
            button.textContent = originalText;
            button.disabled = false;
        });
}

function renamePhoto(folder, photoName) {
    const newName = prompt('Nouveau nom pour la photo:', photoName);
    if (newName && newName !== photoName) {
        const formData = new FormData();
        formData.append('new_name', newName);
        
        const renameUrl = `{% url "scripts_manager:photo_rename" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
        fetch(renameUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('âœ… ' + data.message);
                location.reload();
            } else {
                alert('âŒ ' + data.error);
            }
        })
        .catch(error => {
            alert('âŒ Erreur: ' + error.message);
        });
    }
}

function deletePhoto(folder, photoName) {
    if (!confirm(`ÃŠtes-vous sÃ»r de vouloir supprimer la photo "${photoName}" ?\n\nCette action est irrÃ©versible !`)) {
        return;
    }
    
    const deleteUrl = `{% url "scripts_manager:photo_delete" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
    fetch(deleteUrl, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('âœ… ' + data.message);
            location.reload();
        } else {
            alert('âŒ ' + data.error);
        }
    })
    .catch(error => {
        alert('âŒ Erreur: ' + error.message);
    });
}

function convertPngToWebp() {
    if (!confirm('âš ï¸ Cette action va convertir TOUTES les images PNG en WebP dans "Photos restaurants/".\n\nLes PNG originaux seront supprimÃ©s aprÃ¨s conversion.\n\nVoulez-vous continuer ?')) {
        return;
    }
    
    const convertBtn = document.getElementById('convertBtn');
    const convertStatus = document.getElementById('convertStatus');
    
    convertBtn.disabled = true;
    convertBtn.innerHTML = 'â³ Conversion en cours...';
    convertStatus.classList.remove('hidden');
    convertStatus.innerHTML = '<div class="bg-white/20 p-4 rounded-[14px]"><p class="m-0 text-white">ğŸ”„ Conversion en cours, veuillez patienter...</p></div>';
    
    fetch('{% url "scripts_manager:photo_convert_png_to_webp" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const stats = data.stats || {};
            let statusHtml = '<div class="bg-white/20 p-4 rounded-[14px] text-white">';
            statusHtml += `<p class="m-0 mb-2 font-semibold">âœ… ${data.message || 'Conversion terminÃ©e'}</p>`;
            
            if (stats.total !== undefined) {
                statusHtml += `<p class="m-1 text-sm">ğŸ“Š ${stats.converted || 0}/${stats.total || 0} image(s) convertie(s)</p>`;
                if (stats.errors > 0) {
                    statusHtml += `<p class="m-1 text-sm text-yellow-200">âš ï¸ ${stats.errors} erreur(s)</p>`;
                }
                if (stats.space_saved_mb !== undefined) {
                    statusHtml += `<p class="m-1 text-sm">ğŸ’¾ Espace Ã©conomisÃ©: ${stats.space_saved_mb} MB (-${stats.overall_reduction_percent || 0}%)</p>`;
                }
                if (stats.total_original_size_mb !== undefined) {
                    statusHtml += `<p class="m-2 mt-3 text-xs opacity-80">ğŸ“¦ Taille originale: ${stats.total_original_size_mb} MB â†’ Taille WebP: ${stats.total_webp_size_mb || 0} MB</p>`;
                }
            } else if (data.converted !== undefined) {
                statusHtml += `<p class="m-1 text-sm">ğŸ“Š ${data.converted} image(s) convertie(s)</p>`;
            }
            
            statusHtml += '</div>';
            convertStatus.innerHTML = statusHtml;
            
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            convertStatus.innerHTML = `<div class="bg-red-500/20 p-4 rounded-[14px] text-white"><p class="m-0">âŒ ${data.error || 'Erreur inconnue'}</p></div>`;
            convertBtn.disabled = false;
            convertBtn.innerHTML = 'ğŸ”„ Convertir PNG â†’ WebP';
        }
    })
    .catch(error => {
        console.error('Erreur lors de la conversion:', error);
        convertStatus.innerHTML = `<div class="bg-red-500/20 p-4 rounded-[14px] text-white"><p class="m-0">âŒ Erreur: ${error.message || 'Erreur inconnue'}</p></div>`;
        convertBtn.disabled = false;
        convertBtn.innerHTML = 'ğŸ”„ Convertir PNG â†’ WebP';
    });
}

// Actions groupÃ©es
function toggleSelectAll(checked) {
    const checkboxes = document.querySelectorAll('.photo-checkbox');
    checkboxes.forEach(cb => cb.checked = checked);
    document.getElementById('selectAll').checked = checked;
    document.getElementById('selectAllHeader').checked = checked;
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const checkboxes = document.querySelectorAll('.photo-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');
    
    document.querySelectorAll('.photo-checkbox').forEach(cb => {
        const row = cb.closest('tr');
        if (cb.checked) {
            row.classList.add('bg-[#D4F2DA]');
        } else {
            row.classList.remove('bg-[#D4F2DA]');
        }
    });
    
    if (count > 0) {
        bulkBar.classList.remove('hidden');
        selectedCount.textContent = count;
    } else {
        bulkBar.classList.add('hidden');
    }
    
    const allCheckboxes = document.querySelectorAll('.photo-checkbox');
    const allChecked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    document.getElementById('selectAll').checked = allChecked;
    document.getElementById('selectAllHeader').checked = allChecked;
}

function clearSelection() {
    toggleSelectAll(false);
}

function getSelectedPhotos() {
    const checkboxes = document.querySelectorAll('.photo-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function bulkDeletePhotos() {
    const selected = getSelectedPhotos();
    if (selected.length === 0) {
        alert('âš ï¸ Aucune photo sÃ©lectionnÃ©e');
        return;
    }
    
    const folder = '{{ folder }}';
    if (!confirm(`âš ï¸ ÃŠtes-vous sÃ»r de vouloir supprimer ${selected.length} photo(s) ?\n\nCette action est irrÃ©versible !`)) {
        return;
    }
    
    const bulkBar = document.getElementById('bulkActionsBar');
    const originalContent = bulkBar.innerHTML;
    bulkBar.innerHTML = '<div class="text-center p-3">â³ Suppression en cours... (' + selected.length + ' photo(s))</div>';
    
    fetch('{% url "scripts_manager:photo_bulk_delete" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            folder: folder,
            photo_names: selected
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… ${data.deleted} photo(s) supprimÃ©e(s) avec succÃ¨s${data.errors > 0 ? '\nâš ï¸ ' + data.errors + ' erreur(s)' : ''}`);
            location.reload();
        } else {
            alert('âŒ ' + data.error);
            bulkBar.innerHTML = originalContent;
        }
    })
    .catch(error => {
        alert('âŒ Erreur: ' + error.message);
        bulkBar.innerHTML = originalContent;
    });
}
</script>
{% endblock %}
