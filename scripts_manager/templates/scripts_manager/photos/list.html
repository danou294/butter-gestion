{% extends 'scripts_manager/base.html' %}

{% block title %}Photos - Butter{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ uploadOpen: false }">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body flex-row flex-wrap items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-serif font-bold text-base-content">ğŸ“¸ Gestion des Photos</h1>
                <p class="text-secondary mt-1">GÃ©rez les logos et photos des restaurants</p>
            </div>
            <button @click="uploadOpen = true" class="btn btn-primary">â• Upload Photo</button>
        </div>
    </div>

    <!-- Onglets -->
    <div class="tabs tabs-boxed bg-base-100 border border-base-300 p-1">
        <a href="?folder=logos{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"
           class="tab {% if folder == 'logos' %}tab-active{% endif %} trigger-loading">ğŸ–¼ï¸ Logos</a>
        <a href="?folder=photos{% if search_query %}&search={{ search_query|urlencode }}{% endif %}"
           class="tab {% if folder == 'photos' %}tab-active{% endif %} trigger-loading">ğŸ“¸ Photos restaurants</a>
    </div>

    <!-- Recherche -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body py-4">
            <form method="GET" action="{% url 'scripts_manager:photos_list' %}" class="auto-loader">
                <input type="hidden" name="folder" value="{{ folder }}">
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" name="search" placeholder="Rechercher par nom de photo..."
                           value="{{ search_query }}" class="input input-bordered flex-1 bg-base-200">
                    <button type="submit" class="btn btn-primary">ğŸ” Rechercher</button>
                    {% if search_query %}
                    <a href="?folder={{ folder }}" class="btn btn-ghost">âŒ Effacer</a>
                    {% endif %}
                </div>
            </form>
        </div>
    </div>

    <!-- Actions Photos restaurants -->
    {% if folder == 'photos' %}
    <div class="card bg-primary text-primary-content">
        <div class="card-body flex-row flex-wrap items-center justify-between gap-4">
            <div>
                <h3 class="text-lg font-serif font-bold">âš¡ Optimisation des Photos</h3>
                <p class="text-sm opacity-90">Convertit et optimise toutes les images PNG en WebP (compression automatique, redimensionnement max 1920x1920px)</p>
            </div>
            <button id="convertBtn" onclick="convertPngToWebp()" class="btn bg-base-100 text-primary hover:bg-base-200">
                ğŸ”„ Convertir PNG â†’ WebP
            </button>
        </div>
        <div id="convertStatus" class="hidden px-6 pb-4"></div>
    </div>
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body flex-row flex-wrap items-center justify-between gap-4">
            <div>
                <h3 class="text-lg font-serif font-bold text-base-content">ğŸ“‹ Restaurants sans photo WebP</h3>
                <p class="text-sm text-secondary">Compare Firestore (env. actif) et le bucket PROD : tÃ©lÃ©charge un Excel des restaurants sans aucune photo .webp</p>
            </div>
            <a href="{% url 'scripts_manager:photo_export_restaurants_without_webp' %}" class="btn btn-primary">
                â¬‡ï¸ Export Excel (sans photo WebP)
            </a>
        </div>
    </div>
    {% endif %}

    {% if search_query %}
    <div class="alert alert-info">
        <span>ğŸ” Recherche : "{{ search_query }}" - {{ results_count }} rÃ©sultat{{ results_count|pluralize }} trouvÃ©{{ results_count|pluralize }}</span>
    </div>
    {% endif %}

    <div class="text-sm text-secondary">RÃ©sultats : {{ results_count }} photo{{ results_count|pluralize }}</div>

    {% if error %}
    <div class="alert alert-error"><span>âŒ Erreur : {{ error }}</span></div>
    {% endif %}

    <!-- Barre d'actions groupÃ©es -->
    <div id="bulkActionsBar" class="hidden alert alert-success shadow-lg sticky top-16 z-40">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 w-full">
            <span class="font-semibold"><strong id="selectedCount">0</strong> photo(s) sÃ©lectionnÃ©e(s)</span>
            <div class="flex gap-2">
                <button onclick="bulkDeletePhotos()" class="btn btn-error btn-sm">ğŸ—‘ï¸ Supprimer sÃ©lection</button>
                <button onclick="clearSelection()" class="btn btn-ghost btn-sm">âŒ Annuler</button>
            </div>
        </div>
    </div>

    {% if photos %}
    <div class="card bg-base-100 shadow-sm border border-base-300 overflow-hidden">
        <div class="p-4 border-b border-base-300">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)" class="checkbox checkbox-primary">
                <strong class="text-base-content">SÃ©lectionner tout</strong>
            </label>
        </div>
        <div class="overflow-x-auto">
            <table class="table">
                <thead>
                    <tr>
                        <th class="w-12">
                            <input type="checkbox" id="selectAllHeader" onchange="toggleSelectAll(this.checked)" class="checkbox checkbox-primary">
                        </th>
                        <th>Nom</th>
                        <th>Taille</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for photo in photos %}
                    <tr data-photo-name="{{ photo.name }}" class="hover">
                        <td>
                            <input type="checkbox" class="photo-checkbox checkbox checkbox-primary"
                                   value="{{ photo.name }}" onchange="updateBulkActionsBar()">
                        </td>
                        <td><code class="badge badge-ghost text-xs break-all">{{ photo.name }}</code></td>
                        <td class="text-sm text-secondary">ğŸ“¦ {{ photo.size|filesizeformat }}</td>
                        <td class="text-sm text-secondary">ğŸ“… {{ photo.time_created|date:"d/m/Y H:i"|default:"â€”" }}</td>
                        <td>
                            <div class="flex gap-1 flex-wrap">
                                <button onclick="downloadPhoto('{{ folder }}', '{{ photo.name }}')" class="btn btn-primary btn-xs">â¬‡ï¸ TÃ©lÃ©charger</button>
                                <button onclick="viewPhoto('{{ folder }}', '{{ photo.name }}')" class="btn btn-ghost btn-xs">ğŸ‘ï¸ Voir</button>
                                <button onclick="renamePhoto('{{ folder }}', '{{ photo.name }}')" class="btn btn-ghost btn-xs">âœï¸ Renommer</button>
                                <button onclick="deletePhoto('{{ folder }}', '{{ photo.name }}')" class="btn btn-error btn-xs">ğŸ—‘ï¸ Supprimer</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if page_obj.paginator.num_pages > 1 %}
    <div class="flex items-center justify-between">
        <span class="text-sm text-secondary">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
        <div class="join">
            {% if page_obj.has_previous %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}" class="join-item btn btn-ghost trigger-loading">â† PrÃ©cÃ©dent</a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}" class="join-item btn btn-ghost trigger-loading">Suivant â†’</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="alert alert-info"><span>ğŸ“­ Aucune photo dans ce dossier.</span></div>
    {% endif %}

    <!-- Modal Upload (Alpine.js) -->
    <div x-show="uploadOpen" x-transition class="fixed inset-0 bg-neutral/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" @click.self="uploadOpen = false">
        <div class="card bg-base-100 shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto" @click.stop>
            <div class="card-body">
                <h3 class="card-title text-2xl font-serif">ğŸ“¤ Upload Photo</h3>
                <form id="uploadForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="form-control mb-4">
                        <label class="label"><span class="label-text">ğŸ“ Dossier de destination</span></label>
                        <select id="uploadFolder" name="folder" required class="select select-bordered bg-base-200">
                            <option value="logos" {% if folder == 'logos' %}selected{% endif %}>ğŸ–¼ï¸ Logos</option>
                            <option value="photos" {% if folder == 'photos' %}selected{% endif %}>ğŸ“¸ Photos restaurants</option>
                        </select>
                    </div>

                    <div id="uploadArea" onclick="document.getElementById('photo_file').click()"
                         class="border-2 border-dashed border-base-300 rounded-box p-8 text-center cursor-pointer transition-colors hover:border-primary hover:bg-base-200">
                        <div class="text-5xl mb-4">ğŸ“„</div>
                        <h4 class="text-lg font-medium text-base-content mb-2">Glissez-dÃ©posez vos photos ici</h4>
                        <p class="text-secondary mb-4">ou</p>
                        <button type="button" class="btn btn-ghost btn-sm">Parcourir les fichiers</button>
                        <p class="text-sm text-secondary mt-2">Vous pouvez sÃ©lectionner plusieurs photos Ã  la fois</p>
                        <input type="file" id="photo_file" name="photo_file" accept="image/*" multiple required class="hidden">
                    </div>

                    <div id="filesList" class="mt-4 hidden">
                        <div class="bg-base-200 rounded-box p-4">
                            <strong class="text-base-content block mb-2">Fichiers sÃ©lectionnÃ©s (<span id="filesCount">0</span>) :</strong>
                            <div id="filesInfo" class="space-y-2 max-h-48 overflow-y-auto"></div>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-3">
                        <button type="submit" class="btn btn-primary flex-1">ğŸ“¤ Upload</button>
                        <button type="button" @click="uploadOpen = false" class="btn btn-ghost flex-1">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Drag & drop
const uploadArea = document.getElementById('uploadArea');
const photoFile = document.getElementById('photo_file');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('border-primary', 'bg-success/10');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('border-primary', 'bg-success/10');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('border-primary', 'bg-success/10');
    if (e.dataTransfer.files.length > 0) {
        const dt = new DataTransfer();
        for (let file of e.dataTransfer.files) {
            dt.items.add(file);
        }
        photoFile.files = dt.files;
        handleFilesSelect(Array.from(e.dataTransfer.files));
    }
});

photoFile.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFilesSelect(Array.from(e.target.files));
    }
});

function handleFilesSelect(files) {
    const filesList = document.getElementById('filesList');
    const filesInfo = document.getElementById('filesInfo');
    const filesCount = document.getElementById('filesCount');

    filesList.classList.remove('hidden');
    filesInfo.innerHTML = '';
    filesCount.textContent = files.length;

    let totalSize = 0;
    files.forEach((file, index) => {
        totalSize += file.size;
        const fileDiv = document.createElement('div');
        fileDiv.className = 'flex items-center justify-between p-2 bg-base-100 rounded-lg text-sm';
        fileDiv.innerHTML = `
            <div class="flex-1">
                <span class="text-base-content font-medium">${file.name}</span>
                <span class="text-secondary ml-2">(${formatFileSize(file.size)})</span>
            </div>
        `;
        filesInfo.appendChild(fileDiv);
    });

    const totalDiv = document.createElement('div');
    totalDiv.className = 'mt-2 pt-2 border-t border-base-300 text-sm font-semibold text-base-content';
    totalDiv.textContent = `Taille totale: ${formatFileSize(totalSize)}`;
    filesInfo.appendChild(totalDiv);
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Upload form
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const photoFileInput = document.getElementById('photo_file');
    const files = photoFileInput.files;

    if (files.length === 0) {
        alert('âš ï¸ Veuillez sÃ©lectionner au moins un fichier');
        return;
    }

    const folder = document.getElementById('uploadFolder').value;
    const submitButton = this.querySelector('button[type="submit"]');
    const originalButtonText = submitButton.textContent;

    submitButton.disabled = true;
    submitButton.textContent = 'â³ Upload en cours...';

    let uploaded = 0;
    let errors = 0;
    const total = files.length;
    const errorMessages = [];

    const uploadPromises = Array.from(files).map((file, index) => {
        const formData = new FormData();
        formData.append('photo_file', file);
        formData.append('folder', folder);

        return fetch('{% url "scripts_manager:photo_upload" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploaded++;
                submitButton.textContent = `â³ Upload: ${uploaded}/${total}...`;
            } else {
                errors++;
                errorMessages.push(`${file.name}: ${data.error || 'Erreur inconnue'}`);
            }
        })
        .catch(error => {
            errors++;
            errorMessages.push(`${file.name}: ${error.message}`);
        });
    });

    Promise.all(uploadPromises).then(() => {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;

        if (uploaded === total) {
            alert(`âœ… ${uploaded} photo(s) uploadÃ©e(s) avec succÃ¨s !`);
            location.reload();
        } else if (uploaded > 0) {
            let message = `âš ï¸ ${uploaded} photo(s) uploadÃ©e(s), ${errors} erreur(s)\n\n`;
            if (errorMessages.length > 0) {
                message += 'Erreurs:\n' + errorMessages.slice(0, 5).join('\n');
                if (errorMessages.length > 5) {
                    message += `\n... et ${errorMessages.length - 5} autre(s) erreur(s)`;
                }
            }
            alert(message);
            location.reload();
        } else {
            alert('âŒ Aucune photo n\'a pu Ãªtre uploadÃ©e.\n\n' + errorMessages.join('\n'));
        }
    });
});

function getPhotoUrl(folder, photoName) {
    return new Promise((resolve, reject) => {
        const url = `{% url "scripts_manager:photo_get_url" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.url) resolve(data.url);
                else reject(new Error(data.error || 'Erreur'));
            })
            .catch(error => reject(error));
    });
}

function downloadPhoto(folder, photoName) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'â³';
    button.disabled = true;

    getPhotoUrl(folder, photoName)
        .then(url => {
            const a = document.createElement('a');
            a.href = url; a.download = photoName; a.target = '_blank';
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            button.textContent = originalText; button.disabled = false;
        })
        .catch(error => {
            alert('âŒ Erreur: ' + error.message);
            button.textContent = originalText; button.disabled = false;
        });
}

function viewPhoto(folder, photoName) {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'â³'; button.disabled = true;

    getPhotoUrl(folder, photoName)
        .then(url => {
            window.open(url, '_blank');
            button.textContent = originalText; button.disabled = false;
        })
        .catch(error => {
            alert('âŒ Erreur: ' + error.message);
            button.textContent = originalText; button.disabled = false;
        });
}

function renamePhoto(folder, photoName) {
    const newName = prompt('Nouveau nom pour la photo:', photoName);
    if (newName && newName !== photoName) {
        const formData = new FormData();
        formData.append('new_name', newName);

        const renameUrl = `{% url "scripts_manager:photo_rename" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
        fetch(renameUrl, {
            method: 'POST', body: formData,
            headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) { alert('âœ… ' + data.message); location.reload(); }
            else alert('âŒ ' + data.error);
        })
        .catch(error => alert('âŒ Erreur: ' + error.message));
    }
}

function deletePhoto(folder, photoName) {
    if (!confirm(`Supprimer "${photoName}" ?\n\nCette action est irrÃ©versible !`)) return;

    const deleteUrl = `{% url "scripts_manager:photo_delete" folder="__FOLDER__" photo_name="__NAME__" %}`.replace('__FOLDER__', folder).replace('__NAME__', encodeURIComponent(photoName));
    fetch(deleteUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) { alert('âœ… ' + data.message); location.reload(); }
        else alert('âŒ ' + data.error);
    })
    .catch(error => alert('âŒ Erreur: ' + error.message));
}

function convertPngToWebp() {
    if (!confirm('âš ï¸ Cette action va convertir TOUTES les images PNG en WebP dans "Photos restaurants/".\n\nLes PNG originaux seront supprimÃ©s aprÃ¨s conversion.\n\nVoulez-vous continuer ?')) return;

    const convertBtn = document.getElementById('convertBtn');
    const convertStatus = document.getElementById('convertStatus');

    convertBtn.disabled = true;
    convertBtn.innerHTML = 'â³ Conversion en cours...';
    convertStatus.classList.remove('hidden');
    convertStatus.innerHTML = '<div class="alert alert-info"><span>ğŸ”„ Conversion en cours, veuillez patienter...</span></div>';

    fetch('{% url "scripts_manager:photo_convert_png_to_webp" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    })
    .then(response => {
        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const stats = data.stats || {};
            let html = '<div class="alert alert-success"><div>';
            html += `<p class="font-semibold">âœ… ${data.message || 'Conversion terminÃ©e'}</p>`;
            if (stats.total !== undefined) {
                html += `<p class="text-sm">ğŸ“Š ${stats.converted || 0}/${stats.total || 0} image(s) convertie(s)</p>`;
                if (stats.errors > 0) html += `<p class="text-sm">âš ï¸ ${stats.errors} erreur(s)</p>`;
                if (stats.space_saved_mb !== undefined) html += `<p class="text-sm">ğŸ’¾ Espace Ã©conomisÃ©: ${stats.space_saved_mb} MB (-${stats.overall_reduction_percent || 0}%)</p>`;
                if (stats.total_original_size_mb !== undefined) html += `<p class="text-xs opacity-80">ğŸ“¦ Taille originale: ${stats.total_original_size_mb} MB â†’ Taille WebP: ${stats.total_webp_size_mb || 0} MB</p>`;
            } else if (data.converted !== undefined) {
                html += `<p class="text-sm">ğŸ“Š ${data.converted} image(s) convertie(s)</p>`;
            }
            html += '</div></div>';
            convertStatus.innerHTML = html;
            setTimeout(() => location.reload(), 3000);
        } else {
            convertStatus.innerHTML = `<div class="alert alert-error"><span>âŒ ${data.error || 'Erreur inconnue'}</span></div>`;
            convertBtn.disabled = false;
            convertBtn.innerHTML = 'ğŸ”„ Convertir PNG â†’ WebP';
        }
    })
    .catch(error => {
        convertStatus.innerHTML = `<div class="alert alert-error"><span>âŒ ${error.message}</span></div>`;
        convertBtn.disabled = false;
        convertBtn.innerHTML = 'ğŸ”„ Convertir PNG â†’ WebP';
    });
}

function toggleSelectAll(checked) {
    document.querySelectorAll('.photo-checkbox').forEach(cb => cb.checked = checked);
    document.getElementById('selectAll').checked = checked;
    document.getElementById('selectAllHeader').checked = checked;
    updateBulkActionsBar();
}

function updateBulkActionsBar() {
    const checkboxes = document.querySelectorAll('.photo-checkbox:checked');
    const count = checkboxes.length;
    const bulkBar = document.getElementById('bulkActionsBar');
    const selectedCount = document.getElementById('selectedCount');

    document.querySelectorAll('.photo-checkbox').forEach(cb => {
        const row = cb.closest('tr');
        if (cb.checked) row.classList.add('bg-success/10');
        else row.classList.remove('bg-success/10');
    });

    if (count > 0) {
        bulkBar.classList.remove('hidden');
        selectedCount.textContent = count;
    } else {
        bulkBar.classList.add('hidden');
    }

    const allCheckboxes = document.querySelectorAll('.photo-checkbox');
    const allChecked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
    document.getElementById('selectAll').checked = allChecked;
    document.getElementById('selectAllHeader').checked = allChecked;
}

function clearSelection() { toggleSelectAll(false); }

function getSelectedPhotos() {
    return Array.from(document.querySelectorAll('.photo-checkbox:checked')).map(cb => cb.value);
}

function bulkDeletePhotos() {
    const selected = getSelectedPhotos();
    if (selected.length === 0) { alert('âš ï¸ Aucune photo sÃ©lectionnÃ©e'); return; }

    if (!confirm(`âš ï¸ Supprimer ${selected.length} photo(s) ?\n\nCette action est irrÃ©versible !`)) return;

    const bulkBar = document.getElementById('bulkActionsBar');
    const originalContent = bulkBar.innerHTML;
    bulkBar.innerHTML = '<div class="text-center p-3">â³ Suppression en cours... (' + selected.length + ' photo(s))</div>';

    fetch('{% url "scripts_manager:photo_bulk_delete" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ folder: '{{ folder }}', photo_names: selected })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… ${data.deleted} photo(s) supprimÃ©e(s)${data.errors > 0 ? '\nâš ï¸ ' + data.errors + ' erreur(s)' : ''}`);
            location.reload();
        } else {
            alert('âŒ ' + data.error);
            bulkBar.innerHTML = originalContent;
        }
    })
    .catch(error => {
        alert('âŒ Erreur: ' + error.message);
        bulkBar.innerHTML = originalContent;
    });
}
</script>
{% endblock %}
