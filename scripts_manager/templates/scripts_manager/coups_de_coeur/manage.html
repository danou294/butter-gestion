{% extends "scripts_manager/base.html" %}
{% load static %}

{% block title %}Coups de coeur ‚Äî Butter Backoffice{% endblock %}

{% block content %}
<div class="space-y-6" x-data="coupsDeCoeurManager()">

    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-base-content mb-2">‚ù§Ô∏è Coups de coeur de la semaine</h1>
                    <p class="text-secondary">
                        {{ selected_count }} restaurant(s) s√©lectionn√©(s)
                        {% if updated_at %}
                            <span class="ml-2 text-xs text-gray-400">
                                Derni√®re mise √† jour : {{ updated_at|date:"d/m/Y H:i" }}
                            </span>
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulaire principal -->
    <form method="post" action="{% url 'scripts_manager:coups_de_coeur_save' %}">
        {% csrf_token %}

        <!-- Label de la semaine -->
        <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-3">üìÖ Label de la semaine</h2>
                <input type="text"
                       name="week_label"
                       value="{{ week_label }}"
                       placeholder="Ex: Semaine du 17 f√©vrier"
                       class="input input-bordered w-full max-w-md"
                />
                <p class="text-xs text-gray-400 mt-1">
                    Optionnel ‚Äî affich√© sous le titre "Coups de coeur" dans l'app.
                </p>
            </div>
        </div>

        <!-- Importer depuis CSV/Excel -->
        <div class="card bg-base-100 shadow-sm border border-primary/30 mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-3">üì• Importer depuis CSV / Excel</h2>
                <p class="text-xs text-gray-400 mb-3">
                    Uploadez un fichier avec une colonne "Nom" contenant les noms des restaurants.
                    Les noms seront match√©s automatiquement avec la base Firestore.
                </p>
                <div class="flex flex-col sm:flex-row gap-3 items-start">
                    <input type="file" accept=".csv,.xlsx,.xls"
                           class="file-input file-input-bordered file-input-sm w-full sm:max-w-xs"
                           @change="importFromFile($event)" />
                    <a href="{% url 'scripts_manager:download_example_csv' variant='liste' %}"
                       class="btn btn-ghost btn-sm gap-1" download>
                        üìÑ Exemple CSV
                    </a>
                </div>
                <div x-show="importResult" class="mt-3 p-3 rounded-lg text-sm"
                     :class="importResult?.error ? 'bg-error/10 text-error' : 'bg-success/10 text-success'">
                    <span x-text="importResult?.message"></span>
                </div>
            </div>
        </div>

        <!-- Ajouter un restaurant -->
        <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-3">‚ûï Ajouter un restaurant</h2>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex-1">
                        <input type="text"
                               x-model="searchQuery"
                               @input="filterRestaurants()"
                               placeholder="Rechercher par nom..."
                               class="input input-bordered w-full"
                        />
                        <!-- R√©sultats de recherche -->
                        <div x-show="searchQuery.length > 0 && filteredRestaurants.length > 0"
                             class="mt-2 max-h-60 overflow-y-auto border border-base-300 rounded-lg bg-white">
                            <template x-for="r in filteredRestaurants" :key="r.id">
                                <button type="button"
                                        @click="addRestaurant(r)"
                                        class="flex items-center justify-between w-full px-4 py-2.5 hover:bg-base-200 transition-colors text-left border-b border-base-200 last:border-b-0"
                                        :class="{ 'opacity-40 cursor-not-allowed': selectedIds.includes(r.id) }">
                                    <div>
                                        <span class="font-medium text-sm" x-text="r.name"></span>
                                        <span class="text-xs text-gray-400 ml-2" x-text="r.cuisine"></span>
                                        <span class="text-xs text-gray-400 ml-1" x-text="r.arrondissement"></span>
                                    </div>
                                    <span x-show="selectedIds.includes(r.id)" class="text-xs text-success">‚úì d√©j√† ajout√©</span>
                                    <span x-show="!selectedIds.includes(r.id)" class="text-xs text-primary">+ ajouter</span>
                                </button>
                            </template>
                        </div>
                        <div x-show="searchQuery.length > 0 && filteredRestaurants.length === 0"
                             class="mt-2 p-3 text-sm text-gray-400 border border-base-300 rounded-lg">
                            Aucun restaurant trouv√©.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Restaurants s√©lectionn√©s -->
        <div class="card bg-base-100 shadow-sm border border-base-300 mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-3">
                    üèÜ S√©lection actuelle
                    <span class="badge badge-primary" x-text="selectedIds.length"></span>
                </h2>

                <div x-show="selectedIds.length === 0" class="text-center py-8 text-gray-400">
                    <p class="text-lg">Aucun restaurant s√©lectionn√©</p>
                    <p class="text-sm mt-1">Utilisez la recherche ci-dessus pour ajouter des restaurants.</p>
                </div>

                <div class="space-y-2">
                    <template x-for="(id, index) in selectedIds" :key="id">
                        <div class="flex items-center gap-3 p-3 bg-base-200 rounded-lg">
                            <span class="text-sm font-bold text-gray-400 w-6 text-center" x-text="index + 1"></span>

                            <!-- Logo -->
                            <div class="w-10 h-10 rounded-lg overflow-hidden bg-base-300 flex-shrink-0">
                                <img x-show="restaurantDetails[id]?.logoFullUrl"
                                     :src="restaurantDetails[id]?.logoFullUrl"
                                     class="w-full h-full object-cover"
                                     onerror="this.style.display='none'" />
                            </div>

                            <!-- Info -->
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-sm truncate" x-text="restaurantDetails[id]?.name || id"></p>
                                <p class="text-xs text-gray-400">
                                    <span x-text="restaurantDetails[id]?.cuisine || ''"></span>
                                    <span x-show="restaurantDetails[id]?.arrondissement"> ¬∑ </span>
                                    <span x-text="restaurantDetails[id]?.arrondissement || ''"></span>
                                </p>
                            </div>

                            <!-- Actions -->
                            <div class="flex items-center gap-1">
                                <button type="button" @click="moveUp(index)"
                                        class="btn btn-ghost btn-xs" :disabled="index === 0">‚Üë</button>
                                <button type="button" @click="moveDown(index)"
                                        class="btn btn-ghost btn-xs" :disabled="index === selectedIds.length - 1">‚Üì</button>
                                <button type="button" @click="removeRestaurant(index)"
                                        class="btn btn-ghost btn-xs text-error">‚úï</button>
                            </div>

                            <!-- Hidden input pour le formulaire -->
                            <input type="hidden" name="restaurant_ids" :value="id" />
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Bouton sauvegarder -->
        <div class="flex justify-end">
            <button type="submit" class="btn btn-primary btn-lg gap-2">
                üíæ Sauvegarder les coups de coeur
            </button>
        </div>
    </form>
</div>

<script>
function coupsDeCoeurManager() {
    // Donn√©es initiales depuis Django
    const initialIds = {{ current_ids|safe }};
    const allRestaurants = {{ all_restaurants|safe }};

    // D√©tails des restaurants s√©lectionn√©s
    const details = {};
    {% for r in selected_restaurants %}
    details['{{ r.id }}'] = {
        name: '{{ r.name|escapejs }}',
        cuisine: '{{ r.cuisine|default:""|escapejs }}',
        arrondissement: '{{ r.arrondissement|default:""|escapejs }}',
        logoFullUrl: '{{ r.logoFullUrl|default:""|escapejs }}',
    };
    {% endfor %}

    return {
        selectedIds: [...initialIds],
        restaurantDetails: details,
        allRestaurants: allRestaurants,
        searchQuery: '',
        filteredRestaurants: [],
        importResult: null,

        async importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            this.importResult = null;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const resp = await fetch('{% url "scripts_manager:parse_restaurant_list_file" %}', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
                });
                const data = await resp.json();

                if (!data.success) {
                    this.importResult = { error: true, message: data.error || 'Erreur inconnue' };
                    return;
                }

                let added = 0;
                for (const r of data.matched) {
                    if (!this.selectedIds.includes(r.id)) {
                        this.selectedIds.push(r.id);
                        this.restaurantDetails[r.id] = {
                            name: r.name,
                            cuisine: r.cuisine,
                            arrondissement: r.arrondissement,
                            logoFullUrl: '',
                        };
                        added++;
                    }
                }

                let msg = `‚úÖ ${added} restaurant(s) ajout√©(s)`;
                if (data.not_found.length > 0) {
                    msg += ` ‚Äî ‚ö†Ô∏è ${data.not_found.length} non trouv√©(s) : ${data.not_found.join(', ')}`;
                }
                this.importResult = { error: false, message: msg };
            } catch (e) {
                this.importResult = { error: true, message: 'Erreur r√©seau : ' + e.message };
            }

            event.target.value = '';
        },

        filterRestaurants() {
            const q = this.searchQuery.toLowerCase().trim();
            if (q.length === 0) {
                this.filteredRestaurants = [];
                return;
            }
            this.filteredRestaurants = this.allRestaurants
                .filter(r => r.name.toLowerCase().includes(q))
                .slice(0, 15);
        },

        addRestaurant(r) {
            if (this.selectedIds.includes(r.id)) return;
            this.selectedIds.push(r.id);
            this.restaurantDetails[r.id] = {
                name: r.name,
                cuisine: r.cuisine,
                arrondissement: r.arrondissement,
                logoFullUrl: '',
            };
            this.searchQuery = '';
            this.filteredRestaurants = [];
        },

        removeRestaurant(index) {
            this.selectedIds.splice(index, 1);
        },

        moveUp(index) {
            if (index === 0) return;
            const temp = this.selectedIds[index];
            this.selectedIds[index] = this.selectedIds[index - 1];
            this.selectedIds[index - 1] = temp;
        },

        moveDown(index) {
            if (index >= this.selectedIds.length - 1) return;
            const temp = this.selectedIds[index];
            this.selectedIds[index] = this.selectedIds[index + 1];
            this.selectedIds[index + 1] = temp;
        },
    };
}
</script>
{% endblock %}
