{% extends 'scripts_manager/base.html' %}

{% block title %}Notifications Push - Butter{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <h1 class="text-3xl font-serif font-bold text-[#111111] mb-2">üì± Envoi de Notifications Push</h1>
        <p class="text-[#535353]">Envoyez des notifications √† vos utilisateurs</p>
    </div>
    
    <!-- Tabs -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm border border-[#C9C1B1] overflow-hidden">
        <div class="border-b border-[#C9C1B1]">
            <nav class="flex -mb-px">
                <button onclick="switchTab('all')" id="tab-btn-all" class="tab-button active px-6 py-4 text-sm font-medium border-b-2 border-[#111111] text-[#111111]">
                    üì¢ √Ä tous
                </button>
                <button onclick="switchTab('personalized')" id="tab-btn-personalized" class="tab-button px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#535353] hover:text-[#111111] hover:border-[#C9C1B1]">
                    üë§ Personnalis√©es
                </button>
                <button onclick="switchTab('group')" id="tab-btn-group" class="tab-button px-6 py-4 text-sm font-medium border-b-2 border-transparent text-[#535353] hover:text-[#111111] hover:border-[#C9C1B1]">
                    üë• Groupe
                </button>
            </nav>
        </div>
        
        <div class="p-6">
            <!-- Tab: √Ä tous -->
            <div id="tab-all" class="tab-content">
                <form id="form-all" class="space-y-4 max-w-2xl">
                    <div>
                        <label for="title-all" class="block text-sm font-medium text-[#111111] mb-2">Titre *</label>
                        <input type="text" id="title-all" name="title" required 
                               placeholder="Ex: Nouvelle fonctionnalit√© disponible"
                               class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                    </div>
                    
                    <div>
                        <label for="body-all" class="block text-sm font-medium text-[#111111] mb-2">Message *</label>
                        <textarea id="body-all" name="body" required rows="4" 
                                  placeholder="Ex: D√©couvrez notre nouvelle fonctionnalit√©..."
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]"></textarea>
                    </div>
                    
                    <div>
                        <label for="data-all" class="block text-sm font-medium text-[#111111] mb-2">Donn√©es suppl√©mentaires (JSON, optionnel)</label>
                        <textarea id="data-all" name="data" rows="3" 
                                  placeholder='{"type": "feature", "id": "123"}'
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent font-mono text-sm bg-[#F1EFEB] text-[#111111]"></textarea>
                        <p class="mt-1 text-xs text-[#535353]">Format JSON valide requis</p>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        üì§ Envoyer √† tous les utilisateurs
                    </button>
                </form>
            </div>
            
            <!-- Tab: Personnalis√©es -->
            <div id="tab-personalized" class="tab-content hidden">
                <form id="form-personalized" class="space-y-4 max-w-2xl">
                    <div>
                        <label for="title-personalized" class="block text-sm font-medium text-[#111111] mb-2">Titre * (utilisez {prenom} pour personnaliser)</label>
                        <input type="text" id="title-personalized" name="title" required 
                               placeholder='Ex: Salut {prenom} !'
                               class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                    </div>
                    
                    <div>
                        <label for="body-personalized" class="block text-sm font-medium text-[#111111] mb-2">Message * (utilisez {prenom} pour personnaliser)</label>
                        <textarea id="body-personalized" name="body" required rows="4" 
                                  placeholder='Ex: {prenom}, d√©couvrez notre nouvelle fonctionnalit√©...'
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]"></textarea>
                    </div>
                    
                    <div>
                        <label for="data-personalized" class="block text-sm font-medium text-[#111111] mb-2">Donn√©es suppl√©mentaires (JSON, optionnel)</label>
                        <textarea id="data-personalized" name="data" rows="3" 
                                  placeholder='{"type": "feature", "id": "123"}'
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent font-mono text-sm bg-[#F1EFEB] text-[#111111]"></textarea>
                        <p class="mt-1 text-xs text-[#535353]">Format JSON valide requis</p>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        üë§ Envoyer des notifications personnalis√©es
                    </button>
                </form>
            </div>
            
            <!-- Tab: Groupe -->
            <div id="tab-group" class="tab-content hidden">
                <form id="form-group" class="space-y-4">
                    <!-- Recherche et Import Excel -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="user-search" class="block text-sm font-medium text-[#111111] mb-2">üîç Rechercher un utilisateur</label>
                            <input type="text" id="user-search" 
                                   placeholder="Rechercher par nom, UUID ou t√©l√©phone..."
                                   class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                        </div>
                        <div>
                            <label for="excel-upload" class="block text-sm font-medium text-[#111111] mb-2">üìä Importer depuis Excel</label>
                            <div class="flex gap-2">
                                <input type="file" id="excel-upload" accept=".xlsx,.xls" 
                                       class="hidden">
                                <button type="button" onclick="document.getElementById('excel-upload').click()" 
                                        class="flex-1 px-4 py-3 border border-[#C9C1B1] rounded-[14px] bg-[#F1EFEB] text-[#111111] hover:bg-[#E8E4DD] transition-colors">
                                    üìÅ Choisir fichier
                                </button>
                                <select id="excel-column" 
                                        class="px-4 py-3 border border-[#C9C1B1] rounded-[14px] bg-[#F1EFEB] text-[#111111]">
                                    <option value="">Colonne UUID</option>
                                </select>
                            </div>
                            <p class="mt-1 text-xs text-[#535353]" id="excel-info"></p>
                        </div>
                    </div>
                    
                    <!-- Tableau des utilisateurs -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-[#111111]">S√©lectionner les utilisateurs *</label>
                            <span id="selected-count" class="text-sm text-[#535353]">0 s√©lectionn√©(s)</span>
                        </div>
                        <div class="border border-[#C9C1B1] rounded-[14px] overflow-hidden bg-[#F1EFEB] max-h-[400px] overflow-y-auto">
                            <table class="w-full">
                                <thead class="bg-[#C9C1B1] sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-[#111111] w-12">
                                            <input type="checkbox" id="select-all" class="rounded border-[#C9C1B1]">
                                        </th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-[#111111]">Pr√©nom</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-[#111111]">UUID</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-[#111111]">üì± T√©l√©phone</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-[#111111]">‚úâÔ∏è Email</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    {% for user in users %}
                                    <tr class="user-row border-t border-[#C9C1B1] hover:bg-[#E8E4DD]" data-uid="{{ user.uid }}" data-prenom="{{ user.prenom|lower }}" data-phone="{{ user.phone|lower }}" data-email="{{ user.email|lower }}">
                                        <td class="px-4 py-3">
                                            <input type="checkbox" class="user-checkbox rounded border-[#C9C1B1]" value="{{ user.uid }}">
                                        </td>
                                        <td class="px-4 py-3 text-sm text-[#111111]">{{ user.prenom }}</td>
                                        <td class="px-4 py-3 text-sm text-[#111111] font-mono">{{ user.uid }}</td>
                                        <td class="px-4 py-3 text-sm text-[#111111]">{{ user.phone }}</td>
                                        <td class="px-4 py-3 text-sm text-[#111111]">{{ user.email }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div>
                        <label for="title-group" class="block text-sm font-medium text-[#111111] mb-2">Titre *</label>
                        <input type="text" id="title-group" name="title" required 
                               placeholder="Ex: Notification sp√©ciale"
                               class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                    </div>
                    
                    <div>
                        <label for="body-group" class="block text-sm font-medium text-[#111111] mb-2">Message *</label>
                        <textarea id="body-group" name="body" required rows="4" 
                                  placeholder="Ex: Message pour le groupe s√©lectionn√©..."
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]"></textarea>
                    </div>
                    
                    <div>
                        <label for="data-group" class="block text-sm font-medium text-[#111111] mb-2">Donn√©es suppl√©mentaires (JSON, optionnel)</label>
                        <textarea id="data-group" name="data" rows="3" 
                                  placeholder='{"type": "group", "id": "123"}'
                                  class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent font-mono text-sm bg-[#F1EFEB] text-[#111111]"></textarea>
                        <p class="mt-1 text-xs text-[#535353]">Format JSON valide requis</p>
                    </div>
                    
                    <button type="submit" class="w-full btn-primary">
                        üë• Envoyer au groupe s√©lectionn√©
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    <div id="results" class="hidden bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <h3 class="text-xl font-serif font-bold text-[#111111] mb-4">üìä R√©sultats de l'envoi</h3>
        <div id="results-content" class="space-y-2"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SheetJS pour parser Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let currentTab = 'all';
let allUsers = [
    {% for user in users %}
    {
        uid: "{{ user.uid }}",
        prenom: "{{ user.prenom }}",
        phone: "{{ user.phone }}",
        email: "{{ user.email }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function switchTab(tab) {
    currentTab = tab;
    
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active class from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-amber-600', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
    
    // Add active class to selected button
    const activeBtn = document.getElementById(`tab-btn-${tab}`);
    activeBtn.classList.add('active', 'border-[#111111]', 'text-[#111111]');
    activeBtn.classList.remove('border-transparent', 'text-[#535353]');
}

// Form submissions
document.getElementById('form-all').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('all', '{% url "scripts_manager:send_notification_to_all" %}');
});

document.getElementById('form-personalized').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('personalized', '{% url "scripts_manager:send_notification_to_all_with_prenom" %}');
});

document.getElementById('form-group').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('group', '{% url "scripts_manager:send_notification_to_group" %}');
});

async function sendNotification(tab, endpoint) {
    const form = document.getElementById(`form-${tab}`);
    const formData = new FormData(form);
    
    const data = {
        title: formData.get('title'),
        body: formData.get('body'),
    };
    
    // Parse JSON data if provided
    const dataField = formData.get('data');
    if (dataField && dataField.trim()) {
        try {
            data.data = JSON.parse(dataField);
        } catch (e) {
            alert('‚ùå Erreur: Les donn√©es suppl√©mentaires doivent √™tre au format JSON valide');
            return;
        }
    }
    
    // For group tab, get selected user IDs from checkboxes
    if (tab === 'group') {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        const selectedUsers = Array.from(checkboxes).map(cb => cb.value);
        if (selectedUsers.length === 0) {
            alert('‚ùå Veuillez s√©lectionner au moins un utilisateur');
            return;
        }
        data.userIds = selectedUsers;
    }
    
    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Envoi en cours...';
    showLoading();
    
    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result);
        } else {
            alert(`‚ùå Erreur: ${result.error || result.details || 'Erreur inconnue'}`);
        }
    } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        hideLoading();
    }
}

function showResults(result) {
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');
    
    resultsContent.innerHTML = `
        <div class="space-y-2">
            <p><strong>‚úÖ Succ√®s:</strong> <span class="text-[#60BC81] font-semibold">${result.successCount}</span> notification(s) envoy√©e(s)</p>
            <p><strong>‚ùå √âchecs:</strong> <span class="text-[#D3695E] font-semibold">${result.failureCount}</span> notification(s) √©chou√©e(s)</p>
            <p><strong>üì± Total:</strong> <span class="text-[#535353] font-semibold">${result.totalTokens || (result.successCount + result.failureCount)}</span> token(s) trait√©(s)</p>
            ${result.invalidUsers ? `<p><strong>‚ö†Ô∏è Utilisateurs invalides:</strong> ${result.invalidUsers.length}</p>` : ''}
        </div>
    `;
    
    resultsDiv.classList.remove('hidden');
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

// Fonction pour obtenir le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Fonction pour afficher/masquer le loading
function showLoading() {
    // Peut √™tre impl√©ment√©e si n√©cessaire
}
function hideLoading() {
    // Peut √™tre impl√©ment√©e si n√©cessaire
}

// Recherche d'utilisateurs
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('user-search');
    const selectAllCheckbox = document.getElementById('select-all');
    const usersTableBody = document.getElementById('users-table-body');
    const selectedCountSpan = document.getElementById('selected-count');
    const excelUpload = document.getElementById('excel-upload');
    const excelColumn = document.getElementById('excel-column');
    
    // Recherche en temps r√©el
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const rows = usersTableBody.querySelectorAll('.user-row');
            
            rows.forEach(row => {
                const prenom = row.dataset.prenom || '';
                const uid = row.dataset.uid || '';
                const phone = row.dataset.phone || '';
                const email = row.dataset.email || '';
                
                const matches = !searchTerm || 
                    prenom.includes(searchTerm) || 
                    uid.toLowerCase().includes(searchTerm) || 
                    phone.includes(searchTerm) ||
                    email.includes(searchTerm);
                
                row.style.display = matches ? '' : 'none';
            });
        });
    }
    
    // S√©lectionner/D√©s√©lectionner tout
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(e) {
            const checkboxes = usersTableBody.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('.user-row').style.display !== 'none') {
                    cb.checked = e.target.checked;
                }
            });
            updateSelectedCount();
        });
    }
    
    // Mettre √† jour le compteur de s√©lection
    function updateSelectedCount() {
        const checked = usersTableBody.querySelectorAll('.user-checkbox:checked').length;
        selectedCountSpan.textContent = `${checked} s√©lectionn√©(s)`;
        
        // Mettre √† jour la checkbox "Tout s√©lectionner"
        const visibleCheckboxes = Array.from(usersTableBody.querySelectorAll('.user-checkbox'))
            .filter(cb => cb.closest('.user-row').style.display !== 'none');
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked).length;
        selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedVisible === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedVisible > 0 && checkedVisible < visibleCheckboxes.length;
    }
    
    // √âcouter les changements sur les checkboxes individuelles
    if (usersTableBody) {
        usersTableBody.addEventListener('change', function(e) {
            if (e.target.classList.contains('user-checkbox')) {
                updateSelectedCount();
            }
        });
    }
    
    // Import Excel
    if (excelUpload) {
        excelUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Prendre la premi√®re feuille
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length === 0) {
                        alert('‚ùå Le fichier Excel est vide');
                        return;
                    }
                    
                    // Remplir le select des colonnes avec les en-t√™tes
                    const headers = jsonData[0];
                    excelColumn.innerHTML = '<option value="">S√©lectionner une colonne</option>';
                    headers.forEach((header, index) => {
                        if (header) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = header;
                            excelColumn.appendChild(option);
                        }
                    });
                    
                    document.getElementById('excel-info').textContent = `${jsonData.length - 1} lignes trouv√©es. S√©lectionnez la colonne contenant les UUIDs.`;
                    
                    // Quand une colonne est s√©lectionn√©e, s√©lectionner les utilisateurs
                    excelColumn.onchange = function() {
                        const columnIndex = parseInt(this.value);
                        if (isNaN(columnIndex)) return;
                        
                        // Extraire les UUIDs de la colonne s√©lectionn√©e (ignorer la premi√®re ligne = en-t√™te)
                        const uuids = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const cellValue = jsonData[i][columnIndex];
                            if (cellValue) {
                                // Nettoyer la valeur (enlever espaces, etc.)
                                const uuid = String(cellValue).trim();
                                if (uuid) uuids.push(uuid);
                            }
                        }
                        
                        // Cocher les utilisateurs correspondants
                        let found = 0;
                        const checkboxes = usersTableBody.querySelectorAll('.user-checkbox');
                        checkboxes.forEach(cb => {
                            const row = cb.closest('.user-row');
                            const uid = row.dataset.uid;
                            if (uuids.includes(uid)) {
                                cb.checked = true;
                                found++;
                            }
                        });
                        
                        updateSelectedCount();
                        document.getElementById('excel-info').textContent = `${found} utilisateur(s) trouv√©(s) et s√©lectionn√©(s) sur ${uuids.length} UUID(s) dans le fichier.`;
                        
                        if (found < uuids.length) {
                            alert(`‚ö†Ô∏è ${uuids.length - found} UUID(s) du fichier n'ont pas √©t√© trouv√©s dans la liste des utilisateurs.`);
                        }
                    };
                } catch (error) {
                    alert('‚ùå Erreur lors de la lecture du fichier Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }
    
    // Initialiser le compteur
    updateSelectedCount();
});
</script>
{% endblock %}
