{% extends 'scripts_manager/base.html' %}

{% block title %}Notifications Push - Butter{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ tab: 'all' }">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h1 class="text-3xl font-serif font-bold text-base-content mb-2">üì± Envoi de Notifications Push</h1>
            <p class="text-secondary">Envoyez des notifications √† vos utilisateurs</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="card bg-base-100 shadow-sm border border-base-300 overflow-hidden">
        <div class="tabs tabs-boxed bg-base-100 rounded-none border-b border-base-300 p-0">
            <button @click="tab = 'all'" class="tab tab-lg flex-1" :class="tab === 'all' && 'tab-active'">
                üì¢ √Ä tous
            </button>
            <button @click="tab = 'personalized'" class="tab tab-lg flex-1" :class="tab === 'personalized' && 'tab-active'">
                üë§ Personnalis√©es
            </button>
            <button @click="tab = 'group'" class="tab tab-lg flex-1" :class="tab === 'group' && 'tab-active'">
                üë• Groupe
            </button>
        </div>

        <div class="card-body">
            <!-- Tab: √Ä tous -->
            <div x-show="tab === 'all'" x-transition>
                <form id="form-all" class="space-y-4 max-w-2xl">
                    <div>
                        <label for="title-all" class="label">
                            <span class="label-text text-base-content font-medium">Titre *</span>
                        </label>
                        <input type="text" id="title-all" name="title" required
                               placeholder="Ex: Nouvelle fonctionnalit√© disponible"
                               class="input input-bordered w-full bg-base-200">
                    </div>

                    <div>
                        <label for="body-all" class="label">
                            <span class="label-text text-base-content font-medium">Message *</span>
                        </label>
                        <textarea id="body-all" name="body" required rows="4"
                                  placeholder="Ex: D√©couvrez notre nouvelle fonctionnalit√©..."
                                  class="textarea textarea-bordered w-full bg-base-200"></textarea>
                    </div>

                    <div>
                        <label for="data-all" class="label">
                            <span class="label-text text-base-content font-medium">Donn√©es suppl√©mentaires (JSON, optionnel)</span>
                        </label>
                        <textarea id="data-all" name="data" rows="3"
                                  placeholder='{"type": "feature", "id": "123"}'
                                  class="textarea textarea-bordered w-full bg-base-200 font-mono text-sm"></textarea>
                        <label class="label">
                            <span class="label-text-alt text-secondary">Format JSON valide requis</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        üì§ Envoyer √† tous les utilisateurs
                    </button>
                </form>
            </div>

            <!-- Tab: Personnalis√©es -->
            <div x-show="tab === 'personalized'" x-transition>
                <form id="form-personalized" class="space-y-4 max-w-2xl">
                    <div>
                        <label for="title-personalized" class="label">
                            <span class="label-text text-base-content font-medium">Titre * (utilisez {prenom} pour personnaliser)</span>
                        </label>
                        <input type="text" id="title-personalized" name="title" required
                               placeholder='Ex: Salut {prenom} !'
                               class="input input-bordered w-full bg-base-200">
                    </div>

                    <div>
                        <label for="body-personalized" class="label">
                            <span class="label-text text-base-content font-medium">Message * (utilisez {prenom} pour personnaliser)</span>
                        </label>
                        <textarea id="body-personalized" name="body" required rows="4"
                                  placeholder='Ex: {prenom}, d√©couvrez notre nouvelle fonctionnalit√©...'
                                  class="textarea textarea-bordered w-full bg-base-200"></textarea>
                    </div>

                    <div>
                        <label for="data-personalized" class="label">
                            <span class="label-text text-base-content font-medium">Donn√©es suppl√©mentaires (JSON, optionnel)</span>
                        </label>
                        <textarea id="data-personalized" name="data" rows="3"
                                  placeholder='{"type": "feature", "id": "123"}'
                                  class="textarea textarea-bordered w-full bg-base-200 font-mono text-sm"></textarea>
                        <label class="label">
                            <span class="label-text-alt text-secondary">Format JSON valide requis</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        üë§ Envoyer des notifications personnalis√©es
                    </button>
                </form>
            </div>

            <!-- Tab: Groupe -->
            <div x-show="tab === 'group'" x-transition>
                <form id="form-group" class="space-y-4">
                    <!-- Recherche et Import Excel -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="user-search" class="label">
                                <span class="label-text text-base-content font-medium">üîç Rechercher un utilisateur</span>
                            </label>
                            <input type="text" id="user-search"
                                   placeholder="Rechercher par nom, UUID, RevenueCat ID ou t√©l√©phone..."
                                   class="input input-bordered w-full bg-base-200">
                        </div>
                        <div>
                            <label for="excel-upload" class="label">
                                <span class="label-text text-base-content font-medium">üìä Importer depuis Excel</span>
                            </label>
                            <div class="flex gap-2">
                                <input type="file" id="excel-upload" accept=".xlsx,.xls"
                                       class="hidden">
                                <button type="button" onclick="document.getElementById('excel-upload').click()"
                                        class="btn btn-ghost flex-1 bg-base-200">
                                    üìÅ Choisir fichier
                                </button>
                                <select id="excel-id-type"
                                        class="select select-bordered bg-base-200">
                                    <option value="uid">Colonne UUID Firebase</option>
                                    <option value="revenuecat">Colonne RevenueCat ID</option>
                                </select>
                                <select id="excel-column"
                                        class="select select-bordered bg-base-200">
                                    <option value="">S√©lectionner colonne</option>
                                </select>
                            </div>
                            <label class="label">
                                <span class="label-text-alt text-secondary" id="excel-info"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Tableau des utilisateurs -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="label">
                                <span class="label-text text-base-content font-medium">S√©lectionner les utilisateurs *</span>
                            </label>
                            <span id="selected-count" class="text-sm text-secondary">0 s√©lectionn√©(s)</span>
                        </div>
                        <div class="border border-base-300 rounded-lg overflow-hidden bg-base-200 max-h-[400px] overflow-y-auto">
                            <table class="table table-zebra w-full">
                                <thead class="bg-base-300 sticky top-0">
                                    <tr>
                                        <th class="w-12">
                                            <input type="checkbox" id="select-all" class="checkbox checkbox-primary checkbox-sm">
                                        </th>
                                        <th>Pr√©nom</th>
                                        <th>UUID</th>
                                        <th>RevenueCat ID</th>
                                        <th>üì± T√©l√©phone</th>
                                        <th>‚úâÔ∏è Email</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table-body">
                                    {% for user in users %}
                                    <tr class="user-row hover" data-uid="{{ user.uid }}" data-prenom="{{ user.prenom|lower }}" data-phone="{{ user.phone|lower }}" data-email="{{ user.email|lower }}" data-app-user-id="{{ user.app_user_id|lower }}">
                                        <td>
                                            <input type="checkbox" class="user-checkbox checkbox checkbox-primary checkbox-sm" value="{{ user.uid }}">
                                        </td>
                                        <td class="text-sm text-base-content">{{ user.prenom }}</td>
                                        <td class="text-sm text-base-content font-mono">{{ user.uid }}</td>
                                        <td class="text-sm text-base-content font-mono text-xs">{{ user.app_user_id|default:"‚Äî" }}</td>
                                        <td class="text-sm text-base-content">{{ user.phone }}</td>
                                        <td class="text-sm text-base-content">{{ user.email }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div>
                        <label for="title-group" class="label">
                            <span class="label-text text-base-content font-medium">Titre *</span>
                        </label>
                        <input type="text" id="title-group" name="title" required
                               placeholder="Ex: Notification sp√©ciale"
                               class="input input-bordered w-full bg-base-200">
                    </div>

                    <div>
                        <label for="body-group" class="label">
                            <span class="label-text text-base-content font-medium">Message *</span>
                        </label>
                        <textarea id="body-group" name="body" required rows="4"
                                  placeholder="Ex: Message pour le groupe s√©lectionn√©..."
                                  class="textarea textarea-bordered w-full bg-base-200"></textarea>
                    </div>

                    <div>
                        <label for="data-group" class="label">
                            <span class="label-text text-base-content font-medium">Donn√©es suppl√©mentaires (JSON, optionnel)</span>
                        </label>
                        <textarea id="data-group" name="data" rows="3"
                                  placeholder='{"type": "group", "id": "123"}'
                                  class="textarea textarea-bordered w-full bg-base-200 font-mono text-sm"></textarea>
                        <label class="label">
                            <span class="label-text-alt text-secondary">Format JSON valide requis</span>
                        </label>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        üë• Envoyer au groupe s√©lectionn√©
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="results" class="hidden card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h3 class="text-xl font-serif font-bold text-base-content mb-4">üìä R√©sultats de l'envoi</h3>
            <div id="results-content" class="space-y-2"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SheetJS pour parser Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
let allUsers = [
    {% for user in users %}
    {
        uid: "{{ user.uid }}",
        prenom: "{{ user.prenom }}",
        phone: "{{ user.phone }}",
        email: "{{ user.email }}",
        app_user_id: "{{ user.app_user_id|default:'' }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Form submissions
document.getElementById('form-all').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('all', '{% url "scripts_manager:send_notification_to_all" %}');
});

document.getElementById('form-personalized').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('personalized', '{% url "scripts_manager:send_notification_to_all_with_prenom" %}');
});

document.getElementById('form-group').addEventListener('submit', async (e) => {
    e.preventDefault();
    await sendNotification('group', '{% url "scripts_manager:send_notification_to_group" %}');
});

async function sendNotification(tab, endpoint) {
    const form = document.getElementById(`form-${tab}`);
    const formData = new FormData(form);

    const data = {
        title: formData.get('title'),
        body: formData.get('body'),
    };

    // Parse JSON data if provided
    const dataField = formData.get('data');
    if (dataField && dataField.trim()) {
        try {
            data.data = JSON.parse(dataField);
        } catch (e) {
            alert('‚ùå Erreur: Les donn√©es suppl√©mentaires doivent √™tre au format JSON valide');
            return;
        }
    }

    // For group tab, get selected user IDs from checkboxes
    if (tab === 'group') {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        const selectedUsers = Array.from(checkboxes).map(cb => cb.value);
        if (selectedUsers.length === 0) {
            alert('‚ùå Veuillez s√©lectionner au moins un utilisateur');
            return;
        }
        data.userIds = selectedUsers;
    }

    // Show loading
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Envoi en cours...';
    showLoading();

    try {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
            showResults(result);
        } else {
            alert(`‚ùå Erreur: ${result.error || result.details || 'Erreur inconnue'}`);
        }
    } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        hideLoading();
    }
}

function showResults(result) {
    const resultsDiv = document.getElementById('results');
    const resultsContent = document.getElementById('results-content');

    resultsContent.innerHTML = `
        <div class="space-y-2">
            <p><strong>‚úÖ Succ√®s:</strong> <span class="text-success font-semibold">${result.successCount}</span> notification(s) envoy√©e(s)</p>
            <p><strong>‚ùå √âchecs:</strong> <span class="text-error font-semibold">${result.failureCount}</span> notification(s) √©chou√©e(s)</p>
            <p><strong>üì± Total:</strong> <span class="text-secondary font-semibold">${result.totalTokens || (result.successCount + result.failureCount)}</span> token(s) trait√©(s)</p>
            ${result.invalidUsers ? `<p><strong>‚ö†Ô∏è Utilisateurs invalides:</strong> ${result.invalidUsers.length}</p>` : ''}
        </div>
    `;

    resultsDiv.classList.remove('hidden');
    resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

// Recherche d'utilisateurs
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('user-search');
    const selectAllCheckbox = document.getElementById('select-all');
    const usersTableBody = document.getElementById('users-table-body');
    const selectedCountSpan = document.getElementById('selected-count');
    const excelUpload = document.getElementById('excel-upload');
    const excelColumn = document.getElementById('excel-column');
    const excelIdType = document.getElementById('excel-id-type');

    // Recherche en temps r√©el
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const rows = usersTableBody.querySelectorAll('.user-row');

            rows.forEach(row => {
                const prenom = row.dataset.prenom || '';
                const uid = row.dataset.uid || '';
                const phone = row.dataset.phone || '';
                const email = row.dataset.email || '';
                const appUserId = row.dataset.appUserId || '';

                const matches = !searchTerm ||
                    prenom.includes(searchTerm) ||
                    uid.toLowerCase().includes(searchTerm) ||
                    phone.includes(searchTerm) ||
                    email.includes(searchTerm) ||
                    appUserId.includes(searchTerm);

                row.style.display = matches ? '' : 'none';
            });
        });
    }

    // S√©lectionner/D√©s√©lectionner tout
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(e) {
            const checkboxes = usersTableBody.querySelectorAll('.user-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('.user-row').style.display !== 'none') {
                    cb.checked = e.target.checked;
                }
            });
            updateSelectedCount();
        });
    }

    // Mettre √† jour le compteur de s√©lection
    function updateSelectedCount() {
        const checked = usersTableBody.querySelectorAll('.user-checkbox:checked').length;
        selectedCountSpan.textContent = `${checked} s√©lectionn√©(s)`;

        // Mettre √† jour la checkbox "Tout s√©lectionner"
        const visibleCheckboxes = Array.from(usersTableBody.querySelectorAll('.user-checkbox'))
            .filter(cb => cb.closest('.user-row').style.display !== 'none');
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked).length;
        selectAllCheckbox.checked = visibleCheckboxes.length > 0 && checkedVisible === visibleCheckboxes.length;
        selectAllCheckbox.indeterminate = checkedVisible > 0 && checkedVisible < visibleCheckboxes.length;
    }

    // √âcouter les changements sur les checkboxes individuelles
    if (usersTableBody) {
        usersTableBody.addEventListener('change', function(e) {
            if (e.target.classList.contains('user-checkbox')) {
                updateSelectedCount();
            }
        });
    }

    // Import Excel
    if (excelUpload) {
        excelUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Prendre la premi√®re feuille
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length === 0) {
                        alert('‚ùå Le fichier Excel est vide');
                        return;
                    }

                    // Remplir le select des colonnes avec les en-t√™tes
                    const headers = jsonData[0];
                    excelColumn.innerHTML = '<option value="">S√©lectionner une colonne</option>';
                    headers.forEach((header, index) => {
                        if (header) {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = header;
                            excelColumn.appendChild(option);
                        }
                    });

                    const idType = excelIdType.value;
                    const idTypeLabel = idType === 'revenuecat' ? 'RevenueCat ID' : 'UUID Firebase';
                    document.getElementById('excel-info').textContent = `${jsonData.length - 1} lignes trouv√©es. S√©lectionnez la colonne contenant les ${idTypeLabel}s.`;

                    // Quand une colonne est s√©lectionn√©e, s√©lectionner les utilisateurs
                    excelColumn.onchange = function() {
                        const columnIndex = parseInt(this.value);
                        if (isNaN(columnIndex)) return;

                        const idType = excelIdType.value;

                        // Extraire les IDs de la colonne s√©lectionn√©e (ignorer la premi√®re ligne = en-t√™te)
                        const ids = [];
                        for (let i = 1; i < jsonData.length; i++) {
                            const cellValue = jsonData[i][columnIndex];
                            if (cellValue) {
                                // Nettoyer la valeur (enlever espaces, etc.)
                                const id = String(cellValue).trim();
                                if (id) ids.push(id);
                            }
                        }

                        // Cocher les utilisateurs correspondants
                        let found = 0;
                        const checkboxes = usersTableBody.querySelectorAll('.user-checkbox');
                        checkboxes.forEach(cb => {
                            const row = cb.closest('.user-row');
                            let matchId;
                            if (idType === 'revenuecat') {
                                matchId = row.dataset.appUserId || '';
                            } else {
                                matchId = row.dataset.uid || '';
                            }

                            if (ids.includes(matchId)) {
                                cb.checked = true;
                                found++;
                            }
                        });

                        updateSelectedCount();
                        const idTypeLabel = idType === 'revenuecat' ? 'RevenueCat ID' : 'UUID Firebase';
                        document.getElementById('excel-info').textContent = `${found} utilisateur(s) trouv√©(s) et s√©lectionn√©(s) sur ${ids.length} ${idTypeLabel}(s) dans le fichier.`;

                        if (found < ids.length) {
                            alert(`‚ö†Ô∏è ${ids.length - found} ${idTypeLabel}(s) du fichier n'ont pas √©t√© trouv√©s dans la liste des utilisateurs.`);
                        }
                    };

                    // Mettre √† jour le message quand le type d'ID change
                    excelIdType.onchange = function() {
                        const idType = this.value;
                        const idTypeLabel = idType === 'revenuecat' ? 'RevenueCat ID' : 'UUID Firebase';
                        if (jsonData && jsonData.length > 0) {
                            document.getElementById('excel-info').textContent = `${jsonData.length - 1} lignes trouv√©es. S√©lectionnez la colonne contenant les ${idTypeLabel}s.`;
                        }
                    };
                } catch (error) {
                    alert('‚ùå Erreur lors de la lecture du fichier Excel: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // Initialiser le compteur
    updateSelectedCount();
});
</script>
{% endblock %}
