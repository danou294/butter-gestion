{% extends "scripts_manager/base.html" %}
{% load static %}

{% block title %}
    {% if mode == 'create' %}Créer un guide{% else %}Éditer {{ guide.name }}{% endif %} - Butter Backoffice
{% endblock %}

{% block content %}
<div class="space-y-6" x-data="guideFormManager()">
    <!-- Header / Fil d'Ariane -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <nav class="text-sm text-secondary mb-2">
                <a href="{% url 'scripts_manager:guides_list' %}" class="hover:text-base-content">Guides</a>
                {% if mode == 'edit' %}
                <span class="mx-1">/</span>
                <a href="{% url 'scripts_manager:guide_detail' guide_id %}" class="hover:text-base-content">{{ guide.name }}</a>
                <span class="mx-1">/</span>
                <span class="text-base-content">Éditer</span>
                {% else %}
                <span class="mx-1">/</span>
                <span class="text-base-content">Nouveau</span>
                {% endif %}
            </nav>
            <h1 class="text-3xl font-serif font-bold text-base-content">
                {% if mode == 'create' %}Créer un nouveau guide{% else %}Éditer : {{ guide.name }}{% endif %}
                {% if mode == 'edit' and guide.isPremium %}<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-amber-100 text-amber-800">Premium</span>{% endif %}
            </h1>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Formulaire -->
        <div class="lg:col-span-2">
            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        {% if mode == 'create' %}
                        <div class="mb-4">
                            <label for="id" class="block text-sm font-medium text-secondary mb-1">ID du guide <span class="text-error">*</span></label>
                            <input type="text" id="id" name="id" value="{% if form_data %}{{ form_data.id }}{% endif %}" required pattern="[A-Z0-9_]+" placeholder="MACHOC, SUSHI..."
                                   class="input input-bordered w-full bg-base-200 uppercase">
                            <p class="mt-1 text-xs text-secondary">Identifiant unique en MAJUSCULES. Exemple : MACHOC, NOUVEAUX</p>
                        </div>
                        {% else %}
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-secondary mb-1">ID du guide</label>
                            <input type="text" value="{{ guide.id }}" disabled class="input input-bordered w-full bg-base-200 text-secondary">
                        </div>
                        {% endif %}

                        <div class="mb-4">
                            <label for="city" class="block text-sm font-medium text-secondary mb-1">Ville <span class="text-error">*</span></label>
                            <select id="city" name="city" x-model="selectedCity" @change="onCityChanged()"
                                    class="select select-bordered w-full max-w-xs bg-base-200">
                                <option value="Paris">Paris</option>
                                <option value="Marrakech">Marrakech</option>
                            </select>
                            <p class="mt-1 text-xs text-secondary">La liste des restaurants sera filtrée par ville.</p>
                        </div>

                        <div class="mb-4">
                            <label for="name" class="block text-sm font-medium text-secondary mb-1">Nom du guide <span class="text-error">*</span></label>
                            <input type="text" id="name" name="name" value="{% if mode == 'edit' %}{{ guide.name }}{% elif form_data %}{{ form_data.name }}{% endif %}" required maxlength="100" placeholder="Best mousse au chocolat"
                                   class="input input-bordered w-full bg-base-200">
                        </div>

                        <div class="mb-4">
                            <label for="description" class="block text-sm font-medium text-secondary mb-1">Description</label>
                            <textarea id="description" name="description" rows="4" maxlength="500" placeholder="Description du guide..."
                                      class="textarea textarea-bordered w-full bg-base-200">{% if mode == 'edit' %}{{ guide.description }}{% elif form_data %}{{ form_data.description }}{% endif %}</textarea>
                        </div>

                        <div class="mb-4">
                            <label for="coverImageRef" class="block text-sm font-medium text-secondary mb-1">Photo de couverture</label>
                            <input type="text" id="coverImageRef" name="coverImageRef" value="{% if mode == 'edit' %}{{ guide.coverImageRef }}{% elif form_data %}{{ form_data.coverImageRef }}{% endif %}" placeholder="CHEJ3, DAME2..."
                                   class="input input-bordered w-full bg-base-200">
                            <p class="mt-1 text-xs text-secondary">Référence image (ex: CHEJ3). Doit exister dans Firebase Storage.</p>
                        </div>

                        <!-- Restaurants : recherche + sélection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-secondary mb-1">
                                Restaurants <span class="text-error">*</span>
                                <span class="badge badge-sm ml-2" x-text="selectedIds.length + ' sélectionné(s)'"></span>
                            </label>

                            <!-- Recherche -->
                            <input type="text"
                                   x-model="searchQuery"
                                   @input="filterRestaurants()"
                                   placeholder="Rechercher un restaurant par nom..."
                                   class="input input-bordered w-full bg-base-200 mb-2">

                            <!-- Résultats de recherche -->
                            <div x-show="searchQuery.length > 0 && filteredRestaurants.length > 0"
                                 class="max-h-48 overflow-y-auto border border-base-300 rounded-lg bg-white mb-3">
                                <template x-for="r in filteredRestaurants" :key="r.id">
                                    <button type="button"
                                            @click="addRestaurant(r)"
                                            class="flex items-center justify-between w-full px-4 py-2 hover:bg-base-200 transition-colors text-left border-b border-base-200 last:border-b-0"
                                            :class="{ 'opacity-40 cursor-not-allowed': selectedIds.includes(r.id) }">
                                        <div>
                                            <span class="font-medium text-sm" x-text="r.name"></span>
                                            <span class="text-xs text-gray-400 ml-2" x-text="r.id"></span>
                                            <span class="text-xs text-gray-400 ml-1" x-text="r.cuisine"></span>
                                        </div>
                                        <span x-show="selectedIds.includes(r.id)" class="text-xs text-success">deja ajoute</span>
                                        <span x-show="!selectedIds.includes(r.id)" class="text-xs text-primary">+ ajouter</span>
                                    </button>
                                </template>
                            </div>
                            <div x-show="searchQuery.length > 0 && filteredRestaurants.length === 0"
                                 class="p-3 text-sm text-gray-400 border border-base-300 rounded-lg mb-3">
                                Aucun restaurant trouve pour cette ville.
                            </div>

                            <!-- Restaurants sélectionnés -->
                            <div class="space-y-1" x-show="selectedIds.length > 0">
                                <template x-for="(id, index) in selectedIds" :key="id">
                                    <div class="flex items-center gap-2 p-2 bg-base-200 rounded-lg">
                                        <span class="text-xs font-bold text-gray-400 w-5 text-center" x-text="index + 1"></span>
                                        <div class="flex-1 min-w-0">
                                            <span class="font-medium text-sm" x-text="restaurantNames[id] || id"></span>
                                            <span class="text-xs text-gray-400 ml-1" x-text="id"></span>
                                        </div>
                                        <button type="button" @click="moveUp(index)"
                                                class="btn btn-ghost btn-xs" :disabled="index === 0">↑</button>
                                        <button type="button" @click="moveDown(index)"
                                                class="btn btn-ghost btn-xs" :disabled="index === selectedIds.length - 1">↓</button>
                                        <button type="button" @click="removeRestaurant(index)"
                                                class="btn btn-ghost btn-xs text-error">✕</button>
                                    </div>
                                </template>
                            </div>

                            <!-- Hidden input pour le formulaire (IDs comma-separated) -->
                            <input type="hidden" name="restaurantIds" :value="selectedIds.join(', ')">
                        </div>

                        <div class="mb-4 p-4 rounded-lg border border-amber-200 bg-amber-50">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="isPremium" name="isPremium"
                                       {% if mode == 'edit' and guide.isPremium %}checked{% elif form_data and form_data.isPremium %}checked{% endif %}
                                       class="checkbox checkbox-primary">
                                <div>
                                    <span class="text-sm font-medium text-base-content">Ce guide est Premium</span>
                                    <p class="text-xs text-secondary">Les utilisateurs non-premium verront un paywall au lieu du contenu.</p>
                                </div>
                            </label>
                        </div>

                        <div class="mb-4 p-4 rounded-lg border border-pink-200 bg-pink-50">
                            <label class="flex items-center gap-3 cursor-pointer">
                                <input type="checkbox" id="isFeatured" name="isFeatured"
                                       {% if mode == 'edit' and guide.isFeatured %}checked{% elif form_data and form_data.isFeatured %}checked{% endif %}
                                       class="checkbox checkbox-secondary">
                                <div>
                                    <span class="text-sm font-medium text-base-content">Coup de coeur de la semaine</span>
                                    <p class="text-xs text-secondary">Les restaurants de ce guide apparaitront dans le carousel "Coups de coeur" en haut de la page Guides.</p>
                                </div>
                            </label>
                        </div>

                        <div class="mb-6">
                            <label for="order" class="block text-sm font-medium text-secondary mb-1">Ordre d'affichage</label>
                            <input type="number" id="order" name="order" value="{% if mode == 'edit' %}{{ guide.order }}{% elif form_data %}{{ form_data.order|default:0 }}{% else %}0{% endif %}" min="0" max="1000"
                                   class="input input-bordered bg-base-200 w-32">
                        </div>

                        <div class="flex gap-3 justify-end">
                            <a href="{% url 'scripts_manager:guides_list' %}" class="btn btn-ghost">Annuler</a>
                            <button type="submit" class="btn btn-primary">{% if mode == 'create' %}Créer le guide{% else %}Enregistrer{% endif %}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Aide -->
        <div>
            <div class="card bg-base-200 border border-base-300">
                <div class="card-body">
                    <h3 class="font-serif font-bold text-base-content mb-3">Aide</h3>
                    <p class="text-sm text-secondary mb-3">Structure d'un guide : ID unique, nom, description, photo, liste ordonnee de restaurants.</p>
                    <p class="text-sm text-secondary mb-3">Format photo : <code class="bg-base-100 px-1 rounded">TAG + NUMERO</code> (ex: CHEJ3).</p>
                    <p class="text-sm text-secondary mb-3">Selectionnez une ville pour filtrer les restaurants disponibles.</p>
                    {% if mode == 'edit' %}
                    <hr class="border-base-300 my-3">
                    <p class="text-xs text-secondary">Cree : {{ guide.createdAt|date:"d/m/Y H:i" }}</p>
                    <p class="text-xs text-secondary">Modifie : {{ guide.updatedAt|date:"d/m/Y H:i" }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function guideFormManager() {
    const allRestaurants = {{ all_restaurants|safe }};

    // IDs initiaux (edit mode)
    {% if mode == 'edit' and guide.restaurantIds %}
    const initialIds = {{ guide.restaurantIds|safe }};
    const initialCity = '{{ guide.city|default:"Paris"|escapejs }}';
    {% elif form_data %}
    const initialIdsRaw = '{{ form_data.restaurantIds|default:""|escapejs }}';
    const initialIds = initialIdsRaw ? initialIdsRaw.split(/[,\s]+/).map(s => s.trim()).filter(Boolean) : [];
    const initialCity = '{{ form_data.city|default:"Paris"|escapejs }}';
    {% else %}
    const initialIds = [];
    const initialCity = 'Paris';
    {% endif %}

    // Construire un map nom par ID
    const nameMap = {};
    for (const r of allRestaurants) {
        nameMap[r.id] = r.name;
    }

    return {
        selectedCity: initialCity,
        selectedIds: [...initialIds],
        restaurantNames: nameMap,
        allRestaurants: allRestaurants,
        searchQuery: '',
        filteredRestaurants: [],

        onCityChanged() {
            this.searchQuery = '';
            this.filteredRestaurants = [];
        },

        filterRestaurants() {
            const q = this.searchQuery.toLowerCase().trim();
            if (q.length === 0) {
                this.filteredRestaurants = [];
                return;
            }
            this.filteredRestaurants = this.allRestaurants
                .filter(r => r.city === this.selectedCity)
                .filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q))
                .slice(0, 15);
        },

        addRestaurant(r) {
            if (this.selectedIds.includes(r.id)) return;
            this.selectedIds.push(r.id);
            this.searchQuery = '';
            this.filteredRestaurants = [];
        },

        removeRestaurant(index) {
            this.selectedIds.splice(index, 1);
        },

        moveUp(index) {
            if (index === 0) return;
            const temp = this.selectedIds[index];
            this.selectedIds[index] = this.selectedIds[index - 1];
            this.selectedIds[index - 1] = temp;
        },

        moveDown(index) {
            if (index >= this.selectedIds.length - 1) return;
            const temp = this.selectedIds[index];
            this.selectedIds[index] = this.selectedIds[index + 1];
            this.selectedIds[index + 1] = temp;
        },
    };
}

document.getElementById('id')?.addEventListener('input', function() { this.value = this.value.toUpperCase(); });
</script>
{% endblock %}
