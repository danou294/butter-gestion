{% extends "scripts_manager/base.html" %}
{% load static %}

{% block title %}{{ guide.name }} - Butter Backoffice{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ deleteOpen: false }">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <nav class="text-sm text-secondary mb-2">
                <a href="{% url 'scripts_manager:guides_list' %}" class="hover:text-base-content">Guides</a>
                <span class="mx-1">/</span>
                <span class="text-base-content">{{ guide.name }}</span>
            </nav>
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <h1 class="text-3xl font-serif font-bold text-base-content">
                    {{ guide.name }}
                    <span class="ml-2 badge badge-ghost">{{ guide.id }}</span>
                    {% if guide.isPremium %}<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-amber-100 text-amber-800">Premium</span>{% endif %}
                    {% if guide.isFeatured %}<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium bg-pink-100 text-pink-800">Coup de coeur</span>{% endif %}
                </h1>
                <div class="flex flex-wrap gap-2">
                    <a href="{% url 'scripts_manager:guide_edit' guide.id %}" class="btn btn-ghost">âœï¸ Ã‰diter</a>
                    <a href="{% url 'scripts_manager:guide_get_json' guide.id %}" class="btn btn-outline btn-success btn-sm" target="_blank">JSON</a>
                    <button type="button" @click="deleteOpen = true" class="btn btn-outline btn-error btn-sm">ğŸ—‘ Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Infos + Photo -->
        <div class="space-y-6">
            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <h3 class="font-serif font-bold text-base-content mb-4">Informations</h3>
                    <dl class="space-y-2 text-sm">
                        <div><dt class="text-secondary">ID</dt><dd><code class="bg-base-200 px-1 rounded">{{ guide.id }}</code></dd></div>
                        <div><dt class="text-secondary">Ordre</dt><dd><span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-base-200 text-secondary">{{ guide.order }}</span></dd></div>
                        <div><dt class="text-secondary">Photo</dt><dd>{% if guide.coverImageRef %}<code>{{ guide.coverImageRef }}</code>{% else %}-{% endif %}</dd></div>
                        <div><dt class="text-secondary">Type</dt><dd>{% if guide.isPremium %}<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Premium</span>{% else %}<span class="badge badge-success">Gratuit</span>{% endif %}</dd></div>
                        <div><dt class="text-secondary">Coup de coeur</dt><dd>{% if guide.isFeatured %}<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800">Oui</span>{% else %}<span class="text-secondary">Non</span>{% endif %}</dd></div>
                        <div><dt class="text-secondary">Restaurants</dt><dd><span class="badge badge-success">{{ restaurants|length }}</span></dd></div>
                        <div><dt class="text-secondary">CrÃ©Ã©</dt><dd>{{ guide.createdAt|date:"d/m/Y H:i" }}</dd></div>
                        <div><dt class="text-secondary">ModifiÃ©</dt><dd>{{ guide.updatedAt|date:"d/m/Y H:i" }}</dd></div>
                    </dl>
                </div>
            </div>

            {% if guide.coverImageRef and firebase_bucket %}
            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <h3 class="font-serif font-bold text-base-content mb-3">Photo de couverture</h3>
                    <p class="text-xs text-secondary mb-2">Photos restaurants/{{ guide.coverImageRef }}.webp</p>
                    <img src="https://firebasestorage.googleapis.com/v0/b/{{ firebase_bucket }}/o/Photos%20restaurants%2F{{ guide.coverImageRef }}.webp?alt=media"
                         alt="{{ guide.name }}" class="w-full rounded-lg border border-base-300"
                         onerror="this.src='https://via.placeholder.com/400x500?text=Image+non+trouv%C3%A9e'">
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Description + Restaurants -->
        <div class="lg:col-span-2 space-y-6">
            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <h3 class="font-serif font-bold text-base-content mb-3">Description</h3>
                    {% if guide.description %}
                    <p class="text-secondary">{{ guide.description }}</p>
                    {% else %}
                    <p class="text-secondary italic">Aucune description</p>
                    {% endif %}
                </div>
            </div>

            <div class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <h3 class="font-serif font-bold text-base-content mb-3">Restaurants <span class="badge badge-success">{{ restaurants|length }}</span></h3>
                    {% if restaurants %}
                    <p class="text-sm text-secondary mb-4">L'ordre dÃ©fini ici est respectÃ© dans l'app.</p>
                    <ul class="space-y-3">
                        {% for restaurant in restaurants %}
                        <li class="flex items-center justify-between gap-4 p-3 rounded-lg border border-base-300 bg-base-200">
                            <div>
                                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-base-300 text-neutral-content text-xs font-medium mr-2">{{ forloop.counter }}</span>
                                {% if restaurant.missing %}
                                <span class="text-error">{{ restaurant.name }}</span>
                                <br><small class="text-secondary"><code>{{ restaurant.id }}</code> â€” non trouvÃ©</small>
                                {% else %}
                                <strong class="text-base-content">{{ restaurant.name }}</strong>
                                <br><small class="text-secondary"><code>{{ restaurant.id }}</code>{% if restaurant.arrondissement %} â€¢ {{ restaurant.arrondissement }}{% endif %}{% if restaurant.address %} â€¢ {{ restaurant.address }}{% endif %}</small>
                                {% endif %}
                            </div>
                            {% if not restaurant.missing %}
                            <a href="{% url 'scripts_manager:restaurant_detail' restaurant.id %}" class="btn btn-ghost btn-sm" target="_blank">Voir</a>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-secondary">Aucun restaurant dans ce guide.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Modal suppression -->
    <div x-show="deleteOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-neutral bg-opacity-50 z-0" aria-hidden="true" @click="deleteOpen = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="relative z-10 inline-block align-bottom bg-base-100 text-left overflow-hidden shadow-xl border border-base-300 sm:my-8 sm:align-middle sm:max-w-lg sm:w-full" @click.stop>
                <div class="px-6 py-4">
                    <h3 class="text-lg font-serif font-bold text-base-content">Confirmer la suppression</h3>
                    <p class="mt-2 text-secondary">ÃŠtes-vous sÃ»r de vouloir supprimer le guide <strong>{{ guide.name }}</strong> ?</p>
                    <p class="mt-2 text-sm text-error">Cette action est irrÃ©versible.</p>
                </div>
                <div class="px-6 py-4 bg-base-200 flex justify-end gap-3">
                    <button type="button" @click="deleteOpen = false" class="btn btn-ghost">Annuler</button>
                    <form method="post" action="{% url 'scripts_manager:guide_delete' guide.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-error">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
