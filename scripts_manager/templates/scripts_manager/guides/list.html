{% extends "scripts_manager/base.html" %}
{% load static %}

{% block title %}Guides - Butter Backoffice{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ deleteOpen: false, deleteId: '', deleteName: '' }">
    <!-- Header avec actions -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-serif font-bold text-base-content mb-2">ğŸ“– Guides</h1>
                    <p class="text-secondary">
                        {{ total_count }} guide(s)
                        {% if premium_count %}<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">{{ premium_count }} Premium</span>{% endif %}
                        {% if free_count %}<span class="ml-2 badge badge-success">{{ free_count }} Gratuit</span>{% endif %}
                    </p>
                </div>
                <div class="flex flex-wrap gap-3">
                    <a href="{% url 'scripts_manager:guides_import_csv' %}" class="btn btn-ghost">
                        ğŸ“¤ Importer CSV
                    </a>
                    <a href="{% url 'scripts_manager:guide_create' %}" class="btn btn-primary">
                        â• Nouveau guide
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert {% if message.tags == 'error' %}alert-error{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Liste des guides -->
    {% if guides %}
    <div class="card bg-base-100 shadow-sm border border-base-300 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead class="bg-base-200 border-b border-base-300">
                    <tr>
                        <th class="text-left py-3 px-4 text-secondary font-medium w-16">Ordre</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium">Nom</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium w-24">Type</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium">ID</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium">Restaurants</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium w-36">Image</th>
                        <th class="text-left py-3 px-4 text-secondary font-medium w-48">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for guide in guides %}
                    <tr class="border-b border-base-300 hover:bg-base-200">
                        <td class="py-3 px-4">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-base-200 text-secondary text-sm font-medium">{{ guide.order }}</span>
                        </td>
                        <td class="py-3 px-4">
                            <strong class="text-base-content">{{ guide.name }}</strong>
                            {% if guide.isPremium %}<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">Premium</span>{% endif %}
                            {% if guide.isFeatured %}<span class="ml-1 inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-pink-100 text-pink-800">Coup de coeur</span>{% endif %}
                            {% if guide.description %}
                            <br>
                            <span class="text-sm text-secondary">{{ guide.description|truncatewords:15 }}</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            {% if guide.isPremium %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">Premium</span>
                            {% else %}
                            <span class="badge badge-success">Gratuit</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <code class="text-sm bg-base-200 px-2 py-1 rounded">{{ guide.id }}</code>
                        </td>
                        <td class="py-3 px-4">
                            <span class="badge badge-success">
                                {{ guide.restaurantIds|length }} resto(s)
                            </span>
                        </td>
                        <td class="py-3 px-4">
                            {% if guide.coverImageRef %}
                            <code class="text-xs text-secondary">{{ guide.coverImageRef }}</code>
                            {% else %}
                            <span class="text-secondary">-</span>
                            {% endif %}
                        </td>
                        <td class="py-3 px-4">
                            <div class="flex flex-wrap gap-2">
                                <a href="{% url 'scripts_manager:guide_detail' guide.id %}" class="btn btn-outline btn-secondary btn-sm" title="Voir">ğŸ‘ Voir</a>
                                <a href="{% url 'scripts_manager:guide_edit' guide.id %}" class="btn btn-outline btn-sm" title="Ã‰diter">âœï¸ Ã‰diter</a>
                                <a href="{% url 'scripts_manager:guide_get_json' guide.id %}" class="btn btn-outline btn-success btn-sm" title="JSON" target="_blank">JSON</a>
                                <button type="button" class="btn btn-outline btn-error btn-sm" title="Supprimer" @click="deleteOpen = true; deleteId = '{{ guide.id }}'; deleteName = '{{ guide.name|escapejs }}'">ğŸ—‘ Supprimer</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <div class="alert alert-success">
        Aucun guide pour le moment.
        <a href="{% url 'scripts_manager:guide_create' %}" class="font-medium text-success hover:underline ml-1">CrÃ©er le premier guide</a>
    </div>
    {% endif %}

    <!-- Modal de confirmation de suppression -->
    <div x-show="deleteOpen" x-cloak class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-neutral bg-opacity-50 transition-opacity" aria-hidden="true" @click.self="deleteOpen = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-base-100 text-left overflow-hidden shadow-xl border border-base-300 sm:my-8 sm:align-middle sm:max-w-lg sm:w-full" @click.stop>
                <div class="px-6 py-4">
                    <h3 class="text-lg font-serif font-bold text-base-content" id="modal-title">Confirmer la suppression</h3>
                    <p class="mt-2 text-secondary">ÃŠtes-vous sÃ»r de vouloir supprimer le guide <strong x-text="deleteName"></strong> ?</p>
                    <p class="mt-2 text-sm text-error">Cette action est irrÃ©versible.</p>
                </div>
                <div class="px-6 py-4 bg-base-200 flex justify-end gap-3">
                    <button type="button" @click="deleteOpen = false" class="btn btn-ghost">Annuler</button>
                    <form method="post" :action="'/guides/' + deleteId + '/delete/'" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-error">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
