{% extends 'scripts_manager/base.html' %}

{% block title %}Import Onboarding - Butter{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <!-- Navigation retour -->
    <div>
        <a href="{% url 'scripts_manager:onboarding_list' %}" class="text-secondary hover:text-base-content text-sm">
            ‚Üê Retour √† la liste
        </a>
    </div>

    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h1 class="text-3xl font-serif font-bold text-base-content mb-2">üì• Import Onboarding</h1>
            <p class="text-secondary">
                Importer les restaurants d'onboarding depuis un fichier Excel vers la collection
                <code class="bg-base-200 px-2 py-0.5 rounded text-sm">onboarding_restaurants</code>
            </p>
        </div>
    </div>

    {% if step == 'upload' %}
    <!-- √âtape 1 : Upload -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <div class="bg-base-200 rounded p-4 mb-6">
                <h3 class="font-medium text-base-content mb-2">Format attendu :</h3>
                <ul class="text-sm text-secondary space-y-1 list-disc list-inside">
                    <li><strong>Nom du restaurant</strong> ‚Äî Nom affich√©</li>
                    <li><strong>Tag</strong> ‚Äî Code court unique (ex: BENC, ALFR)</li>
                    <li><strong>Lieu</strong> ‚Äî Type : Restaurant, Coffee shop, ou Bar</li>
                    <li><strong>Sp√©cialit√©</strong> ‚Äî Cuisine (optionnel pour bars/coffee shops)</li>
                </ul>
            </div>

            <form method="POST" enctype="multipart/form-data" class="auto-loader">
                {% csrf_token %}

                <div class="border-2 border-dashed border-base-300 rounded p-8 text-center hover:border-secondary transition-colors">
                    <div class="text-4xl mb-3">üìÑ</div>
                    <p class="text-base-content font-medium mb-2">S√©lectionnez votre fichier Excel</p>
                    <p class="text-secondary text-sm mb-4">Formats accept√©s : .xlsx, .xls</p>
                    <input type="file" name="excel_file" accept=".xlsx,.xls" required
                           class="file-input file-input-bordered w-full bg-base-200">
                </div>

                <div class="mt-6 text-center">
                    <button type="submit" class="btn btn-primary text-lg px-8">
                        üîç Analyser le fichier
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% elif step == 'preview' %}
    <!-- √âtape 2 : Preview et confirmation -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="text-xl font-serif font-bold text-base-content mb-4">üìä R√©sultat de l'analyse</h2>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="bg-success/10 rounded p-3 text-center">
                    <div class="text-xl font-bold text-base-content">{{ report.valid_rows }}</div>
                    <div class="text-xs text-secondary">Valides</div>
                </div>
                <div class="bg-base-200 rounded p-3 text-center">
                    <div class="text-xl font-bold text-base-content">{{ report.total_rows }}</div>
                    <div class="text-xs text-secondary">Total lignes</div>
                </div>
                <div class="{% if report.skipped_rows > 0 %}bg-error/10{% else %}bg-base-200{% endif %} rounded p-3 text-center">
                    <div class="text-xl font-bold text-base-content">{{ report.skipped_rows }}</div>
                    <div class="text-xs text-secondary">Ignor√©es</div>
                </div>
                <div class="bg-base-200 rounded p-3 text-center">
                    <div class="text-xl font-bold text-base-content">{{ report.errors|length }}</div>
                    <div class="text-xs text-secondary">Erreurs</div>
                </div>
            </div>

            <!-- R√©partition par lieu -->
            {% if report.by_lieu %}
            <div class="mb-4">
                <h3 class="text-sm font-medium text-secondary mb-2">Par lieu :</h3>
                <div class="flex flex-wrap gap-2">
                    {% for lieu, count in report.by_lieu.items %}
                    <span class="badge badge-ghost">{{ lieu }} : {{ count }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- R√©partition par sp√©cialit√© -->
            {% if report.by_specialite %}
            <div class="mb-4">
                <h3 class="text-sm font-medium text-secondary mb-2">Par sp√©cialit√© :</h3>
                <div class="flex flex-wrap gap-2">
                    {% for spec, count in report.by_specialite.items %}
                    <span class="badge badge-ghost">{{ spec }} : {{ count }}</span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Erreurs -->
            {% if report.errors %}
            <div class="alert alert-error">
                <div>
                    <h3 class="font-medium mb-2">Avertissements :</h3>
                    <ul class="text-sm space-y-1 list-disc list-inside">
                        {% for error in report.errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Preview des donn√©es -->
    {% if records %}
    <div class="card bg-base-100 shadow-sm border border-base-300 overflow-hidden">
        <div class="p-4 bg-base-200 border-b border-base-300">
            <h3 class="font-medium text-base-content">{{ records|length }} restaurants √† importer</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th class="text-xs font-medium text-secondary uppercase">#</th>
                        <th class="text-xs font-medium text-secondary uppercase">Tag</th>
                        <th class="text-xs font-medium text-secondary uppercase">Nom</th>
                        <th class="text-xs font-medium text-secondary uppercase">Lieu</th>
                        <th class="text-xs font-medium text-secondary uppercase">Sp√©cialit√©</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr class="hover">
                        <td class="text-sm text-secondary">{{ forloop.counter }}</td>
                        <td><code class="badge badge-ghost text-xs">{{ record.tag }}</code></td>
                        <td class="font-medium text-base-content">{{ record.name }}</td>
                        <td class="text-sm text-secondary">{{ record.lieu }}</td>
                        <td class="text-sm text-secondary">{{ record.specialite|default:"‚Äî" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Boutons de confirmation -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <div class="alert alert-warning mb-4">
                <span>‚ö†Ô∏è L'import va <strong>remplacer</strong> tous les restaurants d'onboarding existants dans l'environnement actif.</span>
            </div>
            <div class="flex gap-3 justify-center">
                <form method="POST" action="{% url 'scripts_manager:onboarding_import_confirm' %}"
                      x-data x-on:submit.prevent="if(confirm('Confirmer l\'import de {{ records|length }} restaurants ?')) $el.submit()">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary text-lg px-8">
                        ‚úÖ Confirmer l'import
                    </button>
                </form>
                <a href="{% url 'scripts_manager:onboarding_import' %}" class="btn btn-ghost text-lg px-8">
                    ‚ùå Annuler
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}
