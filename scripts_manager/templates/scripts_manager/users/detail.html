{% extends 'scripts_manager/base.html' %}
{% load tz %}

{% block title %}Utilisateur {{ user.display_name }} - Butter{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .chart-container {
        position: relative;
        height: 300px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header avec bouton retour -->
    <div class="flex items-center justify-between">
        <div>
            <a href="{% url 'scripts_manager:users_list' %}" class="text-secondary hover:text-base-content mb-4 inline-block">
                ‚Üê Retour √† la liste
            </a>
            <h1 class="text-3xl font-serif font-bold text-base-content mb-2">{{ user.display_name|default:"N/A" }}</h1>
            <p class="text-secondary">{{ user.uid }}</p>
        </div>
        <div>
            <a href="{% url 'scripts_manager:user_refresh_revenuecat' user.uid %}"
               class="btn btn-primary">
                üîÑ Actualiser les donn√©es RevenueCat
            </a>
        </div>
    </div>

    <!-- Informations utilisateur -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-xl font-serif font-bold text-base-content">üë§ Informations</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <span class="text-sm text-secondary">Email:</span>
                    <div class="font-medium text-base-content">{{ user.email|default:"N/A" }}</div>
                </div>
                <div>
                    <span class="text-sm text-secondary">T√©l√©phone:</span>
                    <div class="font-medium text-base-content">{{ user.phone|default:"N/A" }}</div>
                </div>
                <div>
                    <span class="text-sm text-secondary">Date de cr√©ation:</span>
                    <div class="font-medium text-base-content">{{ user.created_at_display|default:"N/A" }}</div>
                </div>
                <div>
                    <span class="text-sm text-secondary">Derni√®re connexion:</span>
                    <div class="font-medium text-base-content">{{ user.last_sign_in_display|default:"Jamais" }}</div>
                </div>
                {% if user.birthdate %}
                <div>
                    <span class="text-sm text-secondary">Date de naissance:</span>
                    <div class="font-medium text-base-content">{{ user.birthdate }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statut RevenueCat actuel -->
    {% if current_status %}
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-xl font-serif font-bold text-base-content">üí≥ Statut RevenueCat</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <span class="text-sm text-secondary">Statut:</span>
                    <div class="mt-1">
                        <span class="badge {{ user.rc_status.status_class }} badge-lg">
                            {{ current_status.status_label }}
                        </span>
                        {% if current_status.is_sandbox %}
                        <span class="badge badge-warning badge-lg ml-2">
                            üß™ Sandbox
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if current_status.product_identifier %}
                <div>
                    <span class="text-sm text-secondary">Produit:</span>
                    <div class="font-medium text-base-content">{{ current_status.product_identifier }}</div>
                </div>
                {% endif %}
                {% if current_status.period_type %}
                <div>
                    <span class="text-sm text-secondary">Type de p√©riode:</span>
                    <div class="font-medium text-base-content">{{ current_status.period_type|upper }}</div>
                </div>
                {% endif %}
                <div>
                    <span class="text-sm text-secondary">Actif:</span>
                    <div class="font-medium text-base-content">
                        {% if current_status.is_active %}‚úÖ Oui{% else %}‚ùå Non{% endif %}
                    </div>
                </div>
                {% if current_status.expires_at %}
                <div>
                    <span class="text-sm text-secondary">Expire le:</span>
                    <div class="font-medium text-base-content">{{ current_status.expires_at|date:"d/m/Y √† H:i" }}</div>
                </div>
                {% endif %}
                {% if current_status.purchase_date %}
                <div>
                    <span class="text-sm text-secondary">Achet√© le:</span>
                    <div class="font-medium text-base-content">{{ current_status.purchase_date|date:"d/m/Y √† H:i" }}</div>
                </div>
                {% endif %}
                {% if current_status.will_renew %}
                <div>
                    <span class="text-sm text-secondary">Renouvellement:</span>
                    <div class="font-medium text-success">‚úÖ Automatique</div>
                </div>
                {% endif %}
                {% if current_status.grace_period_expires_at %}
                <div>
                    <span class="text-sm text-secondary">P√©riode de gr√¢ce expire le:</span>
                    <div class="font-medium text-base-content">{{ current_status.grace_period_expires_at|date:"d/m/Y √† H:i" }}</div>
                </div>
                {% endif %}
            </div>
            <div class="mt-4 text-xs text-secondary">
                <span>Derni√®re mise √† jour: {{ current_status.updated_at|date:"d/m/Y √† H:i" }}</span>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card bg-base-200 shadow-sm border border-base-300">
        <div class="card-body">
            <p class="text-secondary">Aucune donn√©e RevenueCat disponible pour cet utilisateur.</p>
        </div>
    </div>
    {% endif %}

    <!-- Graphique historique -->
    {% if history_count > 0 %}
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-xl font-serif font-bold text-base-content">üìä Historique des 30 derniers jours</h2>
            <div class="chart-container">
                <canvas id="revenuecatChart"></canvas>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card bg-base-200 shadow-sm border border-base-300">
        <div class="card-body">
            <p class="text-secondary">Aucun historique disponible. Les donn√©es seront enregistr√©es lors de la prochaine actualisation.</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
// Donn√©es du graphique
const chartData = {
    dates: JSON.parse('{{ chart_data.dates|escapejs }}' || '[]'),
    statuses: JSON.parse('{{ chart_data.statuses|escapejs }}' || '[]'),
    is_active: JSON.parse('{{ chart_data.is_active|escapejs }}' || '[]'),
    is_sandbox: JSON.parse('{{ chart_data.is_sandbox|escapejs }}' || '[]'),
};

// Mapping des statuts vers des couleurs
const statusColors = {
    'active': '#60BC81',
    'trial': '#60BC81',
    'grace': '#C9C1B1',
    'expired': '#D3695E',
    'none': '#535353',
};

// Cr√©er le graphique
if (chartData.dates.length > 0 && typeof Chart !== 'undefined') {
    const ctx = document.getElementById('revenuecatChart').getContext('2d');

    // Pr√©parer les donn√©es pour le graphique
    const backgroundColors = chartData.statuses.map(s => statusColors[s] || '#535353');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [
                {
                    label: 'Statut (is_active)',
                    data: chartData.is_active,
                    borderColor: '#60BC81',
                    backgroundColor: 'rgba(96, 188, 129, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y',
                },
                {
                    label: 'Sandbox',
                    data: chartData.is_sandbox,
                    borderColor: '#FFC107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const index = context.dataIndex;
                            const status = chartData.statuses[index];
                            const isActive = chartData.is_active[index];
                            const isSandbox = chartData.is_sandbox[index];
                            let label = context.dataset.label + ': ' + (isActive ? 'Actif' : 'Inactif');
                            if (context.datasetIndex === 0) {
                                label += ' | Statut: ' + status;
                            }
                            if (isSandbox && context.datasetIndex === 0) {
                                label += ' | üß™ Sandbox';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Valeur'
                    },
                    min: 0,
                    max: 1,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value === 1 ? 'Oui' : 'Non';
                        }
                    }
                }
            }
        }
    });
}
</script>
{% endblock %}
