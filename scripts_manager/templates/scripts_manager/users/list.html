{% extends 'scripts_manager/base.html' %}
{% load tz %}

{% block title %}Utilisateurs - Butter{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <h1 class="text-3xl font-serif font-bold text-[#111111] mb-2">üë• Utilisateurs</h1>
        <p class="text-[#535353]">Gestion et suivi des utilisateurs</p>
    </div>
    
    <!-- Metrics -->
    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
            <div class="text-2xl font-serif font-bold text-[#111111]">{{ metrics.total }}</div>
            <div class="text-sm text-[#535353] mt-1">Total</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#60BC81]">
            <div class="text-2xl font-serif font-bold text-[#60BC81]">{{ metrics.active }}</div>
            <div class="text-sm text-[#535353] mt-1">Premium</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#60BC81]">
            <div class="text-2xl font-serif font-bold text-[#60BC81]">{{ metrics.trial }}</div>
            <div class="text-sm text-[#535353] mt-1">Essais</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
            <div class="text-2xl font-serif font-bold text-[#535353]">{{ metrics.grace }}</div>
            <div class="text-sm text-[#535353] mt-1">Grace</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#D3695E]">
            <div class="text-2xl font-serif font-bold text-[#D3695E]">{{ metrics.expired }}</div>
            <div class="text-sm text-[#535353] mt-1">Expir√©s</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#60BC81]">
            <div class="text-2xl font-serif font-bold text-[#60BC81]">{{ metrics.online }}</div>
            <div class="text-sm text-[#535353] mt-1">En ligne</div>
        </div>
        <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
            <div class="text-2xl font-serif font-bold text-[#535353]">{{ metrics.tokens_total }}</div>
            <div class="text-sm text-[#535353] mt-1">Tokens</div>
        </div>
    </div>
    
    <!-- Search and Filters -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm p-6 border border-[#C9C1B1]">
        <form method="get" action="{% url 'scripts_manager:users_list' %}" class="space-y-4">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" name="q" value="{{ query }}" 
                           placeholder="Rechercher par nom, email, t√©l√©phone..."
                           class="w-full px-4 py-3 border border-[#C9C1B1] rounded-[14px] focus:ring-2 focus:ring-[#535353] focus:border-transparent bg-[#F1EFEB] text-[#111111]">
                </div>
                <button type="submit" class="btn-primary">
                    üîç Rechercher
                </button>
            </div>
            
            <div class="flex flex-wrap gap-2">
                {% for value, label in status_options %}
                <a href="?status={{ value }}{% if query %}&q={{ query }}{% endif %}" 
                   class="px-4 py-2 rounded-[14px] text-sm font-medium transition-colors {% if status_filter == value %}bg-[#C9C1B1] text-[#111111] border border-[#535353]{% else %}bg-[#F1EFEB] text-[#535353] hover:bg-[#C9C1B1] hover:text-[#111111] border border-[#C9C1B1]{% endif %}">
                    {{ label }}
                </a>
                {% endfor %}
            </div>
        </form>
    </div>
    
    <!-- Results Count -->
    <div class="text-sm text-[#535353]">
        {{ results_count }} r√©sultat{{ results_count|pluralize }} trouv√©{{ results_count|pluralize }}
    </div>
    
    <!-- Users Table -->
    <div class="bg-[#FFFFFF] rounded-[14px] shadow-sm border border-[#C9C1B1] overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#F1EFEB]">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Utilisateur</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Contact</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Connexion</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Statut RevenueCat</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-[#535353] uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-[#FFFFFF] divide-y divide-[#C9C1B1]">
                    {% for user in users %}
                    <tr class="hover:bg-[#F1EFEB] transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-[#111111]">{{ user.display_name|default:"N/A" }}</div>
                            <div class="text-sm text-[#535353]">{{ user.uid|truncatechars:20 }}</div>
                            {% if user.birthdate %}
                            <div class="text-xs text-[#535353] mt-1">üéÇ {{ user.birthdate }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-[#111111]">{{ user.email|default:"N/A" }}</div>
                            {% if user.phone %}
                            <div class="text-sm text-[#535353]">{{ user.phone }}</div>
                            {% endif %}
                            {% if user.has_fcm_token %}
                            <div class="text-xs text-[#60BC81] mt-1">üì± {{ user.fcm_tokens_count }} token{{ user.fcm_tokens_count|pluralize }}</div>
                            {% else %}
                            <div class="text-xs text-[#535353] mt-1">Pas de token</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-medium rounded-[14px] {{ user.connection_class }}">
                                {{ user.connection_label }}
                            </span>
                            {% if user.last_sign_in_display %}
                            <div class="text-xs text-[#535353] mt-1">{{ user.last_sign_in_display }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2">
                                <span class="px-3 py-1 text-xs font-medium rounded-[14px] {{ user.rc_status.status_class }}">
                                    {{ user.rc_status.status_label }}
                                </span>
                                {% if user.rc_status.expires_at %}
                                <span class="text-xs text-[#535353]">
                                    Jusqu'au {{ user.rc_status.expires_at|date:"d/m/Y" }}
                                </span>
                                {% endif %}
                            </div>
                            {% if user.rc_status.product_identifier %}
                            <div class="text-xs text-[#535353] mt-1">{{ user.rc_status.product_identifier }}</div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="refreshUserStatus('{{ user.uid }}', '{{ user.phone|default:"" }}')" 
                                    class="text-[#535353] hover:text-[#111111] font-medium transition-colors">
                                üîÑ Actualiser
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-[#535353]">
                            Aucun utilisateur trouv√©
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="flex items-center justify-between bg-[#FFFFFF] rounded-[14px] shadow-sm p-4 border border-[#C9C1B1]">
        <div class="text-sm text-[#535353]">
            Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}
        </div>
        <div class="flex gap-2">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" 
               class="btn-secondary">
                ‚Üê Pr√©c√©dent
            </a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" 
               class="btn-secondary">
                Suivant ‚Üí
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

{% if not revenuecat_enabled %}
<div class="mt-4 bg-[#F1EFEB] border border-[#C9C1B1] rounded-[14px] p-4">
    <p class="text-sm text-[#535353]">
        ‚ö†Ô∏è RevenueCat n'est pas configur√©. Les statuts premium ne seront pas affich√©s.
    </p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function refreshUserStatus(uid, phone) {
    if (!phone) {
        alert('‚ùå Aucun num√©ro de t√©l√©phone pour cet utilisateur');
        return;
    }
    
    showLoading();
    
    try {
        const formData = new FormData();
        formData.append('phone', phone);
        
        const response = await fetch(`/utilisateurs/${uid}/refresh/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData,
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Statut actualis√© avec succ√®s');
            location.reload();
        } else {
            alert(`‚ùå Erreur: ${data.error || 'Erreur inconnue'}`);
        }
    } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
    } finally {
        hideLoading();
    }
}
</script>
{% endblock %}
