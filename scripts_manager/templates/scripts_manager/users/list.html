{% extends 'scripts_manager/base.html' %}
{% load tz %}

{% block title %}Utilisateurs - Butter{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h1 class="text-3xl font-serif font-bold text-base-content">ğŸ‘¥ Utilisateurs</h1>
            <p class="text-secondary">Gestion et suivi des utilisateurs</p>
        </div>
    </div>

    <!-- Metrics -->
    <div class="stats stats-vertical md:stats-horizontal shadow w-full border border-base-300">
        <div class="stat">
            <div class="stat-title">Total</div>
            <div class="stat-value text-base-content">{{ metrics.total }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Premium</div>
            <div class="stat-value text-success">{{ metrics.active }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Essais</div>
            <div class="stat-value text-success">{{ metrics.trial }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Grace</div>
            <div class="stat-value text-secondary">{{ metrics.grace }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">ExpirÃ©s</div>
            <div class="stat-value text-error">{{ metrics.expired }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">En ligne</div>
            <div class="stat-value text-success">{{ metrics.online }}</div>
        </div>
        <div class="stat">
            <div class="stat-title">Tokens FCM</div>
            <div class="stat-value text-base-content">{{ metrics.tokens_total }}</div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <form method="get" action="{% url 'scripts_manager:users_list' %}" class="space-y-4">
                <div class="flex flex-col md:flex-row gap-3">
                    <input type="text" name="q" value="{{ query }}"
                           placeholder="Rechercher par nom, email, tÃ©lÃ©phone..."
                           class="input input-bordered flex-1 bg-base-200">
                    <button type="submit" class="btn btn-primary">ğŸ” Rechercher</button>
                </div>
                <div class="flex flex-wrap gap-2">
                    {% for value, label in status_options %}
                    <a href="?status={{ value }}{% if query %}&q={{ query }}{% endif %}"
                       class="btn btn-sm {% if status_filter == value %}btn-primary{% else %}btn-ghost border border-base-300{% endif %}">
                        {{ label }}
                    </a>
                    {% endfor %}
                </div>
            </form>
        </div>
    </div>

    <div class="text-sm text-secondary">{{ results_count }} rÃ©sultat{{ results_count|pluralize }}</div>

    <!-- Users Table -->
    <div class="card bg-base-100 shadow-sm border border-base-300 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="table table-zebra">
                <thead>
                    <tr>
                        <th>Utilisateur</th>
                        <th>Contact</th>
                        <th>Connexion</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <div class="font-medium text-base-content">{{ user.display_name|default:"N/A" }}</div>
                            <div class="text-sm text-secondary">{{ user.uid|truncatechars:20 }}</div>
                            {% if user.birthdate %}
                            <div class="text-xs text-secondary mt-1">ğŸ‚ {{ user.birthdate }}</div>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-sm text-base-content">{{ user.email|default:"N/A" }}</div>
                            {% if user.phone %}<div class="text-sm text-secondary">{{ user.phone }}</div>{% endif %}
                            {% if user.has_fcm_token %}
                            <div class="text-xs text-success mt-1">ğŸ“± {{ user.fcm_tokens_count }} token{{ user.fcm_tokens_count|pluralize }}</div>
                            {% else %}
                            <div class="text-xs text-secondary mt-1">Pas de token</div>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {{ user.connection_class }}">{{ user.connection_label }}</span>
                            {% if user.last_sign_in_display %}
                            <div class="text-xs text-secondary mt-1">{{ user.last_sign_in_display }}</div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center text-secondary py-12">Aucun utilisateur trouvÃ©</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if page_obj.has_other_pages %}
    <div class="flex items-center justify-between">
        <span class="text-sm text-secondary">Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}</span>
        <div class="join">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" class="join-item btn btn-ghost">â† PrÃ©cÃ©dent</a>
            {% endif %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}" class="join-item btn btn-ghost">Suivant â†’</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
