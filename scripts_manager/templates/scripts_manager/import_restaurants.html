{% extends 'scripts_manager/base.html' %}
{% load static %}

{% block title %}Import Batch Restaurants - Butter{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-6">
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-2xl font-serif text-base-content">Import Batch de Restaurants</h2>
        </div>
    </div>

    <!-- Info box -->
    <div class="alert alert-info">
        <div>
            <strong>Instructions :</strong>
            <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                <li>Le fichier Excel doit contenir les colonnes requises (Ref, Nom de base, Vrai Nom, Adresse, etc.)</li>
                <li>La premiere ligne doit contenir les en-tetes de colonnes</li>
                <li>Un backup automatique sera cree avant l'import</li>
                <li>La collection actuelle sera <strong>remplacee</strong> par les nouvelles donnees</li>
                <li>Le processus peut prendre plusieurs minutes selon le nombre de restaurants</li>
                <li><strong>Environnement actif :</strong> {{ firebase_env_label }}</li>
            </ul>
        </div>
    </div>

    <!-- Outils d'analyse -->
    <div class="card bg-base-100 shadow-sm border border-base-300" x-data="{ showResult: false }">
        <div class="card-body">
            <h3 class="card-title text-lg font-serif text-primary">Outils d'analyse</h3>
            <p class="text-secondary text-sm mb-4">Analysez et validez votre fichier avant l'import :</p>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button type="button" class="btn btn-primary" onclick="devFunction1()">
                    Analyser le fichier Excel
                </button>
                <button type="button" class="btn btn-primary" onclick="devFunction2()">
                    Previsualiser les donnees
                </button>
                <button type="button" class="btn btn-primary" onclick="devFunction3()">
                    Test d'import partiel
                </button>
                <button type="button" class="btn btn-primary" onclick="devFunction4()">
                    Valider les donnees
                </button>
            </div>

            <div id="devResult" class="mt-4 p-4 bg-base-200 rounded-lg hidden"></div>
        </div>
    </div>

    <!-- Import form -->
    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <form id="importForm" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Upload area -->
                <div id="uploadArea" class="border-2 border-dashed border-base-300 rounded-lg p-10 text-center cursor-pointer transition-colors hover:border-primary hover:bg-base-200">
                    <div class="text-5xl mb-4">üìÑ</div>
                    <h3 class="text-lg font-semibold text-base-content">Glissez-deposez votre fichier Excel ici</h3>
                    <p class="text-secondary my-2">ou</p>
                    <button type="button" class="btn btn-ghost" onclick="console.log('Bouton clique'); document.getElementById('excel_file').click();">
                        Parcourir les fichiers
                    </button>
                    <input type="file" id="excel_file" name="excel_file" class="hidden" accept=".xlsx,.xls" required onchange="console.log('Input change detecte directement:', this.files.length);">
                </div>

                <!-- File info -->
                <div class="mt-4 p-4 bg-base-200 rounded-lg hidden" id="fileInfo">
                    <strong>Fichier selectionne :</strong> <span id="fileName"></span>
                    <br>
                    <strong>Taille :</strong> <span id="fileSize"></span>
                </div>

                <!-- Sheet selector -->
                <div class="form-control mt-5">
                    <label for="sheet_name" class="label">
                        <span class="label-text font-medium">Feuille Excel a importer :</span>
                    </label>
                    <select
                        id="sheet_name"
                        name="sheet_name"
                        class="select select-bordered w-full"
                        disabled
                    >
                        <option value="">Selectionnez un fichier Excel d'abord</option>
                    </select>
                    <label class="label">
                        <span class="label-text-alt text-secondary">Les feuilles disponibles seront chargees automatiquement apres la selection du fichier</span>
                    </label>
                </div>

                <!-- Progress container -->
                <div class="mt-5 hidden" id="progressContainer">
                    <!-- Laura.gif -->
                    <div id="lauraGifContainer" class="mb-5 text-center hidden">
                        <h3 class="mb-2 text-base-content text-2xl font-bold">let me cook</h3>
                        <img id="lauraGif" src="{% static 'loading_gifs/Laura.gif' %}" alt="Laura cooking" class="max-w-sm max-h-72 rounded-xl shadow-md mx-auto">
                    </div>

                    <!-- Progress bar -->
                    <progress id="progressFill" class="progress progress-primary w-full h-8" value="0" max="100"></progress>
                    <p id="progressText" class="text-center mt-2 text-secondary">Preparation de l'import...</p>
                    <p id="progressPercent" class="text-center font-bold text-base-content">0%</p>

                    <!-- Terminal -->
                    <div id="terminalContainer" class="mt-5 hidden">
                        <div style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                            <div id="terminalContent" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">
                                <span style="color: #4ec9b0;">Demarrage de l'import...</span>
                            </div>
                        </div>
                    </div>

                    <!-- omg.gif -->
                    <div id="omgGifContainer" class="mt-5 text-center hidden">
                        <img id="omgGif" src="{% static 'loading_gifs/omg.gif' %}" alt="OMG!" class="max-w-sm max-h-72 rounded-xl shadow-md mx-auto">
                    </div>
                </div>

                <!-- Result container -->
                <div id="resultContainer" class="mt-5 hidden"></div>

                <!-- Submit -->
                <div class="mt-8 text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        Lancer l'import
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Backup Restoration Section -->
    <div class="divider"></div>

    <div class="card bg-base-100 shadow-sm border border-base-300">
        <div class="card-body">
            <h2 class="card-title text-2xl font-serif text-base-content">Restaurer un Backup</h2>

            <div class="alert alert-warning mt-4">
                <div>
                    <strong>Attention :</strong>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                        <li>La restauration va <strong>remplacer</strong> tous les restaurants actuels</li>
                        <li>Un backup de securite sera cree automatiquement avant la restauration</li>
                        <li>Cette operation est irreversible (sauf si vous restaurez a nouveau)</li>
                    </ul>
                </div>
            </div>

            <div class="mt-4 text-right">
                <button type="button" class="btn btn-ghost" id="refreshBackupsBtn">
                    Actualiser la liste
                </button>
            </div>

            <div id="backupsContainer" class="mt-4">
                <div id="backupsLoading" class="text-center py-10 text-secondary hidden">
                    <span class="loading loading-spinner loading-lg"></span>
                    <p class="mt-2">Chargement des backups...</p>
                </div>

                <div id="backupsSelectContainer" class="hidden">
                    <div class="bg-base-200 p-5 rounded-lg mb-4">
                        <label for="backupSelect" class="label">
                            <span class="label-text font-semibold text-base-content">Selectionner un backup a restaurer :</span>
                        </label>
                        <select id="backupSelect" class="select select-bordered w-full bg-base-200 text-base-content">
                            <option value="">-- Selectionner un backup --</option>
                        </select>
                        <div id="backupInfo" class="mt-4 p-4 bg-base-200 rounded-lg hidden">
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                <div>
                                    <span class="text-xs text-secondary block mb-1">Date/Heure</span>
                                    <span id="backupDate" class="font-semibold text-base-content"></span>
                                </div>
                                <div>
                                    <span class="text-xs text-secondary block mb-1">Restaurants</span>
                                    <span id="backupCount" class="font-semibold text-base-content"></span>
                                </div>
                                <div>
                                    <span class="text-xs text-secondary block mb-1">Taille</span>
                                    <span id="backupSize" class="font-semibold text-base-content"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary btn-lg hidden" id="restoreBtn">
                            Restaurer ce backup
                        </button>
                    </div>
                </div>

                <div id="backupsEmpty" class="card bg-base-200 hidden">
                    <div class="card-body items-center text-center py-10">
                        <p class="text-secondary">Aucun backup disponible</p>
                        <p class="text-secondary text-sm mt-2">Les backups sont crees automatiquement lors des imports de restaurants.</p>
                    </div>
                </div>
            </div>

            <div id="restoreResult" class="mt-5 hidden"></div>
        </div>
    </div>
</div>

<script>
console.log('Script d\'import restaurants charge');
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded declenche');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('excel_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const importForm = document.getElementById('importForm');

    // Test de base pour verifier que les elements existent
    console.log('Initialisation - fileInput:', fileInput);
    console.log('Initialisation - fileInfo:', fileInfo);
    console.log('Initialisation - importForm:', importForm);

    if (!fileInput) {
        console.error('fileInput introuvable !');
        return;
    }

    console.log('Tous les elements trouves, initialisation des event listeners');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressPercent = document.getElementById('progressPercent');
    const progressText = document.getElementById('progressText');
    const resultContainer = document.getElementById('resultContainer');
    const submitBtn = document.getElementById('submitBtn');

    // Helper to update progress bar
    function setProgress(value) {
        progressFill.value = value;
        progressPercent.textContent = Math.round(value) + '%';
    }

    // Gestion du drag & drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-base-300');
        uploadArea.classList.add('border-success', 'bg-success/10');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-success', 'bg-success/10');
        uploadArea.classList.add('border-base-300');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('border-success', 'bg-success/10');
        uploadArea.classList.add('border-base-300');
        const files = e.dataTransfer.files;
        console.log('Fichiers deposes:', files.length);
        if (files.length > 0) {
            // Creer un nouveau DataTransfer pour assigner les fichiers
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;
            console.log('Fichier assigne a l\'input:', fileInput.files.length);
            handleFileSelect(files[0]);
        }
    });

    fileInput.addEventListener('change', function(e) {
        console.log('Event change declenche');
        console.log('Fichier selectionne:', e.target.files);
        console.log('Nombre de fichiers:', e.target.files.length);

        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            console.log('Nom du fichier:', file.name);
            console.log('Taille du fichier:', file.size);
            handleFileSelect(file);
        } else {
            console.warn('Aucun fichier selectionne ou files est null');
        }
    });

    // Verifier aussi si l'input est reinitialise quelque part
    const originalReset = importForm.reset;
    importForm.reset = function() {
        console.log('Formulaire reinitialise');
        originalReset.call(this);
        // Reinitialiser le select aussi
        const sheetSelect = document.getElementById('sheet_name');
        if (sheetSelect) {
            sheetSelect.disabled = true;
            sheetSelect.innerHTML = '<option value="">Selectionnez un fichier Excel d\'abord</option>';
        }
    };

    function handleFileSelect(file) {
        console.log('handleFileSelect appele avec:', file.name);

        if (!file) {
            console.error('Fichier est null ou undefined');
            return;
        }

        const sheetSelect = document.getElementById('sheet_name');

        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            console.warn('Fichier non Excel:', file.name);
            alert('Veuillez selectionner un fichier Excel (.xlsx ou .xls)');
            // Reinitialiser le select
            if (sheetSelect) {
                sheetSelect.disabled = true;
                sheetSelect.innerHTML = '<option value="">Selectionnez un fichier Excel d\'abord</option>';
            }
            // Reinitialiser l'affichage du fichier
            fileName.textContent = '';
            fileSize.textContent = '';
            fileInfo.classList.add('hidden');
            return;
        }

        console.log('Fichier Excel valide, mise a jour de l\'affichage');
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.remove('hidden');

        // Analyser les feuilles du fichier Excel (en arriere-plan, ne bloque pas)
        try {
            console.log('Demarrage de l\'analyse des feuilles...');
            analyzeExcelSheets(file);
        } catch (error) {
            console.error('Erreur lors de l\'analyse des feuilles:', error);
            // En cas d'erreur, utiliser Feuil1 par defaut
            if (sheetSelect) {
                sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par defaut)</option>';
                sheetSelect.disabled = false;
            }
        }
    }

    function analyzeExcelSheets(file) {
        console.log('analyzeExcelSheets appele avec:', file.name);
        const sheetSelect = document.getElementById('sheet_name');

        if (!sheetSelect) {
            console.error('Select sheet_name introuvable');
            return;
        }

        sheetSelect.disabled = true;
        sheetSelect.innerHTML = '<option value="">Analyse des feuilles en cours...</option>';

        const formData = new FormData();
        formData.append('excel_file', file);

        console.log('Envoi de la requete pour analyser les feuilles...');

        fetch('{% url "scripts_manager:analyze_excel_sheets" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('Reponse recue:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Donnees recues:', data);
            if (data.success && data.sheets && data.sheets.length > 0) {
                console.log('Feuilles trouvees:', data.sheets);
                sheetSelect.innerHTML = '';
                data.sheets.forEach(sheet => {
                    const option = document.createElement('option');
                    option.value = sheet;
                    option.textContent = sheet;
                    if (sheet === data.default_sheet) {
                        option.selected = true;
                    }
                    sheetSelect.appendChild(option);
                });
                sheetSelect.disabled = false;
                console.log('Select mis a jour avec', data.sheets.length, 'feuilles');
            } else {
                console.warn('Aucune feuille trouvee, utilisation de Feuil1 par defaut');
                sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par defaut)</option>';
                sheetSelect.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erreur lors de l\'analyse des feuilles:', error);
            sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par defaut)</option>';
            sheetSelect.disabled = false;
            // Afficher un message d'avertissement mais permettre quand meme l'import
            console.warn('Impossible d\'analyser les feuilles, utilisation de "Feuil1" par defaut');
        });
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    importForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        if (!fileInput.files.length) {
            alert('Veuillez selectionner un fichier Excel');
            return;
        }

        const sheetSelect = document.getElementById('sheet_name');
        // Verifier seulement si le select est active et a des options mais aucune selectionnee
        if (!sheetSelect.disabled && sheetSelect.options.length > 1 && !sheetSelect.value) {
            alert('Veuillez selectionner une feuille Excel');
            return;
        }

        // Confirmation avec lapin.gif
        const confirmModal = document.createElement('div');
        confirmModal.id = 'confirmModal';
        confirmModal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;';
        confirmModal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <img src="{% static 'loading_gifs/lapin.gif' %}" alt="Lapin" style="max-width: 300px; max-height: 250px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #111111;">ATTENTION</h3>
                <p style="margin-bottom: 20px; color: #535353; line-height: 1.6;">
                    Cette operation va remplacer TOUS les restaurants actuels.<br><br>
                    Un backup sera cree automatiquement.<br><br>
                    Voulez-vous continuer ?
                </p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirmYes" style="padding: 12px 30px; background: #60BC81; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Oui, continuer</button>
                    <button id="confirmNo" style="padding: 12px 30px; background: #D3695E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Annuler</button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmModal);

        // Attendre la confirmation
        const confirmed = await new Promise((resolve) => {
            document.getElementById('confirmYes').onclick = () => {
                document.body.removeChild(confirmModal);
                resolve(true);
            };
            document.getElementById('confirmNo').onclick = () => {
                document.body.removeChild(confirmModal);
                resolve(false);
            };
        });

        if (!confirmed) {
            return;
        }

        const formData = new FormData(importForm);
        // Recuperer la feuille selectionnee, ou utiliser la premiere option, ou 'Feuil1' par defaut
        // sheetSelect est deja declare plus haut dans la fonction
        let sheetName = 'Feuil1';
        if (sheetSelect && !sheetSelect.disabled && sheetSelect.value) {
            sheetName = sheetSelect.value;
        } else if (sheetSelect && sheetSelect.options.length > 0 && sheetSelect.options[0].value) {
            sheetName = sheetSelect.options[0].value;
        }
        formData.set('sheet_name', sheetName);

        // Afficher le loader
        progressContainer.classList.remove('hidden');
        setProgress(10);
        progressText.textContent = 'Upload du fichier...';
        submitBtn.disabled = true;
        resultContainer.classList.add('hidden');
        resultContainer.innerHTML = '';

        // Afficher Laura.gif avec "let me cook"
        document.getElementById('lauraGifContainer').classList.remove('hidden');

        // Afficher le terminal
        document.getElementById('terminalContainer').classList.remove('hidden');
        const terminalContent = document.getElementById('terminalContent');
        terminalContent.innerHTML = '<span style="color: #4ec9b0;">Demarrage de l\'import...</span>\n';

        // Masquer omg.gif si visible
        document.getElementById('omgGifContainer').classList.add('hidden');

        // Variable pour stocker le chemin du log (sera recupere apres l'upload)
        let logFilePath = null;

        // Simuler la progression (sera remplacee par les vrais logs)
        let progress = 10;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 3;
            if (progress > 95) progress = 95; // Ne pas aller a 100% avant la fin
            setProgress(progress);
        }, 1000);

        // Fonction pour recuperer et afficher les logs
        let logPollingInterval = null;
        function startLogPolling(logFile) {
            if (logPollingInterval) clearInterval(logPollingInterval);

            logPollingInterval = setInterval(() => {
                fetch(`{% url "scripts_manager:get_import_logs" %}?log_file=${encodeURIComponent(logFile)}`)
                    .then(response => response.json())
                    .then(logData => {
                        if (logData.success && logData.logs) {
                            const terminalContent = document.getElementById('terminalContent');
                            // Formater les logs avec des couleurs
                            let formattedLogs = '';
                            logData.logs.split('\n').forEach(line => {
                                if (line.trim()) {
                                    let color = '#d4d4d4';
                                    if (line.includes('‚úÖ')) color = '#4ec9b0';
                                    else if (line.includes('‚ùå') || line.includes('Erreur')) color = '#f48771';
                                    else if (line.includes('‚ö†Ô∏è')) color = '#dcdcaa';
                                    else if (line.includes('üìä') || line.includes('üì•')) color = '#569cd6';
                                    else if (line.includes('üóÑÔ∏è') || line.includes('üîÑ')) color = '#c586c0';

                                    formattedLogs += `<span style="color: ${color};">${escapeHtml(line)}</span>\n`;
                                }
                            });
                            terminalContent.innerHTML = formattedLogs;
                            // Scroll vers le bas
                            const terminalDiv = terminalContent.parentElement;
                            terminalDiv.scrollTop = terminalDiv.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la recuperation des logs:', error);
                    });
            }, 1000); // Poll toutes les secondes
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Demarrer le polling des logs des que le log_file est disponible
        // On va le demarrer apres avoir recu la reponse de l'upload

        fetch('{% url "scripts_manager:run_import_restaurants" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            // Si l'import est en cours (status: running), demarrer le polling
            if (data.status === 'running' && data.log_file) {
                startLogPolling(data.log_file);

                // Verifier periodiquement si l'import est termine
                const checkCompletion = setInterval(() => {
                    fetch(`{% url "scripts_manager:get_import_logs" %}?log_file=${encodeURIComponent(data.log_file)}`)
                        .then(response => response.json())
                        .then(logData => {
                            if (logData.success && logData.logs) {
                                const terminalContent = document.getElementById('terminalContent');
                                let formattedLogs = '';
                                logData.logs.split('\n').forEach(line => {
                                    if (line.trim()) {
                                        let color = '#d4d4d4';
                                        if (line.includes('‚úÖ')) color = '#4ec9b0';
                                        else if (line.includes('‚ùå') || line.includes('Erreur')) color = '#f48771';
                                        else if (line.includes('‚ö†Ô∏è')) color = '#dcdcaa';
                                        else if (line.includes('üìä') || line.includes('üì•')) color = '#569cd6';
                                        else if (line.includes('üóÑÔ∏è') || line.includes('üîÑ')) color = '#c586c0';

                                        formattedLogs += `<span style="color: ${color};">${escapeHtml(line)}</span>\n`;
                                    }
                                });
                                terminalContent.innerHTML = formattedLogs;
                                const terminalDiv = terminalContent.parentElement;
                                terminalDiv.scrollTop = terminalDiv.scrollHeight;

                                // Verifier si l'import est termine
                                if (logData.logs.includes('Fin de workflow') || logData.logs.includes('üéâ')) {
                                    clearInterval(checkCompletion);
                                    if (logPollingInterval) clearInterval(logPollingInterval);

                                    clearInterval(progressInterval);
                                    setProgress(100);

                                    // Masquer Laura.gif et afficher omg.gif
                                    document.getElementById('lauraGifContainer').classList.add('hidden');
                                    document.getElementById('omgGifContainer').classList.remove('hidden');

                                    // Recuperer les resultats finaux depuis le log (parser les dernieres lignes)
                                    // Pour l'instant, on affiche juste un message de succes
                                    progressText.textContent = 'Import termine avec succes !';
                                    resultContainer.className = 'alert alert-success mt-5';
                                    resultContainer.innerHTML = `
                                        <div>
                                            <h3 class="font-bold">Import termine !</h3>
                                            <p>Consultez les logs ci-dessus pour les details.</p>
                                            <p><strong>Log :</strong> ${data.log_file}</p>
                                        </div>
                                    `;

                                    // Reinitialiser le formulaire apres 5 secondes
                                    setTimeout(() => {
                                        importForm.reset();
                                        fileInfo.classList.add('hidden');
                                        progressContainer.classList.add('hidden');
                                        submitBtn.disabled = false;
                                        document.getElementById('omgGifContainer').classList.add('hidden');
                                    }, 5000);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Erreur lors de la verification des logs:', error);
                        });
                }, 2000); // Verifier toutes les 2 secondes
            } else if (data.success) {
                // Import termine immediatement (cas peu probable)
                clearInterval(progressInterval);
                setProgress(100);

                document.getElementById('lauraGifContainer').classList.add('hidden');
                document.getElementById('omgGifContainer').classList.remove('hidden');

                progressText.textContent = 'Import termine avec succes !';

                let favoriteStatsHtml = '';
                if (data.favorite_count_stats) {
                    const favStats = data.favorite_count_stats;
                    if (favStats.updated !== undefined) {
                        favoriteStatsHtml = `
                            <div class="alert alert-info mt-4">
                                <div>
                                    <h4 class="font-bold">Compteurs de favoris mis a jour</h4>
                                    <p><strong>${favStats.updated || 0}</strong> restaurants mis a jour</p>
                                    <p><strong>${favStats.zero_initialized || 0}</strong> restaurants initialises a 0</p>
                                    <p><strong>${favStats.active_favorites || 0}</strong> favoris actifs au total</p>
                                    ${favStats.errors > 0 ? `<p class="text-error">${favStats.errors} erreurs</p>` : ''}
                                </div>
                            </div>
                        `;
                    } else if (favStats.error) {
                        favoriteStatsHtml = `
                            <div class="alert alert-warning mt-4">
                                <div>
                                    <p>Erreur lors de la mise a jour des compteurs de favoris: ${favStats.error}</p>
                                </div>
                            </div>
                        `;
                    }
                }

                resultContainer.className = 'alert alert-success mt-5';
                resultContainer.innerHTML = `
                    <div>
                        <h3 class="font-bold">Import reussi !</h3>
                        <p><strong>${data.imported}</strong> restaurants importes</p>
                        ${data.duplicates > 0 ? `<p>${data.duplicates} IDs dupliques detectes</p>` : ''}
                        ${data.missing_tag_rows > 0 ? `<p>${data.missing_tag_rows} lignes sans tag (Ref)</p>` : ''}
                        <p><strong>Backup :</strong> ${data.backup_dir}</p>
                        <p><strong>Log :</strong> ${data.log_file}</p>
                        ${favoriteStatsHtml}
                    </div>
                `;

                setTimeout(() => {
                    importForm.reset();
                    fileInfo.classList.add('hidden');
                    progressContainer.classList.add('hidden');
                    submitBtn.disabled = false;
                }, 5000);
            } else {
                clearInterval(progressInterval);
                progressText.textContent = 'Erreur lors de l\'import';
                document.getElementById('lauraGifContainer').classList.add('hidden');
                if (logPollingInterval) clearInterval(logPollingInterval);
                resultContainer.className = 'alert alert-error mt-5';
                resultContainer.innerHTML = `
                    <div>
                        <h3 class="font-bold">Erreur</h3>
                        <p>${data.error || 'Une erreur est survenue lors de l\'import'}</p>
                        ${data.traceback ? `<pre class="bg-base-100 p-3 rounded text-xs overflow-x-auto mt-2">${data.traceback}</pre>` : ''}
                    </div>
                `;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            if (logPollingInterval) clearInterval(logPollingInterval);
            // Masquer Laura.gif
            document.getElementById('lauraGifContainer').classList.add('hidden');
            progressText.textContent = 'Erreur lors de l\'import';
            resultContainer.className = 'alert alert-error mt-5';
            resultContainer.innerHTML = `
                <div>
                    <h3 class="font-bold">Erreur</h3>
                    <p>Une erreur est survenue : ${error.message}</p>
                </div>
            `;
            submitBtn.disabled = false;
        });
    });

    // Gestion des backups
    const refreshBackupsBtn = document.getElementById('refreshBackupsBtn');
    const backupsLoading = document.getElementById('backupsLoading');
    const backupsList = document.getElementById('backupsList');
    const backupsTableBody = document.getElementById('backupsTableBody');
    const backupsEmpty = document.getElementById('backupsEmpty');
    const restoreResult = document.getElementById('restoreResult');

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'Date inconnue';
        try {
            // Essayer de parser differents formats
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return timestamp; // Retourner tel quel si non parsable
            }
            return date.toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return timestamp;
        }
    }

    function loadBackups() {
        // Verifier que les elements existent avant de les utiliser
        if (!backupsLoading || !backupsList || !backupsEmpty || !restoreResult) {
            console.warn('Elements de backup introuvables, fonction loadBackups ignoree');
            return;
        }

        backupsLoading.classList.remove('hidden');
        backupsList.classList.add('hidden');
        backupsEmpty.classList.add('hidden');
        restoreResult.classList.add('hidden');

        fetch('{% url "scripts_manager:list_backups" %}')
            .then(response => response.json())
            .then(data => {
                if (backupsLoading) {
                    backupsLoading.classList.add('hidden');
                }

                if (data.success && data.backups && data.backups.length > 0) {
                    if (backupsTableBody) {
                        backupsTableBody.innerHTML = '';

                        data.backups.forEach(backup => {
                            const row = document.createElement('tr');
                            row.style.borderBottom = '1px solid #e9ecef';

                            const dateCell = document.createElement('td');
                            dateCell.style.padding = '12px';
                            dateCell.textContent = formatDate(backup.timestamp);

                            const countCell = document.createElement('td');
                            countCell.style.padding = '12px';
                            countCell.textContent = backup.count || 'N/A';

                            const sizeCell = document.createElement('td');
                            sizeCell.style.padding = '12px';
                            sizeCell.textContent = formatFileSize(backup.size || 0);

                            const actionsCell = document.createElement('td');
                            actionsCell.style.padding = '12px';
                            actionsCell.style.textAlign = 'center';

                            const restoreBtn = document.createElement('button');
                            restoreBtn.className = 'btn btn-primary btn-sm';
                            restoreBtn.textContent = 'Restaurer';
                            restoreBtn.onclick = () => restoreBackup(backup.backup_dir, backup.backup_name);

                            actionsCell.appendChild(restoreBtn);

                            row.appendChild(dateCell);
                            row.appendChild(countCell);
                            row.appendChild(sizeCell);
                            row.appendChild(actionsCell);

                            backupsTableBody.appendChild(row);
                        });
                    }

                    if (backupsList) {
                        backupsList.classList.remove('hidden');
                    }
                } else {
                    if (backupsEmpty) {
                        backupsEmpty.classList.remove('hidden');
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des backups:', error);
                if (backupsLoading) {
                    backupsLoading.classList.add('hidden');
                }
                backupsEmpty.classList.remove('hidden');
                backupsEmpty.innerHTML = `<div class="card-body items-center text-center py-10"><p class="text-error">Erreur lors du chargement: ${error.message}</p></div>`;
            });
    }

    function restoreBackup(backupDir, backupName) {
        if (!confirm(`ATTENTION : Cette operation va remplacer TOUS les restaurants actuels par ceux du backup "${backupName}".\n\nUn backup de securite sera cree avant la restauration.\n\nVoulez-vous continuer ?`)) {
            return;
        }

        restoreResult.classList.remove('hidden');
        restoreResult.className = 'alert mt-5';
        restoreResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Restauration en cours...';

        fetch('{% url "scripts_manager:restore_backup" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                backup_dir: backupDir,
                create_backup_before: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                restoreResult.className = 'alert alert-success mt-5';
                restoreResult.innerHTML = `
                    <div>
                        <h3 class="font-bold">Restauration reussie !</h3>
                        <p><strong>${data.imported}</strong> restaurants restaures</p>
                        <p><strong>Backup restaure :</strong> ${data.backup_dir}</p>
                        ${data.backup_before_dir ? `<p><strong>Backup de securite :</strong> ${data.backup_before_dir}</p>` : ''}
                    </div>
                `;
            } else {
                restoreResult.className = 'alert alert-error mt-5';
                restoreResult.innerHTML = `
                    <div>
                        <h3 class="font-bold">Erreur</h3>
                        <p>${data.error || 'Une erreur est survenue lors de la restauration'}</p>
                        ${data.traceback ? `<pre class="bg-base-100 p-3 rounded text-xs overflow-x-auto mt-2">${data.traceback}</pre>` : ''}
                    </div>
                `;
            }
        })
        .catch(error => {
            restoreResult.className = 'alert alert-error mt-5';
            restoreResult.innerHTML = `
                <div>
                    <h3 class="font-bold">Erreur</h3>
                    <p>Une erreur est survenue : ${error.message}</p>
                </div>
            `;
        });
    }

    if (refreshBackupsBtn) {
        refreshBackupsBtn.addEventListener('click', loadBackups);

        // Charger les backups au chargement de la page
        loadBackups();
    } else {
        console.log('Section backups non disponible sur cette page');
    }

    // Fonctions d'analyse (disponibles en DEV et PROD)
    function devFunction1() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('Veuillez d\'abord selectionner un fichier Excel');
            return;
        }

        const devResult = document.getElementById('devResult');
        devResult.classList.remove('hidden');
        devResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Analyse du fichier en cours...';

        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'analyze');

        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                devResult.innerHTML = `
                    <h4 class="font-bold mb-2">Analyse terminee</h4>
                    <pre class="bg-base-100 p-4 rounded-lg overflow-x-auto text-xs">${JSON.stringify(data.result, null, 2)}</pre>
                `;
            } else {
                devResult.innerHTML = `<p class="text-error">Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p class="text-error">Erreur: ${error.message}</p>`;
        });
    }

    function devFunction2() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('Veuillez d\'abord selectionner un fichier Excel');
            return;
        }

        const devResult = document.getElementById('devResult');
        devResult.classList.remove('hidden');
        devResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Previsualisation en cours...';

        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'preview');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);

        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let previewHtml = '<h4 class="font-bold mb-2">Previsualisation des donnees (10 premieres lignes)</h4>';
                if (data.preview && data.preview.length > 0) {
                    previewHtml += '<div class="overflow-x-auto"><table class="table table-xs table-zebra w-full">';
                    // En-tetes
                    previewHtml += '<thead><tr>';
                    Object.keys(data.preview[0]).forEach(key => {
                        previewHtml += `<th>${key}</th>`;
                    });
                    previewHtml += '</tr></thead>';
                    // Donnees
                    previewHtml += '<tbody>';
                    data.preview.slice(0, 10).forEach(row => {
                        previewHtml += '<tr>';
                        Object.values(row).forEach(val => {
                            previewHtml += `<td>${val || ''}</td>`;
                        });
                        previewHtml += '</tr>';
                    });
                    previewHtml += '</tbody></table></div>';
                    previewHtml += `<p class="mt-2 text-sm text-secondary">Total: ${data.total || 0} lignes</p>`;
                } else {
                    previewHtml += '<p>Aucune donnee trouvee</p>';
                }
                devResult.innerHTML = previewHtml;
            } else {
                devResult.innerHTML = `<p class="text-error">Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p class="text-error">Erreur: ${error.message}</p>`;
        });
    }

    function devFunction3() {
        if (!confirm('Cette fonction va importer uniquement les 5 premiers restaurants pour tester. Continuer ?')) {
            return;
        }

        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('Veuillez d\'abord selectionner un fichier Excel');
            return;
        }

        const devResult = document.getElementById('devResult');
        devResult.classList.remove('hidden');
        devResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Test d\'import partiel en cours...';

        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'test_import');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);
        formData.append('limit', '5');

        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                devResult.innerHTML = `
                    <h4 class="font-bold mb-2">Test d'import termine</h4>
                    <p>${data.imported || 0} restaurant(s) importe(s) pour le test</p>
                    <pre class="bg-base-100 p-4 rounded-lg overflow-x-auto text-xs mt-2">${JSON.stringify(data.result, null, 2)}</pre>
                `;
            } else {
                devResult.innerHTML = `<p class="text-error">Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p class="text-error">Erreur: ${error.message}</p>`;
        });
    }

    function devFunction4() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('Veuillez d\'abord selectionner un fichier Excel');
            return;
        }

        const devResult = document.getElementById('devResult');
        devResult.classList.remove('hidden');
        devResult.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Validation des donnees en cours...';

        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'validate');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);

        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let validationHtml = '<h4 class="font-bold mb-2">Validation terminee</h4>';
                if (data.validation) {
                    validationHtml += `<p><strong>Total lignes:</strong> ${data.validation.total || 0}</p>`;
                    validationHtml += `<p><strong>Lignes valides:</strong> ${data.validation.valid || 0}</p>`;
                    validationHtml += `<p><strong>Erreurs:</strong> ${data.validation.errors || 0}</p>`;
                    if (data.validation.error_details && data.validation.error_details.length > 0) {
                        validationHtml += '<h5 class="font-semibold mt-2">Details des erreurs:</h5><ul class="list-disc list-inside">';
                        data.validation.error_details.slice(0, 10).forEach(err => {
                            validationHtml += `<li>${err}</li>`;
                        });
                        validationHtml += '</ul>';
                    }
                }
                devResult.innerHTML = validationHtml;
            } else {
                devResult.innerHTML = `<p class="text-error">Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p class="text-error">Erreur: ${error.message}</p>`;
        });
    }
});
</script>
{% endblock %}
