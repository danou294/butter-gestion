{% extends 'scripts_manager/base.html' %}
{% load static %}

{% block title %}Import Batch Restaurants - Butter{% endblock %}

{% block extra_css %}
<style>
    .import-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        background: #f8f9ff;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .upload-area:hover {
        border-color: #5568d3;
        background: #f0f2ff;
    }
    
    .upload-area.dragover {
        border-color: #28a745;
        background: #e8f5e9;
    }
    
    .file-input {
        display: none;
    }
    
    .file-info {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        display: none;
    }
    
    .file-info.active {
        display: block;
    }
    
    .progress-container {
        margin-top: 20px;
        display: none;
    }
    
    .progress-container.active {
        display: block;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: #e9ecef;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 10px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        width: 0%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .result-container {
        margin-top: 20px;
        padding: 20px;
        border-radius: 8px;
        display: none;
    }
    
    .result-container.success {
        display: block;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .result-container.error {
        display: block;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .info-box ul {
        margin: 10px 0 0 20px;
        padding: 0;
    }
    
    .info-box li {
        margin: 5px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="card import-container">
    <h2>üì• Import Batch de Restaurants</h2>
    
    <div class="info-box">
        <strong>‚ÑπÔ∏è Instructions :</strong>
        <ul>
            <li>Le fichier Excel doit contenir les colonnes requises (Ref, Nom de base, Vrai Nom, Adresse, etc.)</li>
            <li>La premi√®re ligne doit contenir les en-t√™tes de colonnes</li>
            <li>Un backup automatique sera cr√©√© avant l'import</li>
            <li>La collection actuelle sera <strong>remplac√©e</strong> par les nouvelles donn√©es</li>
            <li>Le processus peut prendre plusieurs minutes selon le nombre de restaurants</li>
            <li><strong>Environnement actif :</strong> {{ firebase_env_label }}</li>
        </ul>
    </div>

    <!-- Fonctions d'analyse -->
    <div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-left: 4px solid #667eea; border-radius: 8px;">
        <h3 style="margin-top: 0; color: #667eea;">üîß Outils d'analyse</h3>
        <p style="color: #535353; margin-bottom: 15px;">Analysez et validez votre fichier avant l'import :</p>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
            <button type="button" class="btn" onclick="devFunction1()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                üîç Analyser le fichier Excel
            </button>
            <button type="button" class="btn" onclick="devFunction2()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                üìä Pr√©visualiser les donn√©es
            </button>
            <button type="button" class="btn" onclick="devFunction3()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                üß™ Test d'import partiel
            </button>
            <button type="button" class="btn" onclick="devFunction4()" style="padding: 12px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                üîÑ Valider les donn√©es
            </button>
        </div>

        <div id="devResult" style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; display: none;"></div>
    </div>
    
    <form id="importForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
            <h3>Glissez-d√©posez votre fichier Excel ici</h3>
            <p>ou</p>
            <button type="button" class="btn" onclick="console.log('üîò Bouton cliqu√©'); document.getElementById('excel_file').click();">
                Parcourir les fichiers
            </button>
            <input type="file" id="excel_file" name="excel_file" class="file-input" accept=".xlsx,.xls" required onchange="console.log('üìÅ Input change d√©tect√© directement:', this.files.length);">
        </div>
        
        <div class="file-info" id="fileInfo">
            <strong>Fichier s√©lectionn√© :</strong> <span id="fileName"></span>
            <br>
            <strong>Taille :</strong> <span id="fileSize"></span>
        </div>
        
        <div style="margin-top: 20px;">
            <label for="sheet_name" style="display: block; margin-bottom: 10px; font-weight: 500;">
                Feuille Excel √† importer :
            </label>
            <select 
                id="sheet_name" 
                name="sheet_name" 
                style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; background: white;"
                disabled
            >
                <option value="">S√©lectionnez un fichier Excel d'abord</option>
            </select>
            <small style="color: #6c757d;">Les feuilles disponibles seront charg√©es automatiquement apr√®s la s√©lection du fichier</small>
        </div>
        
        <div class="progress-container" id="progressContainer">
            <!-- Laura.gif avec "let me cook" pendant l'import -->
            <div id="lauraGifContainer" style="margin-bottom: 20px; text-align: center; display: none;">
                <h3 style="margin-bottom: 10px; color: #111111; font-size: 24px; font-weight: bold;">let me cook</h3>
                <img id="lauraGif" src="{% static 'loading_gifs/Laura.gif' %}" alt="Laura cooking" style="max-width: 400px; max-height: 300px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 10px;">Pr√©paration de l'import...</p>
            
            <!-- Terminal pour afficher les logs en temps r√©el -->
            <div id="terminalContainer" style="margin-top: 20px; display: none;">
                <div style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                    <div id="terminalContent" style="white-space: pre-wrap; word-wrap: break-word; line-height: 1.6;">
                        <span style="color: #4ec9b0;">üöÄ D√©marrage de l'import...</span>
                    </div>
                </div>
            </div>
            
            <!-- omg.gif √† la fin -->
            <div id="omgGifContainer" style="margin-top: 20px; text-align: center; display: none;">
                <img id="omgGif" src="{% static 'loading_gifs/omg.gif' %}" alt="OMG!" style="max-width: 400px; max-height: 300px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            </div>
        </div>
        
        <div class="result-container" id="resultContainer"></div>
        
        <div style="margin-top: 30px; text-align: center;">
            <button type="submit" class="btn" id="submitBtn" style="padding: 15px 40px; font-size: 16px;">
                üöÄ Lancer l'import
            </button>
        </div>
    </form>
    
    <!-- Section Restauration de Backups -->
    <div style="margin-top: 60px; padding-top: 40px; border-top: 2px solid #e9ecef;">
        <h2 style="margin-bottom: 20px; font-size: 24px; font-weight: 700; color: #111111;">üîÑ Restaurer un Backup</h2>
        
        <div class="info-box" style="background: #fff3cd; border-left-color: #ffc107;">
            <strong>‚ö†Ô∏è Attention :</strong>
            <ul>
                <li>La restauration va <strong>remplacer</strong> tous les restaurants actuels</li>
                <li>Un backup de s√©curit√© sera cr√©√© automatiquement avant la restauration</li>
                <li>Cette op√©ration est irr√©versible (sauf si vous restaurez √† nouveau)</li>
            </ul>
        </div>
        
        <div style="margin-top: 20px; text-align: right;">
            <button type="button" class="btn" id="refreshBackupsBtn" style="margin-bottom: 20px; padding: 10px 20px;">
                üîÑ Actualiser la liste
            </button>
        </div>
        
        <div id="backupsContainer" style="margin-top: 20px;">
            <div id="backupsLoading" style="text-align: center; padding: 40px; color: #6c757d; display: none;">
                <p>‚è≥ Chargement des backups...</p>
            </div>
            
            <div id="backupsSelectContainer" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #C9C1B1;">
                    <label for="backupSelect" style="display: block; margin-bottom: 10px; font-weight: 600; color: #111111;">
                        üì¶ S√©lectionner un backup √† restaurer :
                    </label>
                    <select id="backupSelect" 
                            style="width: 100%; padding: 12px; border: none; border-radius: 0; font-size: 16px; background: #F1EFEB; color: #111111;">
                        <option value="">-- S√©lectionner un backup --</option>
                    </select>
                    <div id="backupInfo" style="margin-top: 15px; padding: 15px; background: #F1EFEB; border-radius: 8px; display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <span style="font-size: 12px; color: #535353; display: block; margin-bottom: 5px;">üìÖ Date/Heure</span>
                                <span id="backupDate" style="font-weight: 600; color: #111111;"></span>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: #535353; display: block; margin-bottom: 5px;">üçΩÔ∏è Restaurants</span>
                                <span id="backupCount" style="font-weight: 600; color: #111111;"></span>
                            </div>
                            <div>
                                <span style="font-size: 12px; color: #535353; display: block; margin-bottom: 5px;">üíæ Taille</span>
                                <span id="backupSize" style="font-weight: 600; color: #111111;"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button type="button" class="btn-primary" id="restoreBtn" style="padding: 15px 40px; font-size: 16px; display: none;">
                        üîÑ Restaurer ce backup
                    </button>
                </div>
            </div>
            
            <div id="backupsEmpty" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; display: none;">
                <p style="color: #6c757d;">üì¶ Aucun backup disponible</p>
                <p style="color: #6c757d; margin-top: 10px; font-size: 14px;">Les backups sont cr√©√©s automatiquement lors des imports de restaurants.</p>
            </div>
        </div>
        
        <div id="restoreResult" class="result-container" style="margin-top: 20px;"></div>
    </div>
</div>

<script>
console.log('üöÄ Script d\'import restaurants charg√©');
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOMContentLoaded d√©clench√©');
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('excel_file');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const importForm = document.getElementById('importForm');
    
    // Test de base pour v√©rifier que les √©l√©ments existent
    console.log('üîß Initialisation - fileInput:', fileInput);
    console.log('üîß Initialisation - fileInfo:', fileInfo);
    console.log('üîß Initialisation - importForm:', importForm);
    
    if (!fileInput) {
        console.error('‚ùå fileInput introuvable !');
        return;
    }
    
    console.log('‚úÖ Tous les √©l√©ments trouv√©s, initialisation des event listeners');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultContainer = document.getElementById('resultContainer');
    const submitBtn = document.getElementById('submitBtn');
    
    // Gestion du drag & drop
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        console.log('üì• Fichiers d√©pos√©s:', files.length);
        if (files.length > 0) {
            // Cr√©er un nouveau DataTransfer pour assigner les fichiers
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(files[0]);
            fileInput.files = dataTransfer.files;
            console.log('‚úÖ Fichier assign√© √† l\'input:', fileInput.files.length);
            handleFileSelect(files[0]);
        }
    });
    
    fileInput.addEventListener('change', function(e) {
        console.log('üìÅ Event change d√©clench√©');
        console.log('üìÅ Fichier s√©lectionn√©:', e.target.files);
        console.log('üìÅ Nombre de fichiers:', e.target.files.length);
        
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0];
            console.log('üìÑ Nom du fichier:', file.name);
            console.log('üìÑ Taille du fichier:', file.size);
            handleFileSelect(file);
        } else {
            console.warn('‚ö†Ô∏è Aucun fichier s√©lectionn√© ou files est null');
        }
    });
    
    // V√©rifier aussi si l'input est r√©initialis√© quelque part
    const originalReset = importForm.reset;
    importForm.reset = function() {
        console.log('üîÑ Formulaire r√©initialis√©');
        originalReset.call(this);
        // R√©initialiser le select aussi
        const sheetSelect = document.getElementById('sheet_name');
        if (sheetSelect) {
            sheetSelect.disabled = true;
            sheetSelect.innerHTML = '<option value="">S√©lectionnez un fichier Excel d\'abord</option>';
        }
    };
    
    function handleFileSelect(file) {
        console.log('üîç handleFileSelect appel√© avec:', file.name);
        
        if (!file) {
            console.error('‚ùå Fichier est null ou undefined');
            return;
        }
        
        const sheetSelect = document.getElementById('sheet_name');
        
        if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
            console.warn('‚ö†Ô∏è Fichier non Excel:', file.name);
            alert('Veuillez s√©lectionner un fichier Excel (.xlsx ou .xls)');
            // R√©initialiser le select
            if (sheetSelect) {
                sheetSelect.disabled = true;
                sheetSelect.innerHTML = '<option value="">S√©lectionnez un fichier Excel d\'abord</option>';
            }
            // R√©initialiser l'affichage du fichier
            fileName.textContent = '';
            fileSize.textContent = '';
            fileInfo.classList.remove('active');
            return;
        }
        
        console.log('‚úÖ Fichier Excel valide, mise √† jour de l\'affichage');
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.add('active');
        
        // Analyser les feuilles du fichier Excel (en arri√®re-plan, ne bloque pas)
        try {
            console.log('üìä D√©marrage de l\'analyse des feuilles...');
            analyzeExcelSheets(file);
        } catch (error) {
            console.error('‚ùå Erreur lors de l\'analyse des feuilles:', error);
            // En cas d'erreur, utiliser Feuil1 par d√©faut
            if (sheetSelect) {
                sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par d√©faut)</option>';
                sheetSelect.disabled = false;
            }
        }
    }
    
    function analyzeExcelSheets(file) {
        console.log('üìã analyzeExcelSheets appel√© avec:', file.name);
        const sheetSelect = document.getElementById('sheet_name');
        
        if (!sheetSelect) {
            console.error('‚ùå Select sheet_name introuvable');
            return;
        }
        
        sheetSelect.disabled = true;
        sheetSelect.innerHTML = '<option value="">‚è≥ Analyse des feuilles en cours...</option>';
        
        const formData = new FormData();
        formData.append('excel_file', file);
        
        console.log('üì§ Envoi de la requ√™te pour analyser les feuilles...');
        
        fetch('{% url "scripts_manager:analyze_excel_sheets" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('üì• R√©ponse re√ßue:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('üìä Donn√©es re√ßues:', data);
            if (data.success && data.sheets && data.sheets.length > 0) {
                console.log('‚úÖ Feuilles trouv√©es:', data.sheets);
                sheetSelect.innerHTML = '';
                data.sheets.forEach(sheet => {
                    const option = document.createElement('option');
                    option.value = sheet;
                    option.textContent = sheet;
                    if (sheet === data.default_sheet) {
                        option.selected = true;
                    }
                    sheetSelect.appendChild(option);
                });
                sheetSelect.disabled = false;
                console.log('‚úÖ Select mis √† jour avec', data.sheets.length, 'feuilles');
            } else {
                console.warn('‚ö†Ô∏è Aucune feuille trouv√©e, utilisation de Feuil1 par d√©faut');
                sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par d√©faut)</option>';
                sheetSelect.disabled = false;
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur lors de l\'analyse des feuilles:', error);
            sheetSelect.innerHTML = '<option value="Feuil1" selected>Feuil1 (par d√©faut)</option>';
            sheetSelect.disabled = false;
            // Afficher un message d'avertissement mais permettre quand m√™me l'import
            console.warn('Impossible d\'analyser les feuilles, utilisation de "Feuil1" par d√©faut');
        });
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    importForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!fileInput.files.length) {
            alert('Veuillez s√©lectionner un fichier Excel');
            return;
        }
        
        const sheetSelect = document.getElementById('sheet_name');
        // V√©rifier seulement si le select est activ√© et a des options mais aucune s√©lectionn√©e
        if (!sheetSelect.disabled && sheetSelect.options.length > 1 && !sheetSelect.value) {
            alert('Veuillez s√©lectionner une feuille Excel');
            return;
        }
        
        // Confirmation avec lapin.gif
        const confirmModal = document.createElement('div');
        confirmModal.id = 'confirmModal';
        confirmModal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;';
        confirmModal.innerHTML = `
            <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                <img src="{% static 'loading_gifs/lapin.gif' %}" alt="Lapin" style="max-width: 300px; max-height: 250px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; color: #111111;">‚ö†Ô∏è ATTENTION</h3>
                <p style="margin-bottom: 20px; color: #535353; line-height: 1.6;">
                    Cette op√©ration va remplacer TOUS les restaurants actuels.<br><br>
                    Un backup sera cr√©√© automatiquement.<br><br>
                    Voulez-vous continuer ?
                </p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="confirmYes" style="padding: 12px 30px; background: #60BC81; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Oui, continuer</button>
                    <button id="confirmNo" style="padding: 12px 30px; background: #D3695E; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Annuler</button>
                </div>
            </div>
        `;
        document.body.appendChild(confirmModal);
        
        // Attendre la confirmation
        const confirmed = await new Promise((resolve) => {
            document.getElementById('confirmYes').onclick = () => {
                document.body.removeChild(confirmModal);
                resolve(true);
            };
            document.getElementById('confirmNo').onclick = () => {
                document.body.removeChild(confirmModal);
                resolve(false);
            };
        });
        
        if (!confirmed) {
            return;
        }
        
        const formData = new FormData(importForm);
        // R√©cup√©rer la feuille s√©lectionn√©e, ou utiliser la premi√®re option, ou 'Feuil1' par d√©faut
        // sheetSelect est d√©j√† d√©clar√© plus haut dans la fonction
        let sheetName = 'Feuil1';
        if (sheetSelect && !sheetSelect.disabled && sheetSelect.value) {
            sheetName = sheetSelect.value;
        } else if (sheetSelect && sheetSelect.options.length > 0 && sheetSelect.options[0].value) {
            sheetName = sheetSelect.options[0].value;
        }
        formData.set('sheet_name', sheetName);
        
        // Afficher le loader
        progressContainer.classList.add('active');
        progressFill.style.width = '10%';
        progressText.textContent = 'Upload du fichier...';
        submitBtn.disabled = true;
        resultContainer.style.display = 'none';
        
        // Afficher Laura.gif avec "let me cook"
        document.getElementById('lauraGifContainer').style.display = 'block';
        
        // Afficher le terminal
        document.getElementById('terminalContainer').style.display = 'block';
        const terminalContent = document.getElementById('terminalContent');
        terminalContent.innerHTML = '<span style="color: #4ec9b0;">üöÄ D√©marrage de l\'import...</span>\n';
        
        // Masquer omg.gif si visible
        document.getElementById('omgGifContainer').style.display = 'none';
        
        // Variable pour stocker le chemin du log (sera r√©cup√©r√© apr√®s l'upload)
        let logFilePath = null;
        
        // Simuler la progression (sera remplac√©e par les vrais logs)
        let progress = 10;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 3;
            if (progress > 95) progress = 95; // Ne pas aller √† 100% avant la fin
            progressFill.style.width = progress + '%';
            progressFill.textContent = Math.round(progress) + '%';
        }, 1000);
        
        // Fonction pour r√©cup√©rer et afficher les logs
        let logPollingInterval = null;
        function startLogPolling(logFile) {
            if (logPollingInterval) clearInterval(logPollingInterval);
            
            logPollingInterval = setInterval(() => {
                fetch(`{% url "scripts_manager:get_import_logs" %}?log_file=${encodeURIComponent(logFile)}`)
                    .then(response => response.json())
                    .then(logData => {
                        if (logData.success && logData.logs) {
                            const terminalContent = document.getElementById('terminalContent');
                            // Formater les logs avec des couleurs
                            let formattedLogs = '';
                            logData.logs.split('\n').forEach(line => {
                                if (line.trim()) {
                                    let color = '#d4d4d4';
                                    if (line.includes('‚úÖ')) color = '#4ec9b0';
                                    else if (line.includes('‚ùå') || line.includes('Erreur')) color = '#f48771';
                                    else if (line.includes('‚ö†Ô∏è')) color = '#dcdcaa';
                                    else if (line.includes('üìä') || line.includes('üì•')) color = '#569cd6';
                                    else if (line.includes('üóÑÔ∏è') || line.includes('üîÑ')) color = '#c586c0';
                                    
                                    formattedLogs += `<span style="color: ${color};">${escapeHtml(line)}</span>\n`;
                                }
                            });
                            terminalContent.innerHTML = formattedLogs;
                            // Scroll vers le bas
                            const terminalDiv = terminalContent.parentElement;
                            terminalDiv.scrollTop = terminalDiv.scrollHeight;
                        }
                    })
                    .catch(error => {
                        console.error('Erreur lors de la r√©cup√©ration des logs:', error);
                    });
            }, 1000); // Poll toutes les secondes
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // D√©marrer le polling des logs d√®s que le log_file est disponible
        // On va le d√©marrer apr√®s avoir re√ßu la r√©ponse de l'upload
        
        fetch('{% url "scripts_manager:run_import_restaurants" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            // Si l'import est en cours (status: running), d√©marrer le polling
            if (data.status === 'running' && data.log_file) {
                startLogPolling(data.log_file);
                
                // V√©rifier p√©riodiquement si l'import est termin√©
                const checkCompletion = setInterval(() => {
                    fetch(`{% url "scripts_manager:get_import_logs" %}?log_file=${encodeURIComponent(data.log_file)}`)
                        .then(response => response.json())
                        .then(logData => {
                            if (logData.success && logData.logs) {
                                const terminalContent = document.getElementById('terminalContent');
                                let formattedLogs = '';
                                logData.logs.split('\n').forEach(line => {
                                    if (line.trim()) {
                                        let color = '#d4d4d4';
                                        if (line.includes('‚úÖ')) color = '#4ec9b0';
                                        else if (line.includes('‚ùå') || line.includes('Erreur')) color = '#f48771';
                                        else if (line.includes('‚ö†Ô∏è')) color = '#dcdcaa';
                                        else if (line.includes('üìä') || line.includes('üì•')) color = '#569cd6';
                                        else if (line.includes('üóÑÔ∏è') || line.includes('üîÑ')) color = '#c586c0';
                                        
                                        formattedLogs += `<span style="color: ${color};">${escapeHtml(line)}</span>\n`;
                                    }
                                });
                                terminalContent.innerHTML = formattedLogs;
                                const terminalDiv = terminalContent.parentElement;
                                terminalDiv.scrollTop = terminalDiv.scrollHeight;
                                
                                // V√©rifier si l'import est termin√©
                                if (logData.logs.includes('Fin de workflow') || logData.logs.includes('üéâ')) {
                                    clearInterval(checkCompletion);
                                    if (logPollingInterval) clearInterval(logPollingInterval);
                                    
                                    clearInterval(progressInterval);
                                    progressFill.style.width = '100%';
                                    progressFill.textContent = '100%';
                                    
                                    // Masquer Laura.gif et afficher omg.gif
                                    document.getElementById('lauraGifContainer').style.display = 'none';
                                    document.getElementById('omgGifContainer').style.display = 'block';
                                    
                                    // R√©cup√©rer les r√©sultats finaux depuis le log (parser les derni√®res lignes)
                                    // Pour l'instant, on affiche juste un message de succ√®s
                                    progressText.textContent = 'Import termin√© avec succ√®s !';
                                    resultContainer.className = 'result-container success';
                                    resultContainer.innerHTML = `
                                        <h3>‚úÖ Import termin√© !</h3>
                                        <p>Consultez les logs ci-dessus pour les d√©tails.</p>
                                        <p><strong>Log :</strong> ${data.log_file}</p>
                                    `;
                                    resultContainer.style.display = 'block';
                                    
                                    // R√©initialiser le formulaire apr√®s 5 secondes
                                    setTimeout(() => {
                                        importForm.reset();
                                        fileInfo.classList.remove('active');
                                        progressContainer.classList.remove('active');
                                        submitBtn.disabled = false;
                                        document.getElementById('omgGifContainer').style.display = 'none';
                                    }, 5000);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Erreur lors de la v√©rification des logs:', error);
                        });
                }, 2000); // V√©rifier toutes les 2 secondes
            } else if (data.success) {
                // Import termin√© imm√©diatement (cas peu probable)
                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                progressFill.textContent = '100%';
                
                document.getElementById('lauraGifContainer').style.display = 'none';
                document.getElementById('omgGifContainer').style.display = 'block';
                
                progressText.textContent = 'Import termin√© avec succ√®s !';
                resultContainer.className = 'result-container success';
                
                let favoriteStatsHtml = '';
                if (data.favorite_count_stats) {
                    const favStats = data.favorite_count_stats;
                    if (favStats.updated !== undefined) {
                        favoriteStatsHtml = `
                            <div style="margin-top: 15px; padding: 15px; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin-top: 0; color: #667eea;">‚ù§Ô∏è Compteurs de favoris mis √† jour</h4>
                                <p><strong>${favStats.updated || 0}</strong> restaurants mis √† jour</p>
                                <p><strong>${favStats.zero_initialized || 0}</strong> restaurants initialis√©s √† 0</p>
                                <p><strong>${favStats.active_favorites || 0}</strong> favoris actifs au total</p>
                                ${favStats.errors > 0 ? `<p style="color: #dc3545;">‚ö†Ô∏è ${favStats.errors} erreurs</p>` : ''}
                            </div>
                        `;
                    } else if (favStats.error) {
                        favoriteStatsHtml = `
                            <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <p style="color: #856404;">‚ö†Ô∏è Erreur lors de la mise √† jour des compteurs de favoris: ${favStats.error}</p>
                            </div>
                        `;
                    }
                }
                
                resultContainer.innerHTML = `
                    <h3>‚úÖ Import r√©ussi !</h3>
                    <p><strong>${data.imported}</strong> restaurants import√©s</p>
                    ${data.duplicates > 0 ? `<p>‚ö†Ô∏è ${data.duplicates} IDs dupliqu√©s d√©tect√©s</p>` : ''}
                    ${data.missing_tag_rows > 0 ? `<p>‚ö†Ô∏è ${data.missing_tag_rows} lignes sans tag (Ref)</p>` : ''}
                    <p><strong>Backup :</strong> ${data.backup_dir}</p>
                    <p><strong>Log :</strong> ${data.log_file}</p>
                    ${favoriteStatsHtml}
                `;
                resultContainer.style.display = 'block';
                
                setTimeout(() => {
                    importForm.reset();
                    fileInfo.classList.remove('active');
                    progressContainer.classList.remove('active');
                    submitBtn.disabled = false;
                }, 5000);
            } else {
                clearInterval(progressInterval);
                progressText.textContent = 'Erreur lors de l\'import';
                document.getElementById('lauraGifContainer').style.display = 'none';
                if (logPollingInterval) clearInterval(logPollingInterval);
                resultContainer.className = 'result-container error';
                resultContainer.innerHTML = `
                    <h3>‚ùå Erreur</h3>
                    <p>${data.error || 'Une erreur est survenue lors de l\'import'}</p>
                    ${data.traceback ? `<pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${data.traceback}</pre>` : ''}
                `;
                resultContainer.style.display = 'block';
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            if (logPollingInterval) clearInterval(logPollingInterval);
            // Masquer Laura.gif
            document.getElementById('lauraGifContainer').style.display = 'none';
            progressText.textContent = 'Erreur lors de l\'import';
            resultContainer.className = 'result-container error';
            resultContainer.innerHTML = `
                <h3>‚ùå Erreur</h3>
                <p>Une erreur est survenue : ${error.message}</p>
            `;
            resultContainer.style.display = 'block';
            submitBtn.disabled = false;
        });
    });
    
    // Gestion des backups
    const refreshBackupsBtn = document.getElementById('refreshBackupsBtn');
    const backupsLoading = document.getElementById('backupsLoading');
    const backupsList = document.getElementById('backupsList');
    const backupsTableBody = document.getElementById('backupsTableBody');
    const backupsEmpty = document.getElementById('backupsEmpty');
    const restoreResult = document.getElementById('restoreResult');
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function formatDate(timestamp) {
        if (!timestamp) return 'Date inconnue';
        try {
            // Essayer de parser diff√©rents formats
            const date = new Date(timestamp);
            if (isNaN(date.getTime())) {
                return timestamp; // Retourner tel quel si non parsable
            }
            return date.toLocaleString('fr-FR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return timestamp;
        }
    }
    
    function loadBackups() {
        // V√©rifier que les √©l√©ments existent avant de les utiliser
        if (!backupsLoading || !backupsList || !backupsEmpty || !restoreResult) {
            console.warn('‚ö†Ô∏è √âl√©ments de backup introuvables, fonction loadBackups ignor√©e');
            return;
        }
        
        backupsLoading.style.display = 'block';
        backupsList.style.display = 'none';
        backupsEmpty.style.display = 'none';
        restoreResult.style.display = 'none';
        
        fetch('{% url "scripts_manager:list_backups" %}')
            .then(response => response.json())
            .then(data => {
                if (backupsLoading) {
                    backupsLoading.style.display = 'none';
                }
                
                if (data.success && data.backups && data.backups.length > 0) {
                    if (backupsTableBody) {
                        backupsTableBody.innerHTML = '';
                        
                        data.backups.forEach(backup => {
                            const row = document.createElement('tr');
                            row.style.borderBottom = '1px solid #e9ecef';
                            
                            const dateCell = document.createElement('td');
                            dateCell.style.padding = '12px';
                            dateCell.textContent = formatDate(backup.timestamp);
                            
                            const countCell = document.createElement('td');
                            countCell.style.padding = '12px';
                            countCell.textContent = backup.count || 'N/A';
                            
                            const sizeCell = document.createElement('td');
                            sizeCell.style.padding = '12px';
                            sizeCell.textContent = formatFileSize(backup.size || 0);
                            
                            const actionsCell = document.createElement('td');
                            actionsCell.style.padding = '12px';
                            actionsCell.style.textAlign = 'center';
                            
                            const restoreBtn = document.createElement('button');
                            restoreBtn.className = 'btn';
                            restoreBtn.style.padding = '8px 16px';
                            restoreBtn.style.margin = '0 5px';
                            restoreBtn.textContent = 'üîÑ Restaurer';
                            restoreBtn.onclick = () => restoreBackup(backup.backup_dir, backup.backup_name);
                            
                            actionsCell.appendChild(restoreBtn);
                            
                            row.appendChild(dateCell);
                            row.appendChild(countCell);
                            row.appendChild(sizeCell);
                            row.appendChild(actionsCell);
                            
                            backupsTableBody.appendChild(row);
                        });
                    }
                    
                    if (backupsList) {
                        backupsList.style.display = 'block';
                    }
                } else {
                    if (backupsEmpty) {
                        backupsEmpty.style.display = 'block';
                    }
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement des backups:', error);
                if (backupsLoading) {
                    backupsLoading.style.display = 'none';
                }
                backupsEmpty.style.display = 'block';
                backupsEmpty.innerHTML = `<p style="color: #dc3545;">Erreur lors du chargement: ${error.message}</p>`;
            });
    }
    
    function restoreBackup(backupDir, backupName) {
        if (!confirm(`‚ö†Ô∏è ATTENTION : Cette op√©ration va remplacer TOUS les restaurants actuels par ceux du backup "${backupName}".\n\nUn backup de s√©curit√© sera cr√©√© avant la restauration.\n\nVoulez-vous continuer ?`)) {
            return;
        }
        
        restoreResult.style.display = 'block';
        restoreResult.className = 'result-container';
        restoreResult.innerHTML = '<p>‚è≥ Restauration en cours...</p>';
        
        fetch('{% url "scripts_manager:restore_backup" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                backup_dir: backupDir,
                create_backup_before: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                restoreResult.className = 'result-container success';
                restoreResult.innerHTML = `
                    <h3>‚úÖ Restauration r√©ussie !</h3>
                    <p><strong>${data.imported}</strong> restaurants restaur√©s</p>
                    <p><strong>Backup restaur√© :</strong> ${data.backup_dir}</p>
                    ${data.backup_before_dir ? `<p><strong>Backup de s√©curit√© :</strong> ${data.backup_before_dir}</p>` : ''}
                `;
            } else {
                restoreResult.className = 'result-container error';
                restoreResult.innerHTML = `
                    <h3>‚ùå Erreur</h3>
                    <p>${data.error || 'Une erreur est survenue lors de la restauration'}</p>
                    ${data.traceback ? `<pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px;">${data.traceback}</pre>` : ''}
                `;
            }
        })
        .catch(error => {
            restoreResult.className = 'result-container error';
            restoreResult.innerHTML = `
                <h3>‚ùå Erreur</h3>
                <p>Une erreur est survenue : ${error.message}</p>
            `;
        });
    }
    
    if (refreshBackupsBtn) {
        refreshBackupsBtn.addEventListener('click', loadBackups);
        
        // Charger les backups au chargement de la page
        loadBackups();
    } else {
        console.log('‚ÑπÔ∏è Section backups non disponible sur cette page');
    }
    
    // Fonctions d'analyse (disponibles en DEV et PROD)
    function devFunction1() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un fichier Excel');
            return;
        }
        
        const devResult = document.getElementById('devResult');
        devResult.style.display = 'block';
        devResult.innerHTML = '<p>‚è≥ Analyse du fichier en cours...</p>';
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'analyze');
        
        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                devResult.innerHTML = `
                    <h4>‚úÖ Analyse termin√©e</h4>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${JSON.stringify(data.result, null, 2)}</pre>
                `;
            } else {
                devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${error.message}</p>`;
        });
    }
    
    function devFunction2() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un fichier Excel');
            return;
        }
        
        const devResult = document.getElementById('devResult');
        devResult.style.display = 'block';
        devResult.innerHTML = '<p>‚è≥ Pr√©visualisation en cours...</p>';
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'preview');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);
        
        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let previewHtml = '<h4>üìä Pr√©visualisation des donn√©es (10 premi√®res lignes)</h4>';
                if (data.preview && data.preview.length > 0) {
                    previewHtml += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    // En-t√™tes
                    previewHtml += '<tr style="background: #f8f9fa;">';
                    Object.keys(data.preview[0]).forEach(key => {
                        previewHtml += `<th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">${key}</th>`;
                    });
                    previewHtml += '</tr>';
                    // Donn√©es
                    data.preview.slice(0, 10).forEach(row => {
                        previewHtml += '<tr>';
                        Object.values(row).forEach(val => {
                            previewHtml += `<td style="padding: 8px; border: 1px solid #dee2e6;">${val || ''}</td>`;
                        });
                        previewHtml += '</tr>';
                    });
                    previewHtml += '</table>';
                    previewHtml += `<p style="margin-top: 10px; color: #6c757d;">Total: ${data.total || 0} lignes</p>`;
                } else {
                    previewHtml += '<p>Aucune donn√©e trouv√©e</p>';
                }
                devResult.innerHTML = previewHtml;
            } else {
                devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${error.message}</p>`;
        });
    }
    
    function devFunction3() {
        if (!confirm('üß™ Cette fonction va importer uniquement les 5 premiers restaurants pour tester. Continuer ?')) {
            return;
        }
        
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un fichier Excel');
            return;
        }
        
        const devResult = document.getElementById('devResult');
        devResult.style.display = 'block';
        devResult.innerHTML = '<p>‚è≥ Test d\'import partiel en cours...</p>';
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'test_import');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);
        formData.append('limit', '5');
        
        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                devResult.innerHTML = `
                    <h4>‚úÖ Test d'import termin√©</h4>
                    <p>${data.imported || 0} restaurant(s) import√©(s) pour le test</p>
                    <pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px;">${JSON.stringify(data.result, null, 2)}</pre>
                `;
            } else {
                devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${error.message}</p>`;
        });
    }
    
    function devFunction4() {
        const fileInput = document.getElementById('excel_file');
        if (!fileInput.files.length) {
            alert('‚ö†Ô∏è Veuillez d\'abord s√©lectionner un fichier Excel');
            return;
        }
        
        const devResult = document.getElementById('devResult');
        devResult.style.display = 'block';
        devResult.innerHTML = '<p>‚è≥ Validation des donn√©es en cours...</p>';
        
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('action', 'validate');
        const sheetName = document.getElementById('sheet_name').value || 'Feuil1';
        formData.append('sheet_name', sheetName);
        
        fetch('{% url "scripts_manager:dev_import_function" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let validationHtml = '<h4>‚úÖ Validation termin√©e</h4>';
                if (data.validation) {
                    validationHtml += `<p><strong>Total lignes:</strong> ${data.validation.total || 0}</p>`;
                    validationHtml += `<p><strong>Lignes valides:</strong> ${data.validation.valid || 0}</p>`;
                    validationHtml += `<p><strong>Erreurs:</strong> ${data.validation.errors || 0}</p>`;
                    if (data.validation.error_details && data.validation.error_details.length > 0) {
                        validationHtml += '<h5>D√©tails des erreurs:</h5><ul>';
                        data.validation.error_details.slice(0, 10).forEach(err => {
                            validationHtml += `<li>${err}</li>`;
                        });
                        validationHtml += '</ul>';
                    }
                }
                devResult.innerHTML = validationHtml;
            } else {
                devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${data.error}</p>`;
            }
        })
        .catch(error => {
            devResult.innerHTML = `<p style="color: #dc3545;">‚ùå Erreur: ${error.message}</p>`;
        });
    }
});
</script>
{% endblock %}

